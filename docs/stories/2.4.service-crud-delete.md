# Story 2.4: Service CRUD - Delete Service with Protection

## Status

Draft

## Story

**As a** manager,
**I want** to delete a service from the catalog, but be prevented if service logs exist,
**so that** I don't accidentally break historical data integrity.

## Acceptance Criteria

1. Dropdown menu on each service card includes "Delete" option
2. Clicking "Delete" triggers referential integrity check: Query `serviceLogs` collection for documents with `serviceId` matching this service
3. **If service logs exist:** "Delete" option disabled in dropdown menu or grayed out, tooltip shown: "Cannot delete - service has associated logs"
4. **If no service logs exist:** Clicking "Delete" shows confirmation dialog: "Are you sure you want to delete '[service name]'? This action cannot be undone."
5. Confirmation dialog has "Cancel" (secondary) and "Delete" (destructive red) buttons
6. Clicking "Delete" in confirmation: Service document deleted from Firestore
7. Toast notification: "Service '[name]' deleted successfully"
8. Service disappears from grid immediately
9. Keyboard navigation: Esc closes confirmation dialog without deleting
10. Error handling: If delete fails, show toast error: "Failed to delete service. Please try again."

## Tasks / Subtasks

- [ ] Implement referential integrity check (AC: 2, 3)
  - [ ] Create `checkServiceHasLogs()` function in `lib/services/service-management.ts`
  - [ ] Query `serviceLogs` collection for documents where `serviceId` matches
  - [ ] Return boolean indicating if logs exist
  - [ ] Integrate check into service card component
- [ ] Handle delete option UI states (AC: 1, 3, 4)
  - [ ] Check if service has logs when rendering dropdown menu
  - [ ] If logs exist: Disable/gray out "Delete" option, add tooltip
  - [ ] If no logs: Enable "Delete" option, show confirmation dialog on click
  - [ ] Tooltip text: "Cannot delete - service has associated logs"
- [ ] Implement confirmation dialog (AC: 4, 5)
  - [ ] Create `ConfirmDialog.tsx` component in `components/features/common/`
  - [ ] Use ShadCN AlertDialog component
  - [ ] Show message: "Are you sure you want to delete '[service name]'? This action cannot be undone."
  - [ ] Add "Cancel" (secondary) and "Delete" (destructive red) buttons
- [ ] Implement Firestore delete operation (AC: 6)
  - [ ] Create `deleteService()` function in `lib/firebase/repositories/service-repository.ts`
  - [ ] Delete service document from Firestore
  - [ ] Implement React Query mutation with optimistic update
- [ ] Add user feedback and error handling (AC: 7, 8, 10)
  - [ ] Show Sonner toast: "Service '[name]' deleted successfully"
  - [ ] Ensure service disappears from grid immediately
  - [ ] On error: Show toast: "Failed to delete service. Please try again."
- [ ] Implement keyboard navigation (AC: 9)
  - [ ] Ensure Esc key closes confirmation dialog without deleting
  - [ ] Configure ShadCN AlertDialog to handle keyboard events

## Dev Notes

### Referential Integrity Check

[Source: Epic 2 AC: 2]

Query serviceLogs collection to check if service is in use:

```typescript
import { collection, query, where, getDocs, limit } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export async function checkServiceHasLogs(serviceId: string): Promise<boolean> {
  const q = query(
    collection(db, 'serviceLogs'),
    where('serviceId', '==', serviceId),
    limit(1) // Only need to check if any exist
  )

  const snapshot = await getDocs(q)
  return !snapshot.empty
}
```

### Conditional Delete Menu Item

[Source: Epic 2 AC: 3, 4]

Check referential integrity before allowing delete:

```tsx
import { useState, useEffect } from 'react'
import { DropdownMenuItem } from '@/components/ui/dropdown-menu'
import {
  Tooltip,
  TooltipContent,
  TooltipTrigger,
} from '@/components/ui/tooltip'

function ServiceCard({ service }: { service: Service }) {
  const [hasLogs, setHasLogs] = useState(false)
  const [checkingLogs, setCheckingLogs] = useState(true)

  useEffect(() => {
    checkServiceHasLogs(service.id).then((result) => {
      setHasLogs(result)
      setCheckingLogs(false)
    })
  }, [service.id])

  const handleDeleteClick = () => {
    if (!hasLogs) {
      setShowConfirmDialog(true)
    }
  }

  return (
    <DropdownMenu>
      <DropdownMenuContent>
        <DropdownMenuItem onClick={() => handleEdit(service)}>
          Edit
        </DropdownMenuItem>
        {hasLogs ? (
          <Tooltip>
            <TooltipTrigger asChild>
              <DropdownMenuItem disabled className="text-gray-500">
                Delete
              </DropdownMenuItem>
            </TooltipTrigger>
            <TooltipContent>
              Cannot delete - service has associated logs
            </TooltipContent>
          </Tooltip>
        ) : (
          <DropdownMenuItem
            onClick={handleDeleteClick}
            className="text-red-600"
          >
            Delete
          </DropdownMenuItem>
        )}
      </DropdownMenuContent>
    </DropdownMenu>
  )
}
```

### Confirmation Dialog Component

[Source: Epic 2 AC: 4, 5, 9]

Reusable confirmation dialog with destructive action:

```tsx
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'

interface ConfirmDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  title: string
  description: string
  onConfirm: () => void
  confirmText?: string
  cancelText?: string
}

export function ConfirmDialog({
  open,
  onOpenChange,
  title,
  description,
  onConfirm,
  confirmText = 'Delete',
  cancelText = 'Cancel',
}: ConfirmDialogProps) {
  return (
    <AlertDialog open={open} onOpenChange={onOpenChange}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>{title}</AlertDialogTitle>
          <AlertDialogDescription>{description}</AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>{cancelText}</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            className="bg-red-600 hover:bg-red-700"
          >
            {confirmText}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  )
}
```

### Delete Repository Function

[Source: architecture.md#Components - Repository Pattern]

Delete service from Firestore:

```typescript
import { doc, deleteDoc } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export async function deleteService(id: string): Promise<void> {
  const serviceRef = doc(db, 'services', id)
  await deleteDoc(serviceRef)
}
```

### React Query Delete Mutation

[Source: architecture.md#Architectural Patterns - Optimistic UI Updates]

Implement delete with optimistic update:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'

const queryClient = useQueryClient()
const deleteServiceMutation = useMutation({
  mutationFn: deleteService,
  onMutate: async (serviceId) => {
    // Cancel queries
    await queryClient.cancelQueries(['services'])

    // Snapshot previous value
    const previous = queryClient.getQueryData<Service[]>(['services'])

    // Optimistically remove from list
    queryClient.setQueryData<Service[]>(['services'], (old) =>
      old?.filter((service) => service.id !== serviceId)
    )

    return { previous }
  },
  onError: (err, serviceId, context) => {
    // Rollback on error
    if (context?.previous) {
      queryClient.setQueryData(['services'], context.previous)
    }
    toast.error('Failed to delete service. Please try again.')
  },
  onSuccess: (_, serviceId) => {
    toast.success('Service deleted successfully')
  },
  onSettled: () => {
    queryClient.invalidateQueries(['services'])
  },
})
```

### Error Handling

[Source: architecture.md#Error Handling Strategy]

Implement comprehensive error handling:

```typescript
async function handleDeleteService(serviceId: string, serviceName: string) {
  try {
    // Check for logs first
    const hasLogs = await checkServiceHasLogs(serviceId)
    if (hasLogs) {
      toast.error('Cannot delete - service has associated logs')
      return
    }

    // Show confirmation
    setConfirmDialogOpen(true)
  } catch (error) {
    console.error('Error checking service logs:', error)
    toast.error('Failed to delete service. Please try again.')
    // Log to Sentry in production
    if (process.env.NODE_ENV === 'production') {
      Sentry.captureException(error)
    }
  }
}
```

### Component Structure

[Source: architecture.md#Unified Project Structure]

File locations:

- Card component: `components/features/services/ServiceCard.tsx` (updated)
- Confirm dialog: `components/features/common/ConfirmDialog.tsx`
- Repository: `lib/firebase/repositories/service-repository.ts` (add deleteService)
- Service layer: `lib/services/service-management.ts` (add checkServiceHasLogs)

### Testing

#### Unit Tests

[Source: architecture.md#Testing Strategy]

**Service Management Test** (`tests/unit/services/service-management.test.ts`):

- Mock Firestore `getDocs` function
- Test checkServiceHasLogs returns true when logs exist
- Test checkServiceHasLogs returns false when no logs exist
- Test checkServiceHasLogs handles query errors

**Repository Test** (`tests/unit/repositories/service-repository.test.ts`):

- Mock Firestore `deleteDoc` function
- Test deleteService deletes document by ID
- Test deleteService throws error on Firestore failure

#### Component Tests

[Source: architecture.md#Testing Strategy]

**ServiceCard Delete Test** (`tests/component/services/ServiceCard.test.tsx`):

- Test "Delete" option enabled when service has no logs
- Test "Delete" option disabled when service has logs
- Test tooltip shows on disabled delete option
- Test clicking "Delete" opens confirmation dialog
- Test confirmation dialog shows correct service name
- Test clicking "Cancel" closes dialog without deleting
- Test clicking "Delete" in confirmation calls mutation
- Test toast notification on successful delete
- Test toast error notification on failed delete

**ConfirmDialog Test** (`tests/component/common/ConfirmDialog.test.tsx`):

- Test dialog renders with provided title and description
- Test dialog contains Cancel and Delete buttons
- Test clicking Cancel closes dialog and doesn't call onConfirm
- Test clicking Delete calls onConfirm callback
- Test Esc key closes dialog without calling onConfirm
- Test Delete button has destructive styling (red)

#### E2E Tests

[Source: architecture.md#Testing Strategy]

**Service Delete E2E** (`tests/e2e/service-management.spec.ts`):

- Test manager creates service and successfully deletes it
- Test delete option disabled for service with existing logs
- Test tooltip appears on disabled delete option
- Test confirmation dialog shows when deleting
- Test service deleted from database after confirmation
- Test toast notification appears
- Test deleted service disappears from grid immediately
- Test Esc key closes confirmation dialog
- Test Cancel button in confirmation dialog
- Test error toast when delete fails

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
