# Story 3.4: Barber Daily Stats Display

## Status

Draft

## Story

**As a** barber,
**I want** to see my daily service count and revenue at the top of my dashboard,
**so that** I can track my daily productivity and earnings.

## Acceptance Criteria

1. Two KPI cards displayed at top of barber dashboard: "Services Today" and "Revenue Today"
2. Services Today: Count of service logs where barberId = current user, status = 'approved', createdAt is today (local timezone)
3. Revenue Today: Sum of `commissionAmount` for approved service logs created today
4. Values formatted: Services as integer (e.g., "5"), Revenue as currency ($XXX.XX)
5. Real-time updates: When manager approves a service, stats update instantly
6. Stats reset at midnight local time
7. If no approved services today: Shows "0" and "$0.00" (not "No data" or empty)
8. Cards styled: Dark theme (#1a1a1a background), large numbers (24px+), descriptive labels
9. Skeleton loading state on initial page load
10. Query optimized: Use Firestore index (barberId + status + createdAt) to avoid full collection scan

## Tasks / Subtasks

- [ ] Create KPICard component (AC: 1, 8)
  - [ ] Build KPICard component in `components/features/dashboard/KPICard.tsx`
  - [ ] Accept props: title, value, loading
  - [ ] Use dark theme styling (#1a1a1a background)
  - [ ] Large number display (24px+ font size)
  - [ ] Descriptive label beneath number
  - [ ] Use ShadCN Card component
- [ ] Create DailyStats component (AC: 1, 2, 3)
  - [ ] Build DailyStats component in `components/features/dashboard/DailyStats.tsx`
  - [ ] Display two KPICards: "Services Today" and "Revenue Today"
  - [ ] Query service logs where barberId = current user, status = 'approved', createdAt is today
  - [ ] Calculate count of approved logs for "Services Today"
  - [ ] Calculate sum of commissionAmount for "Revenue Today"
- [ ] Implement real-time daily stats query (AC: 5)
  - [ ] Create useDailyStats hook in `hooks/useDailyStats.ts`
  - [ ] Query serviceLogs with filters: barberId, status='approved', createdAt >= startOfToday
  - [ ] Use onSnapshot listener wrapped in React Query
  - [ ] Apply Firestore composite index: barberId (ASC), status (ASC), createdAt (DESC)
- [ ] Add date filtering for "today" (AC: 2, 6)
  - [ ] Use date-fns to get start of today in local timezone
  - [ ] Filter Firestore query: where('createdAt', '>=', startOfToday())
  - [ ] Ensure stats reset at midnight local time
- [ ] Implement value formatting (AC: 4, 7)
  - [ ] Format services count as integer: "5"
  - [ ] Format revenue as currency: "$XXX.XX" using formatCurrency utility
  - [ ] Show "0" and "$0.00" when no approved services today (not empty state)
- [ ] Add skeleton loading state (AC: 9)
  - [ ] Create SkeletonKPICard component or use ShadCN Skeleton
  - [ ] Display skeleton while data is loading
  - [ ] Match card dimensions and layout
- [ ] Optimize Firestore query (AC: 10)
  - [ ] Add composite index to firestore.indexes.json
  - [ ] Index fields: barberId (ASC), status (ASC), createdAt (DESC)
  - [ ] Verify query uses index (check Firestore console)
  - [ ] Avoid full collection scan
- [ ] Integrate into Barber Dashboard (AC: 1)
  - [ ] Add DailyStats component at top of barber dashboard page
  - [ ] Pass current user's barberId to component
  - [ ] Position above "Log a Service" section

## Dev Notes

### Daily Stats Query

[Source: architecture.md#Reporting & Analytics Service]

Real-time query for barber's daily stats:

```typescript
// hooks/useDailyStats.ts
import { useRealtimeQuery } from '@/hooks/useRealtimeQuery'
import {
  collection,
  query,
  where,
  orderBy,
  Timestamp,
} from 'firebase/firestore'
import { db } from '@/lib/firebase/config'
import { startOfDay } from 'date-fns'

export function useDailyStats(barberId: string) {
  const startOfToday = Timestamp.fromDate(startOfDay(new Date()))

  return useRealtimeQuery<ServiceLog>(
    ['serviceLogs', 'daily', barberId],
    query(
      collection(db, 'serviceLogs'),
      where('barberId', '==', barberId),
      where('status', '==', 'approved'),
      where('createdAt', '>=', startOfToday),
      orderBy('createdAt', 'desc')
    )
  )
}
```

**Firestore Index Required:**

- Collection: `serviceLogs`
- Fields: `barberId` (ASC), `status` (ASC), `createdAt` (DESC)
- Add to `firestore.indexes.json`

### Stats Calculation

[Source: architecture.md#Reporting & Analytics Service]

Calculate stats from approved logs:

```typescript
// components/features/dashboard/DailyStats.tsx
import { useDailyStats } from '@/hooks/useDailyStats';
import { KPICard } from './KPICard';

export function DailyStats({ barberId }: { barberId: string }) {
  const { data: logs, isLoading } = useDailyStats(barberId);

  const servicesCount = logs?.length || 0;
  const totalRevenue = logs?.reduce((sum, log) => sum + log.commissionAmount, 0) || 0;

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      <KPICard
        title="Services Today"
        value={servicesCount.toString()}
        loading={isLoading}
      />
      <KPICard
        title="Revenue Today"
        value={formatCurrency(totalRevenue)}
        loading={isLoading}
      />
    </div>
  );
}
```

### KPICard Component

[Source: architecture.md#Component Template]

```typescript
// components/features/dashboard/KPICard.tsx
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';

interface KPICardProps {
  title: string;
  value: string;
  loading?: boolean;
}

export function KPICard({ title, value, loading = false }: KPICardProps) {
  return (
    <Card className="bg-[#1a1a1a] border-none">
      <CardHeader>
        <CardTitle className="text-sm font-medium text-muted-foreground">
          {title}
        </CardTitle>
      </CardHeader>
      <CardContent>
        {loading ? (
          <Skeleton className="h-10 w-24" />
        ) : (
          <p className="text-3xl font-bold">{value}</p>
        )}
      </CardContent>
    </Card>
  );
}
```

### Date Filtering

[Source: architecture.md#Coding Standards]

Use date-fns for date operations:

```typescript
import { startOfDay } from 'date-fns'
import { Timestamp } from 'firebase/firestore'

// Get start of today in local timezone
const startOfToday = Timestamp.fromDate(startOfDay(new Date()))

// Firestore query
where('createdAt', '>=', startOfToday)
```

Stats automatically reset at midnight because query filters by `createdAt >= startOfToday`. When date changes, `startOfDay(new Date())` returns new date, query results update.

### Real-time Updates

[Source: architecture.md#Real-time Sync Engine]

Stats update in real-time when:

- Manager approves a service log (status changes to 'approved')
- Barber logs services (once approved, stats increment)
- No manual refresh required (onSnapshot listener)

Target latency: <2 seconds for approval to reflect in daily stats.

### Value Formatting

[Source: architecture.md#Coding Standards]

**Services Count:**

```typescript
const servicesCount = logs?.length || 0
const formattedCount = servicesCount.toString() // "5" or "0"
```

**Revenue:**

```typescript
const totalRevenue =
  logs?.reduce((sum, log) => sum + log.commissionAmount, 0) || 0
const formattedRevenue = formatCurrency(totalRevenue) // "$125.50" or "$0.00"
```

### Empty State Handling

[Source: Epic Requirements]

Per AC 7: Show "0" and "$0.00" when no approved services today (not "No data" or empty state).

```typescript
// Always show values, even if 0
<KPICard title="Services Today" value={servicesCount.toString()} />
<KPICard title="Revenue Today" value={formatCurrency(totalRevenue)} />
```

### Query Optimization

[Source: architecture.md#Database Schema]

Composite index required for efficient query:

```json
// firestore.indexes.json
{
  "indexes": [
    {
      "collectionGroup": "serviceLogs",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "barberId", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ]
}
```

Without index, Firestore performs full collection scan (slow, expensive).

### Skeleton Loading State

[Source: architecture.md#Technology Stack]

Use ShadCN Skeleton component:

```typescript
import { Skeleton } from '@/components/ui/skeleton';

{loading ? (
  <Skeleton className="h-10 w-24" />
) : (
  <p className="text-3xl font-bold">{value}</p>
)}
```

### Dashboard Layout

[Source: architecture.md#Routing Architecture]

Barber dashboard page structure:

```tsx
// app/(auth)/barber/dashboard/page.tsx
export default function BarberDashboard() {
  const { user } = useAuthStore()

  return (
    <div className="container mx-auto p-6">
      {/* Daily Stats at top */}
      <DailyStats barberId={user.id} />

      {/* Log a Service section */}
      <div className="mt-8">
        <h2>Log a Service</h2>
        <ServiceGrid />
      </div>

      {/* My Logged Services table */}
      <div className="mt-8">
        <h2>My Logged Services</h2>
        <ServiceLogTable barberId={user.id} />
      </div>
    </div>
  )
}
```

### Testing

[Source: architecture.md#Testing Strategy]

**Unit Tests (Vitest):**

- Test stats calculation: count of logs
- Test revenue calculation: sum of commissionAmount
- Test date filtering: only includes logs from today
- Test handles empty logs array (returns 0 and $0.00)

**Component Tests (React Testing Library):**

- Test KPICard displays title and value
- Test skeleton loading state appears when loading
- Test DailyStats renders two KPICards
- Test values format correctly (integer for count, currency for revenue)
- Test shows "0" and "$0.00" when no approved services

**E2E Tests (Playwright):**

- Test barber dashboard shows daily stats at top
- Test stats display "0" and "$0.00" on initial load (no services)
- Test barber logs services, stats remain "0" (pending approval)
- Test manager approves services, barber's stats update in real-time
- Test stats show correct count and revenue after approval
- Test stats reset at midnight (time-based test or mock date)

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
