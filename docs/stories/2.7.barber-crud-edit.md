# Story 2.7: Barber CRUD - Edit Barber Profile

## Status

Draft

## Story

**As a** manager,
**I want** to edit a barber's details including their commission rate,
**so that** I can update information or adjust commission percentages.

## Acceptance Criteria

1. Clicking "Edit" in barber card dropdown opens modal dialog
2. Dialog form pre-filled with current barber data: username, avatarUrl, commissionRate
3. All fields editable except username (username field disabled/read-only to avoid complications)
4. Commission rate validation: 0-100, positive number
5. On submit: User document updated in Firestore with new values
6. If commission rate changed: Toast notification includes note "New rate applies to future services only"
7. Existing service logs retain their original commission rate (historical accuracy)
8. Dialog closes, barber card reflects changes immediately
9. Cancel button closes dialog without saving
10. Error handling: Failed update shows toast error

## Tasks / Subtasks

- [ ] Create EditBarberDialog component (AC: 1, 2)
  - [ ] Create components/features/barbers/EditBarberDialog.tsx
  - [ ] Use ShadCN Dialog component (max-width 600px, centered)
  - [ ] Add dialog trigger mechanism (controlled by parent state)
  - [ ] Set dialog title to "Edit Barber"
- [ ] Build edit barber form (AC: 2, 3, 4)
  - [ ] Use React Hook Form with useForm hook
  - [ ] Create form fields: Username (disabled/read-only), Avatar URL, Commission Rate
  - [ ] Set defaultValues from current barber data prop
  - [ ] Make username field visually disabled (gray background, disabled attribute)
  - [ ] Add number input for commission rate with "%" suffix
  - [ ] Add text input for avatar URL (optional)
- [ ] Implement form validation (AC: 4)
  - [ ] Create Zod schema for edit barber validation
  - [ ] Commission rate: z.number().min(0).max(100)
  - [ ] Avatar URL: z.string().url().optional().or(z.literal(''))
  - [ ] Integrate schema with React Hook Form using zodResolver
  - [ ] Display inline validation errors below fields
  - [ ] Apply red border (#ef4444) to fields with errors
- [ ] Implement form submission (AC: 5, 6, 7)
  - [ ] Create updateBarber mutation using React Query useMutation
  - [ ] Call Firestore updateDoc on users collection with barber ID
  - [ ] Convert commission rate from percentage to decimal (45 → 0.45)
  - [ ] Check if commission rate changed from original value
  - [ ] If changed, show toast: "Barber '[username]' updated. New rate applies to future services only"
  - [ ] If unchanged, show standard toast: "Barber '[username]' updated successfully"
  - [ ] Implement optimistic update in React Query cache
- [ ] Handle dialog lifecycle (AC: 8, 9)
  - [ ] Implement onSuccess callback to close dialog after successful update
  - [ ] Real-time update: barber card reflects changes immediately via Firestore listener
  - [ ] Add "Cancel" button that closes dialog without saving
  - [ ] Reset form state when dialog closes without saving
  - [ ] Handle Escape key to close dialog
- [ ] Error handling (AC: 10)
  - [ ] Wrap updateDoc in try/catch
  - [ ] On error, show toast notification: "Failed to update barber. Please try again."
  - [ ] Log error to console for debugging
  - [ ] Keep dialog open on error so user can retry
  - [ ] Implement rollback on mutation failure (revert optimistic update)

## Dev Notes

### Data Model Reference

[Source: architecture.md#Data Models - User Profile]

Barber profile fields:

```typescript
interface UserProfile {
  id: string // Firebase Auth UID (read-only, not editable)
  username: string // Read-only in edit form to avoid complications
  role: 'manager' | 'barber' // Not editable
  avatarUrl: string | null // Editable
  commissionRate: number // Editable (0.0 - 1.0, displayed as 0-100%)
  createdAt: Firestore.Timestamp // Not editable
}
```

**Editable fields:** avatarUrl, commissionRate
**Read-only fields:** username (to avoid auth complications)

### Form Validation Schema

[Source: architecture.md#Coding Standards - Form Validation]

Create Zod schema in `lib/validations/schemas.ts`:

```typescript
export const editBarberSchema = z.object({
  username: z.string(), // Present but disabled in form
  avatarUrl: z.string().url('Must be a valid URL').optional().or(z.literal('')),
  commissionRate: z
    .number()
    .min(0, 'Commission rate must be at least 0%')
    .max(100, 'Commission rate cannot exceed 100%'),
})

export type EditBarberFormData = z.infer<typeof editBarberSchema>
```

### Update Service Function

[Source: architecture.md#Components - Barber Management Service]

Create update function in `lib/services/barber-management.ts`:

```typescript
import { doc, updateDoc } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export async function updateBarber(
  barberId: string,
  data: { avatarUrl?: string | null; commissionRate?: number }
) {
  const barberRef = doc(db, 'users', barberId)

  // Convert percentage to decimal
  const updateData: any = {}
  if (data.avatarUrl !== undefined) {
    updateData.avatarUrl = data.avatarUrl || null
  }
  if (data.commissionRate !== undefined) {
    updateData.commissionRate = data.commissionRate / 100 // 45% → 0.45
  }

  await updateDoc(barberRef, updateData)
}
```

### React Query Mutation Pattern

[Source: architecture.md#Architectural Patterns - Optimistic UI Updates]

Implement with optimistic update:

```typescript
const { mutate: updateBarberMutation } = useMutation({
  mutationFn: (data: { id: string; values: EditBarberFormData }) =>
    updateBarber(data.id, data.values),
  onMutate: async (data) => {
    await queryClient.cancelQueries({ queryKey: ['barbers'] })
    const previousBarbers = queryClient.getQueryData(['barbers'])

    // Optimistically update cache
    queryClient.setQueryData(['barbers'], (old: UserProfile[]) =>
      old.map((b) => (b.id === data.id ? { ...b, ...data.values } : b))
    )

    return { previousBarbers }
  },
  onError: (err, data, context) => {
    // Rollback on error
    queryClient.setQueryData(['barbers'], context.previousBarbers)
    toast.error('Failed to update barber. Please try again.')
  },
  onSuccess: (_, data) => {
    toast.success(`Barber '${data.values.username}' updated successfully`)
  },
})
```

### Historical Data Integrity

[Source: architecture.md#Data Models - ServiceLog]

**Important:** When commission rate is updated, existing service logs retain their original commission rate snapshot. The new rate only applies to future service logs. This is enforced by the ServiceLog data model which stores `commissionRate` as a snapshot at logging time.

No additional code needed for this - it's automatically maintained by the data model design.

### Project Structure

[Source: architecture.md#Unified Project Structure]

**Files to create/modify:**

- `components/features/barbers/EditBarberDialog.tsx` - Edit dialog component
- `lib/services/barber-management.ts` - Update service function (add updateBarber)
- `lib/validations/schemas.ts` - Add editBarberSchema

### ShadCN Components Required

[Source: architecture.md#Tech Stack - ShadCN UI]

- Dialog (dialog trigger, content, header, footer)
- Form (form field wrapper with labels)
- Input (text input for avatar URL)
- Button (submit, cancel)
- Label (form field labels)

### Testing

#### Component Tests

[Source: architecture.md#Testing Strategy - Component Tests]

**Tests Required:**

1. `tests/component/barbers/EditBarberDialog.test.tsx`
   - Dialog opens when triggered
   - Form pre-fills with current barber data
   - Username field is disabled (cannot be edited)
   - Avatar URL field accepts valid URLs
   - Commission rate field validates 0-100 range
   - Shows error for commission rate < 0
   - Shows error for commission rate > 100
   - Shows error for invalid avatar URL format
   - Submit button triggers updateBarber with correct data
   - Commission rate converts from percentage to decimal (45 → 0.45)
   - Cancel button closes dialog without calling updateBarber
   - Dialog closes on successful update
   - Shows success toast with appropriate message
   - Shows different toast message when commission rate changed
   - Dialog stays open and shows error toast on failure
   - Escape key closes dialog

#### Integration Tests

[Source: architecture.md#Testing Strategy - Integration Tests]

**Test with mocked Firestore:**

1. `tests/integration/barbers/edit-barber.test.tsx`
   - Mock updateDoc from Firestore
   - Fill form with new values and submit
   - Verify updateDoc called with correct arguments
   - Verify commission rate converted to decimal
   - Verify optimistic update applied to React Query cache
   - Simulate update failure and verify rollback
   - Verify real-time listener updates barber card after save

#### E2E Tests

[Source: architecture.md#Testing Strategy - E2E Tests]

**Playwright test:**

1. `tests/e2e/barber-management.spec.ts` (add to existing file)
   - Manager clicks Edit in barber dropdown
   - Edit dialog opens with pre-filled data
   - Changes commission rate from 45% to 50%
   - Clicks Save
   - Dialog closes
   - Toast notification appears with success message
   - Barber card updates to show 50% commission rate
   - Create new service log and verify new rate used (50%)
   - Verify old service logs still show 45% rate (historical accuracy)

#### Unit Tests

[Source: architecture.md#Testing Strategy - Frontend Unit Tests]

**Service function tests:**

1. `tests/unit/services/barber-management.test.ts`
   - updateBarber() calls updateDoc with correct document reference
   - updateBarber() converts commission rate percentage to decimal
   - updateBarber() handles null avatarUrl correctly
   - updateBarber() handles empty string avatarUrl (converts to null)
   - updateBarber() throws error when update fails

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
