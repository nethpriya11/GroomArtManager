# Story 3.9: Manager Log Service on Behalf of Barber

## Status

Draft

## Story

**As a** manager,
**I want** to log a service on behalf of any barber with auto-approval,
**so that** I can correct missed entries or manually add services.

## Acceptance Criteria

1. Manager dashboard includes "Log a Service" section with dropdowns: "Select Barber" and "Select Service"
2. Barber dropdown populated with all active barbers (from `users` collection, role: 'barber')
3. Service dropdown populated with all services (from `services` collection)
4. "Log Service" button enabled only when both barber and service selected
5. Clicking "Log Service" creates service log with: barberId (selected barber), serviceId (selected service), price (from service), commissionRate (from barber), commissionAmount (calculated), status: 'approved', createdAt: timestamp, approvedAt: timestamp
6. Status is 'approved' (bypasses pending queue since manager is trusted)
7. Toast notification: "Service logged for [barber name]"
8. Dropdowns reset to placeholder values after successful submission
9. Real-time: Barber's dashboard updates instantly (new approved log appears, daily stats increase)
10. Manager-logged services indistinguishable from manager-approved barber-logged services in reporting

## Tasks / Subtasks

- [ ] Create ManagerServiceLogForm component (AC: 1, 2, 3, 4)
  - [ ] Add "Log a Service" section to manager dashboard
  - [ ] Implement "Select Barber" dropdown with useBarbers() hook
  - [ ] Implement "Select Service" dropdown with useServices() hook
  - [ ] Filter barbers where role='barber' for dropdown population
  - [ ] Enable/disable "Log Service" button based on selection state
  - [ ] Use ShadCN Select component for dropdowns
- [ ] Implement logServiceForBarber service function (AC: 5, 6, 10)
  - [ ] Create function in lib/services/service-logging.ts
  - [ ] Fetch service price from services collection by serviceId
  - [ ] Fetch barber commissionRate from users collection by barberId
  - [ ] Calculate commissionAmount using calculateCommission() utility
  - [ ] Create serviceLogs document with status: 'approved'
  - [ ] Set both createdAt and approvedAt to current timestamp
  - [ ] Ensure manager-logged services match schema of manager-approved services
- [ ] Implement form submission mutation (AC: 7, 8)
  - [ ] Use React Query useMutation for logServiceForBarber
  - [ ] Show toast notification with barber name on success
  - [ ] Reset dropdown values to placeholders after submission
  - [ ] Handle errors with error toast and rollback
- [ ] Verify real-time synchronization (AC: 9)
  - [ ] Ensure barber's dashboard onSnapshot listener picks up new log
  - [ ] Verify new approved log appears in barber's service log table
  - [ ] Verify barber's daily stats increment immediately
  - [ ] Test with two browser windows (manager + barber)
- [ ] Add form validation (implicit requirement)
  - [ ] Create Zod schema for form validation
  - [ ] Integrate with React Hook Form
  - [ ] Show validation errors inline

## Dev Notes

### Manager Log Service Component Architecture

[Source: architecture.md#Components - Service Logging Service]

The manager's "Log on Behalf" feature uses the Service Logging Service component with a variant that creates pre-approved logs. Key difference from barber logging: status is set to 'approved' immediately, bypassing the pending queue.

**Component Location:** `components/features/manager/ManagerServiceLogForm.tsx`

**Service Function:** `logServiceForBarber(barberId: string, serviceId: string)` in `lib/services/service-logging.ts`

### Data Flow

[Source: architecture.md#Core Workflows - Workflow 1]

```typescript
// Service function signature
export async function logServiceForBarber(
  barberId: string,
  serviceId: string
): Promise<ServiceLog> {
  // 1. Fetch current service data
  const service = await getServiceById(serviceId)

  // 2. Fetch current barber data
  const barber = await getBarberById(barberId)

  // 3. Calculate commission
  const commissionAmount = calculateCommission(
    service.price,
    barber.commissionRate
  )

  // 4. Create service log with approved status
  const serviceLog = {
    barberId,
    serviceId,
    price: service.price, // Snapshot
    commissionRate: barber.commissionRate, // Snapshot
    commissionAmount,
    status: 'approved', // Auto-approved
    createdAt: serverTimestamp(),
    approvedAt: serverTimestamp(), // Set immediately
    rejectedAt: null,
  }

  return await createServiceLog(serviceLog)
}
```

### Firestore Security Rules

[Source: architecture.md#Database Schema - Firestore Security Rules]

Managers can create service logs with any status, including 'approved':

```javascript
// Managers can create logs with any status (for logging on behalf of barbers)
allow create: if isManager();
```

This security rule allows managers to bypass the pending status that barbers must use.

### Form State Management

[Source: architecture.md#Components - Service Logging Service]

Use React Hook Form with Zod validation:

```typescript
const formSchema = z.object({
  barberId: z.string().min(1, 'Please select a barber'),
  serviceId: z.string().min(1, 'Please select a service'),
})

type FormData = z.infer<typeof formSchema>
```

### Real-time Synchronization

[Source: architecture.md#Architectural Patterns - Real-time Data Synchronization]

Barber dashboards use onSnapshot listeners wrapped in React Query, which automatically detect new documents in the serviceLogs collection. When a manager logs a service for a barber, the barber's listener will receive the update within 2 seconds (per NFR requirements).

**Barber's Query:**

```typescript
// Barber dashboard listens to their own logs
const serviceLogs = useRealtimeQuery(
  ['serviceLogs', barberId],
  query(collection(db, 'serviceLogs'), where('barberId', '==', barberId))
)
```

### Data Model Reference

[Source: architecture.md#Data Models - ServiceLog]

**ServiceLog Fields:**

- `barberId`: string (references users.id)
- `serviceId`: string (references services.id)
- `price`: number (snapshot from service)
- `commissionRate`: number (snapshot from barber profile)
- `commissionAmount`: number (calculated)
- `status`: 'approved' (bypasses pending)
- `createdAt`: Firestore.Timestamp
- `approvedAt`: Firestore.Timestamp (same as createdAt for manager-logged)
- `rejectedAt`: null

### Commission Calculation

[Source: architecture.md#Components - Service Logging Service]

Must use the `calculateCommission()` utility function to ensure consistency:

```typescript
export function calculateCommission(price: number, rate: number): number {
  return Math.round(price * rate * 100) / 100 // Round to 2 decimals
}
```

### Testing

**Unit Tests Required:**
[Source: architecture.md#Testing Strategy - Frontend Tests]

1. **ManagerServiceLogForm Component Test** (`tests/component/manager/ManagerServiceLogForm.test.tsx`)
   - Renders barber and service dropdowns
   - Button disabled when selections incomplete
   - Button enabled when both selections made
   - Submits correct data on form submission
   - Shows success toast with barber name
   - Resets form after successful submission
   - Shows error toast on failure

2. **Service Function Test** (`tests/unit/services/service-logging.test.ts`)
   - `logServiceForBarber()` creates log with correct fields
   - Status is 'approved' (not 'pending')
   - approvedAt timestamp is set
   - price and commissionRate are snapshotted
   - commissionAmount calculated correctly
   - Throws error if barber or service not found

**E2E Test Required:**
[Source: architecture.md#Testing Strategy - E2E Tests]

3. **Manager Log Service E2E Test** (`tests/e2e/service-logging.spec.ts`)
   - Manager can select barber from dropdown
   - Manager can select service from dropdown
   - Log Service button enabled when both selected
   - Clicking button creates approved service log
   - Success toast shown with barber name
   - Form resets to placeholders
   - Barber's dashboard updates in real-time (open two browsers)
   - New log appears in barber's table with "Approved" status
   - Barber's daily stats increment (services count + revenue)

**Test Data:**

- Use Firebase Emulator with seeded test data
- Test barber: "John Barber" with 45% commission rate
- Test service: "Haircut" at $25.00
- Expected commission: $11.25

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
