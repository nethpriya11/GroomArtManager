# Story 3.2: Barber Service Logging - Create Service Logs

## Status

Draft

## Story

**As a** barber,
**I want** to log selected services with one click,
**so that** they are submitted for manager approval and I can track my work.

## Acceptance Criteria

1. Clicking "Log X Service(s)" button creates service log documents in Firestore `serviceLogs` collection
2. One document created per selected service with fields: barberId (current user ID), serviceId, price (snapshot from service), commissionRate (snapshot from barber profile), commissionAmount (calculated: price × commissionRate), status: 'pending', createdAt (timestamp), approvedAt: null, rejectedAt: null
3. Toast notification shown: "3 service(s) logged successfully. Pending manager approval."
4. Selected services automatically deselected after logging
5. Optimistic UI update: "My Logged Services" table immediately shows new rows with "Pending" status
6. If Firebase write fails: Optimistic update rolled back, error toast shown: "Failed to log services. Please try again."
7. Service name displayed in table (fetched via serviceId reference)
8. Real-time: If manager opens dashboard while barber is logging, new logs appear instantly in "Pending Approvals"
9. Barber can immediately log more services after successful submission
10. Button returns to "Log Service" label after submission

## Tasks / Subtasks

- [ ] Create commission calculation utility (AC: 2)
  - [ ] Implement calculateCommission function in `lib/utils/calculations.ts`
  - [ ] Formula: price × commissionRate, rounded to 2 decimals
  - [ ] Add unit tests for calculation accuracy
- [ ] Create service logging service layer (AC: 1, 2)
  - [ ] Implement logServices function in `lib/services/service-logging.ts`
  - [ ] Accept barberId and serviceIds[] as parameters
  - [ ] Fetch current barber profile for commissionRate
  - [ ] Fetch service details for price snapshot
  - [ ] Create one serviceLogs document per selected service
  - [ ] Set fields: barberId, serviceId, price, commissionRate, commissionAmount, status: 'pending', createdAt, approvedAt: null, rejectedAt: null
- [ ] Implement React Query mutation with optimistic updates (AC: 5, 6)
  - [ ] Create useLogServices hook using useMutation
  - [ ] Configure optimistic UI update: immediately add rows to "My Logged Services" table
  - [ ] Configure onError rollback: remove optimistically added rows on failure
  - [ ] Return mutation state (isLoading, error) for UI feedback
- [ ] Add toast notifications (AC: 3, 6)
  - [ ] Show success toast on successful logging: "X service(s) logged successfully. Pending manager approval."
  - [ ] Show error toast on failure: "Failed to log services. Please try again."
  - [ ] Use Sonner toast library
- [ ] Update ServiceGrid component (AC: 4, 9, 10)
  - [ ] Call logServices mutation on button click
  - [ ] Clear selected services state after successful submission (setSelectedServices([]))
  - [ ] Reset button label to "Log Service" after submission
  - [ ] Enable immediate re-logging of more services
- [ ] Set up real-time sync for manager dashboard (AC: 8)
  - [ ] Ensure useServiceLogs hook uses onSnapshot listener
  - [ ] Verify manager's "Pending Approvals" table receives new logs instantly (<2s)
  - [ ] Add index for query: status (ASC), createdAt (ASC)
- [ ] Update "My Logged Services" table integration (AC: 5, 7)
  - [ ] Ensure table uses real-time query for barber's logs
  - [ ] Fetch service name via serviceId reference for display
  - [ ] Display optimistic rows immediately on logging

## Dev Notes

### Commission Calculation

[Source: architecture.md#Service Logging Service]

Implement pure function for commission calculation:

```typescript
// lib/utils/calculations.ts
export function calculateCommission(price: number, rate: number): number {
  return Math.round(price * rate * 100) / 100 // Round to 2 decimals
}
```

**Unit Tests Required:**

- $50 × 0.45 = $22.50
- $100 × 0.50 = $50.00
- $25.75 × 0.40 = $10.30

### ServiceLog Data Model

[Source: architecture.md#Data Models]

```typescript
interface ServiceLog {
  id: string
  barberId: string // FK to users.id
  serviceId: string // FK to services.id
  price: number // Snapshot from service at logging time
  commissionRate: number // Snapshot from barber profile at logging time
  commissionAmount: number // Calculated: price * commissionRate
  status: 'pending' | 'approved' | 'rejected'
  createdAt: Firestore.Timestamp
  approvedAt: Firestore.Timestamp | null
  rejectedAt: Firestore.Timestamp | null
}
```

**Important:** Price and commissionRate are snapshotted to preserve historical accuracy. If service price or barber's rate changes later, existing logs retain original values for payroll integrity.

### Service Logging Implementation

[Source: architecture.md#Service Logging Service]

```typescript
// lib/services/service-logging.ts
import { collection, addDoc, serverTimestamp } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'
import { calculateCommission } from '@/lib/utils/calculations'

export async function logServices(
  barberId: string,
  serviceIds: string[]
): Promise<void> {
  // Fetch barber profile for commission rate
  const barberDoc = await getDoc(doc(db, 'users', barberId))
  const barber = barberDoc.data() as UserProfile

  // Create logs for each service
  const promises = serviceIds.map(async (serviceId) => {
    // Fetch service for price snapshot
    const serviceDoc = await getDoc(doc(db, 'services', serviceId))
    const service = serviceDoc.data() as Service

    // Calculate commission
    const commissionAmount = calculateCommission(
      service.price,
      barber.commissionRate
    )

    // Create service log document
    return addDoc(collection(db, 'serviceLogs'), {
      barberId,
      serviceId,
      price: service.price,
      commissionRate: barber.commissionRate,
      commissionAmount,
      status: 'pending',
      createdAt: serverTimestamp(),
      approvedAt: null,
      rejectedAt: null,
    })
  })

  await Promise.all(promises)
}
```

### Optimistic UI Updates

[Source: architecture.md#Optimistic UI Updates]

Use React Query mutation with optimistic updates:

```typescript
// hooks/useLogServices.ts
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { logServices } from '@/lib/services/service-logging'

export function useLogServices() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: ({
      barberId,
      serviceIds,
    }: {
      barberId: string
      serviceIds: string[]
    }) => logServices(barberId, serviceIds),
    onMutate: async ({ barberId, serviceIds }) => {
      // Optimistically add pending logs to cache
      await queryClient.cancelQueries({ queryKey: ['serviceLogs', barberId] })
      const previousLogs = queryClient.getQueryData(['serviceLogs', barberId])

      // Add optimistic logs to cache (simplified)
      queryClient.setQueryData(
        ['serviceLogs', barberId],
        (old: ServiceLog[]) => [...optimisticLogs, ...old]
      )

      return { previousLogs }
    },
    onError: (err, variables, context) => {
      // Rollback on error
      queryClient.setQueryData(['serviceLogs', barberId], context.previousLogs)
    },
    onSuccess: () => {
      // Invalidate to fetch real data from Firestore
      queryClient.invalidateQueries({ queryKey: ['serviceLogs'] })
    },
  })
}
```

### Real-time Synchronization

[Source: architecture.md#Real-time Sync Engine]

Manager's pending approvals table uses onSnapshot listener:

```typescript
// Manager dashboard auto-receives new logs via:
useRealtimeQuery<ServiceLog>(
  ['serviceLogs', 'pending'],
  query(
    collection(db, 'serviceLogs'),
    where('status', '==', 'pending'),
    orderBy('createdAt', 'asc')
  )
)
```

Latency target: <2 seconds from barber logging to manager seeing new pending log.

### Firestore Index Required

[Source: architecture.md#Database Schema]

Composite index for manager's pending queue:

- Fields: `status` (ASC), `createdAt` (ASC)
- Add to `firestore.indexes.json`

### Toast Notifications

[Source: architecture.md#Technology Stack]

Use Sonner library for toast notifications:

```typescript
import { toast } from 'sonner'

// Success
toast.success('3 service(s) logged successfully. Pending manager approval.')

// Error
toast.error('Failed to log services. Please try again.')
```

### Testing

[Source: architecture.md#Testing Strategy]

**Unit Tests (Vitest):**

- Test calculateCommission function accuracy
- Test logServices creates correct number of documents
- Test snapshots price and commissionRate correctly
- Test commission calculation in service log

**Component Tests (React Testing Library):**

- Test button calls logServices mutation on click
- Test toast notification appears on success
- Test error toast appears on failure
- Test selected services cleared after successful logging
- Test button resets to "Log Service" after submission

**E2E Tests (Playwright):**

- Test barber logs services, verifies pending status in table
- Test manager sees new pending logs in real-time (<2s)
- Test optimistic UI update (rows appear immediately)
- Test error handling: disconnect network, verify rollback
- Test barber can immediately log more services after first batch

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
