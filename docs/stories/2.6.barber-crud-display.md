# Story 2.6: Barber CRUD - Display Barber Grid

## Status

Draft

## Story

**As a** manager,
**I want** to see all barbers in a grid with their basic info and daily stats,
**so that** I can manage my team effectively.

## Acceptance Criteria

1. `/manager/barbers` page displays all users with `role: 'barber'` from Firestore `users` collection
2. Barbers shown as cards in responsive grid: 3 columns (desktop), 2 columns (tablet), 1 column (mobile)
3. Each card displays: Avatar (image or placeholder initials), Username, Commission Rate (XX%), Daily stats (Services Today: 0, Revenue Today: $0.00)
4. Cards styled with dark theme (#1a1a1a background, hover state elevation)
5. Real-time updates: New barbers appear instantly
6. Daily stats calculated from `serviceLogs` where `barberId` matches and `createdAt` is today (local time)
7. Stats update in real-time as services are logged/approved
8. Empty state if no barbers: "No barbers yet. Add your first barber to get started."
9. Skeleton loading state on initial page load
10. Each card has dropdown menu (⋮) with "Edit" and "Delete" options

## Tasks / Subtasks

- [ ] Create /manager/barbers page route (AC: 1)
  - [ ] Create app/manager/barbers/page.tsx file
  - [ ] Set up page layout with "Add Barber" button in top-right
  - [ ] Implement button styling (primary amber, as per design system)
- [ ] Implement real-time barber data fetching (AC: 1, 5)
  - [ ] Create useBarbers() hook in hooks/useBarbers.ts
  - [ ] Use Firestore onSnapshot to query users collection where role='barber'
  - [ ] Wrap in React Query with staleTime: Infinity for real-time behavior
  - [ ] Implement automatic cleanup on unmount
- [ ] Create responsive barber card grid (AC: 2)
  - [ ] Implement CSS Grid with responsive breakpoints (3 cols desktop, 2 tablet, 1 mobile)
  - [ ] Use Tailwind classes: grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3
  - [ ] Apply gap spacing between cards
- [ ] Build BarberCard component (AC: 3, 4, 10)
  - [ ] Display avatar (image or placeholder initials using first letter of username)
  - [ ] Display username as card heading
  - [ ] Display commission rate formatted as "XX%"
  - [ ] Display daily stats: "Services Today: 0" and "Revenue Today: $0.00"
  - [ ] Style with dark theme (#1a1a1a background, #2a2a2a border, rounded corners)
  - [ ] Implement hover state (elevation with shadow and 2px translate)
  - [ ] Add dropdown menu (⋮ icon) with "Edit" and "Delete" options using ShadCN DropdownMenu
- [ ] Implement daily stats calculation (AC: 6, 7)
  - [ ] Create helper function to filter serviceLogs by barberId and today's date
  - [ ] Calculate total services count for today
  - [ ] Calculate total revenue (sum of approved logs' price field) for today
  - [ ] Use date-fns to determine "today" in local timezone
  - [ ] Set up real-time listener on serviceLogs to update stats automatically
- [ ] Create empty state component (AC: 8)
  - [ ] Display message: "No barbers yet. Add your first barber to get started."
  - [ ] Show only when barbers array is empty and not loading
  - [ ] Center in page with appropriate styling
- [ ] Implement skeleton loading state (AC: 9)
  - [ ] Create BarberCardSkeleton component with ShadCN Skeleton
  - [ ] Show 6 skeleton cards during initial load
  - [ ] Display while useBarbers() isLoading is true
- [ ] Wire up dropdown menu actions (AC: 10)
  - [ ] Connect "Edit" option to edit modal (implementation in Story 2.7)
  - [ ] Connect "Delete" option to delete confirmation (implementation in Story 2.8)
  - [ ] Pass barber data to parent handlers

## Dev Notes

### Data Model Reference

[Source: architecture.md#Data Models - User Profile]

The barber data comes from the `users` collection in Firestore:

```typescript
interface UserProfile {
  id: string // Firebase Auth UID
  username: string
  role: 'manager' | 'barber'
  avatarUrl: string | null
  commissionRate: number // 0.0 - 1.0 (e.g., 0.45 for 45%)
  createdAt: Firestore.Timestamp
}
```

Filter query: `where('role', '==', 'barber')`

### Real-time Sync Pattern

[Source: architecture.md#Components - Real-time Sync Engine]

Use the real-time query pattern with React Query:

```typescript
export function useBarbers() {
  return useQuery({
    queryKey: ['barbers'],
    queryFn: () =>
      new Promise((resolve) => {
        const unsubscribe = onSnapshot(
          query(collection(db, 'users'), where('role', '==', 'barber')),
          (snapshot) =>
            resolve(snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })))
        )
        return () => unsubscribe()
      }),
    staleTime: Infinity, // Real-time data never stale
  })
}
```

### Daily Stats Calculation

[Source: architecture.md#Components - Reporting & Analytics Service]

Daily stats must filter serviceLogs by:

1. `barberId` matching current barber
2. `status: 'approved'` (only approved logs count toward revenue)
3. `createdAt` is today in local timezone

Use date-fns for date comparison:

```typescript
import { isToday } from 'date-fns'

function calculateDailyStats(barberId: string, allLogs: ServiceLog[]) {
  const todayLogs = allLogs.filter(
    (log) =>
      log.barberId === barberId &&
      log.status === 'approved' &&
      isToday(log.createdAt.toDate())
  )

  return {
    servicesCount: todayLogs.length,
    revenue: todayLogs.reduce((sum, log) => sum + log.price, 0),
  }
}
```

### Project Structure

[Source: architecture.md#Unified Project Structure]

**Files to create/modify:**

- `app/manager/barbers/page.tsx` - Main barbers page
- `components/features/barbers/BarberCard.tsx` - Individual barber card
- `components/features/barbers/BarberGrid.tsx` - Grid container
- `components/features/barbers/BarberCardSkeleton.tsx` - Loading skeleton
- `hooks/useBarbers.ts` - Real-time barbers hook
- `lib/utils/barber-stats.ts` - Daily stats calculation utilities

### Styling Guidelines

[Source: architecture.md#Tech Stack - Tailwind CSS]

**Dark Theme Colors:**

- Background: #1a1a1a
- Border: #2a2a2a
- Primary Accent: #f59e0b (amber)
- Text: Default Tailwind dark theme text colors

**Responsive Grid:**

```tsx
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {/* Cards */}
</div>
```

**Card Hover Effect:**

```tsx
<Card className="bg-[#1a1a1a] border-[#2a2a2a] hover:translate-y-[-2px] hover:shadow-lg transition-all">
```

### Testing

#### Component Tests

[Source: architecture.md#Testing Strategy - Component Tests]

**Tests Required:**

1. `tests/component/barbers/BarberCard.test.tsx`
   - Renders barber information correctly (avatar, username, commission rate)
   - Displays daily stats (services count, revenue formatted as currency)
   - Shows placeholder initials when avatarUrl is null
   - Formats commission rate as percentage (0.45 → "45%")
   - Dropdown menu opens on click
   - Edit and Delete options present in dropdown
   - Hover state applies correct classes
   - Calls onEdit/onDelete handlers when menu items clicked

2. `tests/component/barbers/BarberGrid.test.tsx`
   - Renders all barbers from data array
   - Displays empty state when no barbers
   - Shows skeleton loading state when isLoading is true
   - Responsive grid applies correct column classes
   - Real-time updates: new barber appears when added to data
   - Real-time updates: barber disappears when removed from data

#### Integration Tests

[Source: architecture.md#Testing Strategy - Integration Tests]

**Test with mocked Firestore:**

1. `tests/integration/barbers/barber-display.test.tsx`
   - Mock Firestore onSnapshot to return test barber data
   - Verify useBarbers hook receives and transforms data correctly
   - Verify daily stats calculation with mock serviceLogs
   - Test date filtering (only today's logs counted)
   - Test approved vs pending log filtering (only approved counted)

#### E2E Tests

[Source: architecture.md#Testing Strategy - E2E Tests]

**Playwright test:**

1. `tests/e2e/barber-management.spec.ts`
   - Manager logs in
   - Navigates to /manager/barbers
   - Sees existing barbers in grid
   - Verifies barber cards display correct information
   - Verifies daily stats match expected values (seed test data)
   - Opens dropdown menu on barber card
   - Verifies Edit and Delete options present

#### Unit Tests

[Source: architecture.md#Testing Strategy - Frontend Unit Tests]

**Utility function tests:**

1. `tests/unit/utils/barber-stats.test.ts`
   - calculateDailyStats() returns correct count for today's logs
   - calculateDailyStats() sums revenue correctly
   - calculateDailyStats() filters out non-approved logs
   - calculateDailyStats() filters out logs from previous days
   - calculateDailyStats() handles empty logs array
   - Date comparison works across timezone boundaries

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
