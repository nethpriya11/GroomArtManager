# Story 3.5: Barber Delete Pending Logs

## Status

Draft

## Story

**As a** barber,
**I want** to delete my own service logs while they're still pending,
**so that** I can correct mistakes before manager review.

## Acceptance Criteria

1. Service logs with status 'pending' have a delete action in the barber's service log table (trash icon button in row)
2. Clicking delete shows confirmation dialog: "Delete this pending service log?"
3. Confirmation buttons: "Cancel" and "Delete" (destructive)
4. On confirm: Service log document deleted from Firestore
5. Row disappears from table immediately (optimistic update)
6. Toast notification: "Service log deleted"
7. Only pending logs can be deleted (approved/rejected logs do not show delete button)
8. Barbers can only delete their own logs (security rule enforced)
9. If delete fails: Optimistic update rolled back, error toast shown
10. Deleted logs do not count toward daily stats

## Tasks / Subtasks

- [ ] Add delete button UI to service log table rows (AC: 1)
  - [ ] Conditionally render trash icon button only for pending logs
  - [ ] Position button in Actions column of ServiceLogTable component
  - [ ] Ensure button meets 44x44px touch target requirement
  - [ ] Apply destructive styling (red color on hover)
- [ ] Implement confirmation dialog (AC: 2, 3)
  - [ ] Use ShadCN AlertDialog component
  - [ ] Set dialog title: "Delete this pending service log?"
  - [ ] Add "Cancel" button (default variant)
  - [ ] Add "Delete" button (destructive variant)
  - [ ] Wire up dialog open/close state
- [ ] Create deleteServiceLog mutation (AC: 4, 5, 6, 9)
  - [ ] Implement service function in lib/services/service-log-service.ts
  - [ ] Use Firestore deleteDoc() to remove log document
  - [ ] Configure React Query mutation with optimistic update
  - [ ] Optimistically remove row from table immediately
  - [ ] Show toast notification: "Service log deleted"
  - [ ] Handle error case: rollback optimistic update, show error toast
- [ ] Implement conditional rendering logic (AC: 7)
  - [ ] Check log.status === 'pending' before showing delete button
  - [ ] Hide delete button for 'approved' and 'rejected' logs
  - [ ] Add status check to button visibility condition
- [ ] Verify security rules enforcement (AC: 8)
  - [ ] Confirm Firestore security rule allows barber to delete own pending logs
  - [ ] Rule: barberId == request.auth.uid && status == 'pending'
  - [ ] Test that barbers cannot delete other barbers' logs
- [ ] Verify daily stats integration (AC: 10)
  - [ ] Ensure deleted logs don't count in daily stats query
  - [ ] Stats query filters by status='approved' (excludes deleted)
  - [ ] No additional code needed (deletion removes from collection)

## Dev Notes

### Data Model & Security

[Source: architecture.md#ServiceLog Data Model]

**ServiceLog Interface:**

```typescript
interface ServiceLog {
  id: string
  barberId: string // FK to users.id
  serviceId: string // FK to services.id
  price: number
  commissionRate: number
  commissionAmount: number
  status: 'pending' | 'approved' | 'rejected'
  createdAt: Firestore.Timestamp
  approvedAt: Firestore.Timestamp | null
  rejectedAt: Firestore.Timestamp | null
}
```

[Source: architecture.md#Firestore Security Rules]

**Security Rule for Deletion:**

```javascript
// Barbers can delete their own pending logs
allow delete: if isBarber()
  && resource.data.barberId == request.auth.uid
  && resource.data.status == 'pending';
```

This rule enforces that:

1. User must have role='barber' custom claim
2. Log must belong to the barber (barberId matches auth UID)
3. Log must have status='pending' (approved/rejected cannot be deleted)

### Service Layer Pattern

[Source: architecture.md#Service Logging Service]

**Delete Function Implementation:**

```typescript
// lib/services/service-log-service.ts
import { doc, deleteDoc } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export async function deleteServiceLog(logId: string): Promise<void> {
  await deleteDoc(doc(db, 'serviceLogs', logId))
}
```

**React Query Mutation with Optimistic Update:**
[Source: architecture.md#Optimistic UI Updates Pattern]

```typescript
const { mutate: deleteLog } = useMutation({
  mutationFn: deleteServiceLog,
  onMutate: async (logId) => {
    // Cancel outgoing refetches
    await queryClient.cancelQueries({ queryKey: ['serviceLogs', barberId] })

    // Snapshot previous value
    const previousLogs = queryClient.getQueryData(['serviceLogs', barberId])

    // Optimistically update cache
    queryClient.setQueryData(['serviceLogs', barberId], (old: ServiceLog[]) =>
      old.filter((log) => log.id !== logId)
    )

    return { previousLogs }
  },
  onError: (err, logId, context) => {
    // Rollback on error
    queryClient.setQueryData(['serviceLogs', barberId], context.previousLogs)
    toast.error('Failed to delete service log. Please try again.')
  },
  onSuccess: () => {
    toast.success('Service log deleted')
  },
})
```

### UI Components

[Source: architecture.md#Component Architecture]

**Required Components:**

- `ServiceLogTable.tsx` - Add Actions column with conditional delete button
- ShadCN `AlertDialog` - Confirmation dialog
- ShadCN `Button` with Trash icon - Delete action trigger
- Sonner toast notifications - Success/error feedback

**Touch Target Requirements:**
[Source: architecture.md#Mobile Requirements]

- Icon buttons must be minimum 44x44px for mobile accessibility
- Use ShadCN Button with `size="icon"` prop

### Testing

[Source: architecture.md#Testing Strategy]

**Unit Tests (Vitest):**

- `tests/unit/services/service-log-service.test.ts`
  - Test `deleteServiceLog()` calls Firestore deleteDoc with correct log ID
  - Mock Firestore SDK
  - Verify function throws on Firestore error

**Component Tests (React Testing Library):**

- `tests/component/service-logs/ServiceLogTable.test.tsx`
  - Render table with pending logs - verify delete button visible
  - Render table with approved logs - verify delete button hidden
  - Render table with rejected logs - verify delete button hidden
  - Click delete button - verify confirmation dialog opens
  - Click cancel in dialog - verify dialog closes, log not deleted
  - Click delete in dialog - verify mutation called with correct log ID
  - Test optimistic update: verify row disappears immediately
  - Test error handling: verify rollback and error toast on mutation failure

**Integration Tests:**

- `tests/component/dashboard/BarberDashboard.test.tsx`
  - Full workflow: Delete pending log, verify it disappears from table
  - Verify daily stats unaffected (only count approved logs)

**E2E Tests (Playwright):**

- `tests/e2e/service-logs/delete-pending-log.spec.ts`
  - As barber, log service (creates pending log)
  - Click delete button on pending log
  - Confirm deletion in dialog
  - Verify log disappears from table
  - Verify toast notification shown
  - Verify Firestore document deleted (query collection)
  - As barber, attempt to delete another barber's log via API - verify 403 error
  - As barber, attempt to delete approved log - verify button not present

**Security Rule Tests:**

- `tests/security/firestore-rules.test.ts`
  - Test barber can delete own pending log (should succeed)
  - Test barber cannot delete other barber's pending log (should fail)
  - Test barber cannot delete own approved log (should fail)
  - Test barber cannot delete own rejected log (should fail)
  - Test manager can delete any pending log (if rule allows)

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
