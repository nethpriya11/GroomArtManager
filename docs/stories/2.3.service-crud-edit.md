# Story 2.3: Service CRUD - Edit Service

## Status

Draft

## Story

**As a** manager,
**I want** to edit an existing service's details,
**so that** I can update pricing or duration as needed.

## Acceptance Criteria

1. Each service card on `/manager/services` has a dropdown menu (⋮ icon, top-right corner)
2. Dropdown contains "Edit" and "Delete" options (ShadCN DropdownMenu component)
3. Clicking "Edit" opens a modal dialog pre-filled with current service data
4. Dialog form identical to "Add Service" but title is "Edit Service" and button says "Save Changes"
5. Form fields pre-populated with existing values (name, price, duration)
6. Validation rules same as create: Name required, Price positive, Duration positive integer
7. On submit: Service document updated in Firestore with new values
8. Toast notification: "Service '[name]' updated successfully"
9. Dialog closes, updated service reflects changes immediately in grid (real-time or optimistic update)
10. Cancel button closes dialog without saving changes

## Tasks / Subtasks

- [ ] Add dropdown menu to service cards (AC: 1, 2)
  - [ ] Update `ServiceCard.tsx` to include ShadCN DropdownMenu component
  - [ ] Add three-dot icon (⋮) in top-right corner of card
  - [ ] Add "Edit" and "Delete" menu options
  - [ ] Only show dropdown for managers (role-based rendering)
- [ ] Implement Edit Service dialog (AC: 3, 4)
  - [ ] Reuse `ServiceFormDialog.tsx` component with edit mode prop
  - [ ] Change dialog title to "Edit Service"
  - [ ] Change submit button text to "Save Changes"
  - [ ] Pass existing service data as prop to dialog
- [ ] Pre-populate form fields (AC: 5)
  - [ ] Set default values in React Hook Form with existing service data
  - [ ] Use `reset()` method or `defaultValues` prop
  - [ ] Ensure all fields (name, price, duration) display current values
- [ ] Maintain validation rules (AC: 6)
  - [ ] Use same Zod schema as create: `createServiceSchema`
  - [ ] Apply same validation rules: Name required, Price positive, Duration positive integer
  - [ ] Display validation errors inline below fields
- [ ] Implement Firestore update operation (AC: 7)
  - [ ] Create `updateService()` function in `lib/firebase/repositories/service-repository.ts`
  - [ ] Update service document in Firestore with new values
  - [ ] Implement React Query mutation with optimistic update
- [ ] Add user feedback (AC: 8, 9)
  - [ ] Show Sonner toast: "Service '[name]' updated successfully"
  - [ ] Auto-close dialog on successful update
  - [ ] Ensure updated service reflects changes immediately (real-time or optimistic)
- [ ] Implement cancel functionality (AC: 10)
  - [ ] Add "Cancel" button to dialog
  - [ ] Close dialog without saving on cancel click
  - [ ] Reset form state on cancel

## Dev Notes

### Service Update Repository Function

[Source: architecture.md#Components - Repository Pattern]

Create update function in `lib/firebase/repositories/service-repository.ts`:

```typescript
import { doc, updateDoc } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'
import type { Service } from '@/types/firestore'

export async function updateService(
  id: string,
  data: Partial<Omit<Service, 'id' | 'createdAt'>>
): Promise<void> {
  const serviceRef = doc(db, 'services', id)
  await updateDoc(serviceRef, data)
}
```

### React Hook Form Default Values

[Source: architecture.md#Coding Standards - Form Validation]

Pre-populate form with existing data:

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'

function ServiceFormDialog({
  service,
  mode,
}: {
  service?: Service
  mode: 'create' | 'edit'
}) {
  const form = useForm({
    resolver: zodResolver(createServiceSchema),
    defaultValues:
      mode === 'edit' && service
        ? {
            name: service.name,
            price: service.price,
            duration: service.duration,
          }
        : {
            name: '',
            price: 0,
            duration: 0,
          },
  })

  // Reset form when service data changes
  useEffect(() => {
    if (mode === 'edit' && service) {
      form.reset({
        name: service.name,
        price: service.price,
        duration: service.duration,
      })
    }
  }, [service, mode, form])
}
```

### React Query Update Mutation

[Source: architecture.md#Architectural Patterns - Optimistic UI Updates]

Implement optimistic update with rollback:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'

const queryClient = useQueryClient()
const updateServiceMutation = useMutation({
  mutationFn: ({ id, data }: { id: string; data: Partial<Service> }) =>
    updateService(id, data),
  onMutate: async ({ id, data }) => {
    // Cancel ongoing queries
    await queryClient.cancelQueries(['services'])

    // Snapshot previous value
    const previous = queryClient.getQueryData<Service[]>(['services'])

    // Optimistically update
    queryClient.setQueryData<Service[]>(['services'], (old) =>
      old?.map((service) =>
        service.id === id ? { ...service, ...data } : service
      )
    )

    return { previous }
  },
  onError: (err, variables, context) => {
    // Rollback on error
    if (context?.previous) {
      queryClient.setQueryData(['services'], context.previous)
    }
  },
  onSettled: () => {
    queryClient.invalidateQueries(['services'])
  },
})
```

### ShadCN DropdownMenu Implementation

[Source: Epic 2 AC: 1, 2]

Add action menu to service card:

```tsx
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { MoreVertical } from 'lucide-react'

function ServiceCard({ service }: { service: Service }) {
  const { user } = useAuth()
  const isManager = user?.role === 'manager'

  return (
    <div className="relative bg-[#1a1a1a] border border-[#2a2a2a] rounded-lg p-6">
      {/* Card content */}

      {isManager && (
        <DropdownMenu>
          <DropdownMenuTrigger className="absolute top-4 right-4">
            <MoreVertical className="h-5 w-5" />
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem onClick={() => handleEdit(service)}>
              Edit
            </DropdownMenuItem>
            <DropdownMenuItem onClick={() => handleDelete(service)}>
              Delete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      )}
    </div>
  )
}
```

### Reusable Form Dialog Pattern

[Source: architecture.md#Component-Based UI]

Create flexible dialog component supporting both create and edit modes:

```typescript
interface ServiceFormDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  service?: Service // Optional - only provided in edit mode
  mode: 'create' | 'edit'
}

function ServiceFormDialog({
  open,
  onOpenChange,
  service,
  mode,
}: ServiceFormDialogProps) {
  const title = mode === 'create' ? 'Add Service' : 'Edit Service'
  const submitText = mode === 'create' ? 'Create' : 'Save Changes'

  // Use appropriate mutation based on mode
  const mutation =
    mode === 'create' ? createServiceMutation : updateServiceMutation

  // ... form implementation
}
```

### Component Structure

[Source: architecture.md#Unified Project Structure]

File locations:

- Card component: `components/features/services/ServiceCard.tsx` (updated)
- Dialog component: `components/features/services/ServiceFormDialog.tsx` (updated for edit mode)
- Repository: `lib/firebase/repositories/service-repository.ts` (add updateService)
- Validation: `lib/validations/schemas.ts` (reuse createServiceSchema)

### Testing

#### Unit Tests

[Source: architecture.md#Testing Strategy]

**Repository Test** (`tests/unit/repositories/service-repository.test.ts`):

- Mock Firestore `updateDoc` function
- Test updateService updates document with provided data
- Test updateService throws error on Firestore failure
- Test updateService preserves fields not in update data

#### Component Tests

[Source: architecture.md#Testing Strategy]

**ServiceCard Test** (`tests/component/services/ServiceCard.test.tsx`):

- Test dropdown menu renders for managers
- Test dropdown menu contains "Edit" and "Delete" options
- Test clicking "Edit" opens edit dialog with service data
- Test dropdown menu does not render for barbers

**ServiceFormDialog Edit Mode Test** (`tests/component/services/ServiceForm.test.tsx`):

- Test dialog title shows "Edit Service" in edit mode
- Test submit button shows "Save Changes" in edit mode
- Test form fields pre-populated with existing service data
- Test form validation applies same rules as create
- Test successful update calls updateService mutation
- Test toast notification shows with service name
- Test dialog closes after successful update
- Test cancel button closes dialog without saving
- Test form resets when service prop changes

#### E2E Tests

[Source: architecture.md#Testing Strategy]

**Service Edit E2E** (`tests/e2e/service-management.spec.ts`):

- Test manager clicks dropdown menu on service card
- Test clicking "Edit" opens dialog with pre-filled data
- Test updating service name, price, or duration
- Test submitting form updates service in database
- Test toast notification appears
- Test updated service displays new values immediately
- Test cancel button closes dialog without changes
- Test validation prevents invalid updates

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
