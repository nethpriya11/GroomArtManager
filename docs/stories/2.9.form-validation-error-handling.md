# Story 2.9: Form Validation & Error Handling

## Status

Draft

## Story

**As a** manager,
**I want** clear feedback when I make input mistakes in forms,
**so that** I can correct errors before submitting.

## Acceptance Criteria

1. All forms (Add/Edit Service, Add/Edit Barber) use Zod schemas for validation
2. Validation errors displayed inline below each field in red text (#ef4444)
3. Error messages are specific: "Price must be a positive number", "Username is required", "Commission rate must be between 0 and 100"
4. Submit buttons disabled when form has validation errors
5. Fields with errors have red border (#ef4444)
6. Real-time validation: Errors appear as user types (debounced by 300ms)
7. Errors clear when field becomes valid
8. Focus automatically moves to first error field on attempted submit with errors
9. Firebase errors (network issues, permission denied) caught and displayed as toast notifications
10. All error messages meet accessibility standards (associated with fields via aria-describedby)

## Tasks / Subtasks

- [ ] Create Zod validation schemas (AC: 1, 3)
  - [ ] Create/update lib/validations/schemas.ts
  - [ ] Define createServiceSchema with name, price, duration validation
  - [ ] Define editServiceSchema (same as create)
  - [ ] Define createBarberSchema with username, avatarUrl, commissionRate validation
  - [ ] Define editBarberSchema with avatarUrl, commissionRate validation
  - [ ] Write specific error messages for each validation rule
  - [ ] Export TypeScript types from schemas using z.infer
- [ ] Integrate Zod with React Hook Form (AC: 1, 4)
  - [ ] Install @hookform/resolvers package
  - [ ] Use zodResolver in useForm hook for all forms
  - [ ] Pass schema to resolver: resolver: zodResolver(createServiceSchema)
  - [ ] Configure form mode: mode: 'onChange' for real-time validation
- [ ] Implement inline error display (AC: 2, 3, 5)
  - [ ] Use React Hook Form's formState.errors object
  - [ ] Display error messages below each field using ShadCN Form components
  - [ ] Style error text with red color (#ef4444)
  - [ ] Apply red border to fields with errors using error state
  - [ ] Use ShadCN FormMessage component for consistent styling
- [ ] Configure real-time validation (AC: 6, 7)
  - [ ] Set form mode to 'onChange' in useForm config
  - [ ] Add debounce to validation: reValidateMode: 'onChange', mode: 'onBlur' initially
  - [ ] Implement 300ms debounce using custom hook or lodash.debounce
  - [ ] Clear errors when field value becomes valid (automatic with React Hook Form)
- [ ] Implement submit button state (AC: 4)
  - [ ] Use formState.isValid to control button disabled state
  - [ ] Disable button when form has validation errors
  - [ ] Add visual disabled styling (opacity, cursor-not-allowed)
  - [ ] Keep button disabled during submission (formState.isSubmitting)
- [ ] Auto-focus first error field (AC: 8)
  - [ ] Use setFocus() from React Hook Form
  - [ ] On form submit with errors, focus first field with error
  - [ ] Implement in onSubmit handler or onError callback
  - [ ] Get first error key from errors object
- [ ] Handle Firebase errors (AC: 9)
  - [ ] Wrap all Firestore operations in try/catch blocks
  - [ ] Map Firebase error codes to user-friendly messages
  - [ ] Network errors: "Unable to connect. Please check your internet connection."
  - [ ] Permission denied: "You don't have permission to perform this action."
  - [ ] Not found: "The requested item could not be found."
  - [ ] Display errors using Sonner toast notifications
  - [ ] Log original errors to console for debugging
- [ ] Implement accessibility (AC: 10)
  - [ ] Associate error messages with fields using aria-describedby
  - [ ] Use ShadCN Form components (built-in accessibility)
  - [ ] Ensure FormField, FormLabel, FormMessage, FormDescription are used
  - [ ] Add aria-invalid attribute to fields with errors (automatic with ShadCN)
  - [ ] Test with screen reader to verify error announcements

## Dev Notes

### Zod Validation Schemas

[Source: architecture.md#Coding Standards - Form Validation]

Create comprehensive schemas in `lib/validations/schemas.ts`:

```typescript
import { z } from 'zod'

// Service Schemas
export const createServiceSchema = z.object({
  name: z
    .string()
    .min(1, 'Service name is required')
    .max(50, 'Service name must be 50 characters or less'),
  price: z
    .number()
    .positive('Price must be a positive number')
    .min(0.01, 'Price must be at least $0.01')
    .max(10000, 'Price cannot exceed $10,000'),
  duration: z
    .number()
    .int('Duration must be a whole number')
    .positive('Duration must be a positive number')
    .min(1, 'Duration must be at least 1 minute')
    .max(480, 'Duration cannot exceed 480 minutes (8 hours)'),
})

export const editServiceSchema = createServiceSchema

export type CreateServiceFormData = z.infer<typeof createServiceSchema>
export type EditServiceFormData = z.infer<typeof editServiceSchema>

// Barber Schemas
export const createBarberSchema = z.object({
  username: z
    .string()
    .min(1, 'Username is required')
    .max(50, 'Username must be 50 characters or less')
    .regex(
      /^[a-zA-Z0-9\s]+$/,
      'Username can only contain letters, numbers, and spaces'
    ),
  avatarUrl: z.string().url('Must be a valid URL').optional().or(z.literal('')),
  commissionRate: z
    .number()
    .min(0, 'Commission rate must be at least 0%')
    .max(100, 'Commission rate cannot exceed 100%'),
})

export const editBarberSchema = z.object({
  username: z.string(), // Present but disabled in form
  avatarUrl: z.string().url('Must be a valid URL').optional().or(z.literal('')),
  commissionRate: z
    .number()
    .min(0, 'Commission rate must be at least 0%')
    .max(100, 'Commission rate cannot exceed 100%'),
})

export type CreateBarberFormData = z.infer<typeof createBarberSchema>
export type EditBarberFormData = z.infer<typeof editBarberSchema>
```

### React Hook Form Integration

[Source: architecture.md#Tech Stack - React Hook Form]

Configure forms with Zod resolver:

```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { createServiceSchema, type CreateServiceFormData } from '@/lib/validations/schemas';

export function ServiceForm() {
  const form = useForm<CreateServiceFormData>({
    resolver: zodResolver(createServiceSchema),
    mode: 'onChange', // Real-time validation
    defaultValues: {
      name: '',
      price: 0,
      duration: 30,
    },
  });

  const onSubmit = async (data: CreateServiceFormData) => {
    try {
      await createService(data);
      toast.success(`Service '${data.name}' added successfully`);
    } catch (error) {
      handleFirebaseError(error);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)}>
        {/* Form fields */}
      </form>
    </Form>
  );
}
```

### ShadCN Form Pattern

[Source: architecture.md#Tech Stack - ShadCN UI]

Use ShadCN Form components for built-in accessibility:

```tsx
<FormField
  control={form.control}
  name="price"
  render={({ field }) => (
    <FormItem>
      <FormLabel>Price</FormLabel>
      <FormControl>
        <Input
          type="number"
          placeholder="25.00"
          {...field}
          className={cn(form.formState.errors.price && 'border-red-500')}
        />
      </FormControl>
      <FormDescription>Enter the service price in dollars</FormDescription>
      <FormMessage /> {/* Automatically displays error */}
    </FormItem>
  )}
/>
```

This pattern automatically:

- Associates labels with inputs
- Adds aria-describedby for errors
- Sets aria-invalid when field has error
- Displays error message in red (#ef4444)

### Error Focus Implementation

[Source: architecture.md#Coding Standards - Form Validation]

Auto-focus first error field:

```typescript
const onSubmit = form.handleSubmit(
  async (data) => {
    // Valid submission
    await createService(data)
  },
  (errors) => {
    // Invalid submission - focus first error
    const firstErrorField = Object.keys(
      errors
    )[0] as keyof CreateServiceFormData
    form.setFocus(firstErrorField)
  }
)
```

### Firebase Error Handling

[Source: architecture.md#Coding Standards - Error Handling]

Create error handler utility in `lib/utils/error-handlers.ts`:

```typescript
import { toast } from 'sonner'
import { FirebaseError } from 'firebase/app'

export function handleFirebaseError(error: unknown) {
  console.error('Firebase error:', error)

  if (error instanceof FirebaseError) {
    switch (error.code) {
      case 'permission-denied':
        toast.error("You don't have permission to perform this action.")
        break
      case 'not-found':
        toast.error('The requested item could not be found.')
        break
      case 'unavailable':
        toast.error('Unable to connect. Please check your internet connection.')
        break
      case 'already-exists':
        toast.error('This item already exists.')
        break
      default:
        toast.error('An unexpected error occurred. Please try again.')
    }
  } else if (error instanceof Error) {
    toast.error(error.message)
  } else {
    toast.error('An unexpected error occurred. Please try again.')
  }
}
```

### Debounced Validation

[Source: architecture.md#Coding Standards - Form Validation]

For better UX, debounce validation by 300ms:

```typescript
import { useForm } from 'react-hook-form'
import { useDebouncedCallback } from 'use-debounce'

const form = useForm({
  resolver: zodResolver(schema),
  mode: 'all', // Validate on change and blur
  reValidateMode: 'onChange',
  // Note: React Hook Form 7+ has built-in debouncing via mode config
  // For custom debouncing, wrap onChange handlers
})
```

Actually, React Hook Form handles validation timing well. Set `mode: 'onChange'` for real-time, or use `mode: 'onBlur'` then switch to `'onChange'` after first submit for better UX.

### Project Structure

[Source: architecture.md#Unified Project Structure]

**Files to create/modify:**

- `lib/validations/schemas.ts` - All Zod validation schemas
- `lib/utils/error-handlers.ts` - Firebase error handling utilities
- Update all form components to use schemas:
  - `components/features/services/ServiceForm.tsx`
  - `components/features/barbers/CreateBarberDialog.tsx`
  - `components/features/barbers/EditBarberDialog.tsx`

### Testing

#### Component Tests

[Source: architecture.md#Testing Strategy - Component Tests]

**Tests Required:**

1. `tests/component/forms/ServiceForm.test.tsx`
   - Shows error when name field is empty
   - Shows error when price is negative
   - Shows error when price is zero
   - Shows error when duration is not an integer
   - Shows error when duration is negative
   - Submit button disabled when form invalid
   - Submit button enabled when form valid
   - Errors clear when field becomes valid
   - First error field receives focus on invalid submit
   - Success toast shown on successful submit
   - Error toast shown on Firebase error

2. `tests/component/forms/BarberForm.test.tsx`
   - Shows error when username is empty
   - Shows error when commission rate < 0
   - Shows error when commission rate > 100
   - Shows error when avatar URL is invalid format
   - No error when avatar URL is empty (optional field)
   - Submit button disabled when form invalid
   - Errors display with red text and border
   - Auto-focus first error field on invalid submit

#### Integration Tests

[Source: architecture.md#Testing Strategy - Integration Tests]

**Test with mocked Firestore:**

1. `tests/integration/forms/form-validation.test.tsx`
   - Submit form with invalid data
   - Verify Firestore not called (validation prevents submission)
   - Fix validation errors
   - Submit form with valid data
   - Verify Firestore called with correct data
   - Simulate Firestore permission-denied error
   - Verify error toast displayed with correct message
   - Simulate network error
   - Verify network error toast displayed

#### E2E Tests

[Source: architecture.md#Testing Strategy - E2E Tests]

**Playwright tests:**

1. `tests/e2e/form-validation.spec.ts`
   - Open Add Service dialog
   - Click submit without filling form
   - Verify inline error messages appear
   - Verify submit button disabled
   - Fill name field with valid value
   - Verify name error clears
   - Enter negative price
   - Verify price error appears with correct message
   - Enter valid price
   - Verify price error clears
   - Enter non-integer duration
   - Verify duration error appears
   - Enter valid duration
   - Verify all errors cleared and submit enabled
   - Submit form
   - Verify success toast appears
   - Test with screen reader to verify error announcements

#### Unit Tests

[Source: architecture.md#Testing Strategy - Frontend Unit Tests]

**Schema validation tests:**

1. `tests/unit/validations/schemas.test.ts`
   - createServiceSchema validates name required
   - createServiceSchema validates price positive
   - createServiceSchema validates duration integer
   - createServiceSchema accepts valid data
   - createBarberSchema validates username required
   - createBarberSchema validates commission rate 0-100
   - createBarberSchema accepts optional avatarUrl
   - createBarberSchema rejects invalid URL format
   - editBarberSchema allows disabled username field

2. `tests/unit/utils/error-handlers.test.ts`
   - handleFirebaseError maps permission-denied to user message
   - handleFirebaseError maps unavailable to network message
   - handleFirebaseError maps not-found to not found message
   - handleFirebaseError calls toast.error with message
   - handleFirebaseError logs error to console
   - handleFirebaseError handles non-Firebase errors

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
