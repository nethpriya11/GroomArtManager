# Story 1.10: Testing Infrastructure & First Tests

## Status

Draft

## Story

**As a** developer,
**I want** testing infrastructure configured with example tests,
**so that** the team can write tests consistently from the start.

## Acceptance Criteria

1. Vitest configured with React Testing Library for unit/component tests
2. Playwright configured for E2E tests with Firebase Emulator integration
3. Test directory structure created (`tests/unit/`, `tests/e2e/`)
4. Example unit test written for Zustand auth store (login, logout actions)
5. Example component test written for Login page buttons
6. Example E2E test written: "Manager can log in and reach dashboard"
7. Firebase Emulator Suite integration in E2E tests (tests run against local emulator)
8. Test coverage reporting configured (Vitest coverage with c8)
9. npm scripts added: `test`, `test:watch`, `test:e2e`, `test:coverage`
10. CI pipeline runs all tests successfully

## Tasks / Subtasks

- [ ] Configure Vitest for unit/component tests (AC: 1)
  - [ ] Install Vitest, @vitejs/plugin-react, jsdom
  - [ ] Create vitest.config.ts with React and jsdom setup
  - [ ] Install React Testing Library (@testing-library/react, @testing-library/jest-dom)
  - [ ] Create tests/setup.ts for global test configuration
  - [ ] Configure path aliases (@/) in vitest.config.ts
- [ ] Configure Playwright for E2E tests (AC: 2, 7)
  - [ ] Install Playwright (@playwright/test)
  - [ ] Run npx playwright install to download browsers
  - [ ] Create playwright.config.ts with baseURL and browser config
  - [ ] Configure Firebase Emulator integration in E2E tests
  - [ ] Add emulator startup/teardown scripts
- [ ] Create test directory structure (AC: 3)
  - [ ] Create tests/unit/ directory
  - [ ] Create tests/component/ directory
  - [ ] Create tests/e2e/ directory
  - [ ] Create tests/fixtures/ for test data
  - [ ] Create tests/setup.ts for global setup
- [ ] Write Zustand auth store unit test (AC: 4)
  - [ ] Create tests/unit/stores/authStore.test.ts
  - [ ] Test login action updates user state
  - [ ] Test logout action clears user state
  - [ ] Test isAuthenticated computed from user presence
  - [ ] Test persistence middleware (localStorage)
- [ ] Write Login page component test (AC: 5)
  - [ ] Create tests/component/auth/LoginPage.test.tsx
  - [ ] Test Manager button renders correctly
  - [ ] Test Barber button renders correctly
  - [ ] Test Manager button click navigates to /manager/dashboard
  - [ ] Test Barber button click shows barber selection
  - [ ] Test keyboard navigation (Tab, Enter)
- [ ] Write E2E test for manager login flow (AC: 6)
  - [ ] Create tests/e2e/auth.spec.ts
  - [ ] Test: "Manager can log in and reach dashboard"
  - [ ] Click Manager button on /login
  - [ ] Verify redirect to /manager/dashboard
  - [ ] Verify navigation bar displays
  - [ ] Verify authenticated in header
- [ ] Configure test coverage reporting (AC: 8)
  - [ ] Install @vitest/coverage-v8 (c8 replacement)
  - [ ] Add coverage configuration to vitest.config.ts
  - [ ] Set coverage thresholds (80% lines, 70% branches)
  - [ ] Configure coverage reporters (text, html, json)
  - [ ] Exclude test files and config from coverage
- [ ] Add npm test scripts (AC: 9)
  - [ ] Add "test": "vitest run" to package.json
  - [ ] Add "test:watch": "vitest" to package.json
  - [ ] Add "test:e2e": "playwright test" to package.json
  - [ ] Add "test:coverage": "vitest run --coverage" to package.json
  - [ ] Add "test:ui": "vitest --ui" for Vitest UI (optional)
- [ ] Integrate tests into CI pipeline (AC: 10)
  - [ ] Update .github/workflows/ci-cd.yml
  - [ ] Add test job: lint, type-check, unit tests, build
  - [ ] Add E2E job: start emulators, run Playwright tests
  - [ ] Configure test parallelization for speed
  - [ ] Verify all tests pass in CI environment

## Dev Notes

### Vitest Configuration

[Source: architecture.md#Tech Stack - Frontend Testing]

**Installation:**

```bash
npm install -D vitest @vitejs/plugin-react jsdom
npm install -D @testing-library/react @testing-library/jest-dom @testing-library/user-event
npm install -D @vitest/coverage-v8
```

**Configuration (vitest.config.ts):**

```typescript
import { defineConfig } from 'vitest/config'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'json'],
      exclude: [
        'node_modules/',
        'tests/',
        '*.config.ts',
        '*.config.js',
        '.next/',
      ],
      lines: 80,
      branches: 70,
      functions: 75,
      statements: 80,
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
    },
  },
})
```

**Test Setup (tests/setup.ts):**

```typescript
import '@testing-library/jest-dom'
import { vi } from 'vitest'

// Mock Next.js router
vi.mock('next/navigation', () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    prefetch: vi.fn(),
  }),
  usePathname: () => '/',
  useSearchParams: () => new URLSearchParams(),
}))

// Mock Firebase
vi.mock('@/lib/firebase/config', () => ({
  db: {},
  auth: {},
}))
```

### Playwright Configuration

[Source: architecture.md#Tech Stack - E2E Testing]

**Installation:**

```bash
npm install -D @playwright/test
npx playwright install
```

**Configuration (playwright.config.ts):**

```typescript
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### Firebase Emulator Integration

[Source: architecture.md#Testing Strategy - E2E Tests]

**Emulator Setup (tests/e2e/setup.ts):**

```typescript
import { test as base } from '@playwright/test'

export const test = base.extend({
  page: async ({ page }, use) => {
    // Reset emulator data before each test
    await page.request.delete(
      'http://localhost:8080/emulator/v1/projects/salonflow-test/databases/(default)/documents'
    )

    // Seed test data
    await page.request.post('http://localhost:3000/api/test/seed')

    await use(page)
  },
})
```

**Emulator Scripts (package.json):**

```json
{
  "scripts": {
    "emulators:start": "firebase emulators:start --only firestore,auth",
    "test:e2e:emulators": "firebase emulators:exec --only firestore,auth 'playwright test'"
  }
}
```

**Key Points:**

- E2E tests run against Firebase Emulator (not production)
- Reset emulator data before each test for isolation
- Seed test data (1 manager, 3 barbers, 5 services)
- Use test project ID: `salonflow-test`

### Test Directory Structure

[Source: architecture.md#Test Organization]

```
tests/
├── unit/
│   ├── hooks/
│   │   └── useRealtimeQuery.test.ts
│   ├── stores/
│   │   └── authStore.test.ts
│   ├── utils/
│   │   └── calculations.test.ts
│   └── validations/
│       └── schemas.test.ts
├── component/
│   ├── auth/
│   │   ├── LoginPage.test.tsx
│   │   └── BarberProfileSelection.test.tsx
│   ├── dashboard/
│   │   ├── ManagerDashboard.test.tsx
│   │   └── BarberDashboard.test.tsx
│   └── common/
│       └── ErrorBoundary.test.tsx
├── e2e/
│   ├── auth.spec.ts
│   ├── service-logging.spec.ts
│   └── real-time-sync.spec.ts
├── fixtures/
│   ├── users.json
│   ├── services.json
│   └── service-logs.json
└── setup.ts
```

### Example Unit Test: Zustand Auth Store

[Source: architecture.md#Testing Strategy - Test Examples]

**Test File (tests/unit/stores/authStore.test.ts):**

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { useAuthStore } from '@/stores/authStore'
import type { UserProfile } from '@/types/firestore'

describe('authStore', () => {
  beforeEach(() => {
    // Reset store before each test
    useAuthStore.setState({
      user: null,
      isAuthenticated: false,
      isLoading: false,
    })
  })

  it('sets user and marks as authenticated', () => {
    const mockUser: UserProfile = {
      id: 'user123',
      username: 'John Manager',
      role: 'manager',
      avatarUrl: null,
      commissionRate: 0,
      createdAt: new Date(),
    }

    useAuthStore.getState().setUser(mockUser)

    const state = useAuthStore.getState()
    expect(state.user).toEqual(mockUser)
    expect(state.isAuthenticated).toBe(true)
    expect(state.isLoading).toBe(false)
  })

  it('clears user on logout', () => {
    const mockUser: UserProfile = {
      id: 'user123',
      username: 'John Manager',
      role: 'manager',
      avatarUrl: null,
      commissionRate: 0,
      createdAt: new Date(),
    }

    useAuthStore.getState().setUser(mockUser)
    expect(useAuthStore.getState().isAuthenticated).toBe(true)

    useAuthStore.getState().logout()

    const state = useAuthStore.getState()
    expect(state.user).toBeNull()
    expect(state.isAuthenticated).toBe(false)
  })

  it('persists user to localStorage', () => {
    const mockUser: UserProfile = {
      id: 'user123',
      username: 'John Manager',
      role: 'manager',
      avatarUrl: null,
      commissionRate: 0,
      createdAt: new Date(),
    }

    useAuthStore.getState().setUser(mockUser)

    const stored = localStorage.getItem('auth-storage')
    expect(stored).toBeTruthy()
    const parsed = JSON.parse(stored!)
    expect(parsed.state.user.id).toBe('user123')
  })
})
```

### Example Component Test: Login Page

[Source: architecture.md#Testing Strategy - Frontend Component Test]

**Test File (tests/component/auth/LoginPage.test.tsx):**

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { LoginPage } from '@/app/login/page';

describe('LoginPage', () => {
  it('renders Manager and Barber buttons', () => {
    render(<LoginPage />);

    expect(screen.getByText('Manager')).toBeInTheDocument();
    expect(screen.getByText('Barber')).toBeInTheDocument();
  });

  it('navigates to manager dashboard when Manager button clicked', async () => {
    const mockPush = vi.fn();
    vi.mocked(useRouter).mockReturnValue({ push: mockPush });

    render(<LoginPage />);

    fireEvent.click(screen.getByText('Manager'));

    expect(mockPush).toHaveBeenCalledWith('/manager/dashboard');
  });

  it('shows barber selection when Barber button clicked', () => {
    render(<LoginPage />);

    fireEvent.click(screen.getByText('Barber'));

    expect(screen.getByText('Select your profile')).toBeInTheDocument();
  });

  it('supports keyboard navigation', () => {
    render(<LoginPage />);

    const managerButton = screen.getByText('Manager');
    managerButton.focus();

    expect(document.activeElement).toBe(managerButton);

    fireEvent.keyDown(managerButton, { key: 'Enter' });

    // Verify navigation triggered
  });
});
```

### Example E2E Test: Manager Login Flow

[Source: architecture.md#Testing Strategy - E2E Test]

**Test File (tests/e2e/auth.spec.ts):**

```typescript
import { test, expect } from '@playwright/test'

test.describe('Authentication Flow', () => {
  test.beforeEach(async ({ page }) => {
    // Reset Firebase Emulator data
    await page.request.delete(
      'http://localhost:8080/emulator/v1/projects/salonflow-test/databases/(default)/documents'
    )
    // Seed test data
    await page.request.post('http://localhost:3000/api/test/seed')
  })

  test('Manager can log in and reach dashboard', async ({ page }) => {
    // Navigate to login page
    await page.goto('http://localhost:3000/login')

    // Verify login page loads
    await expect(page.locator('h1')).toContainText('SalonFlow')
    await expect(page.locator('text=Manager')).toBeVisible()

    // Click Manager button
    await page.click('text=Manager')

    // Verify redirect to manager dashboard
    await expect(page).toHaveURL('/manager/dashboard')

    // Verify dashboard elements
    await expect(page.locator('nav')).toBeVisible()
    await expect(page.locator('text=Dashboard')).toBeVisible()
    await expect(page.locator('text=Total Revenue')).toBeVisible()
    await expect(page.locator('text=Total Services')).toBeVisible()
    await expect(page.locator('text=Active Barbers')).toBeVisible()
  })

  test('Barber can select profile and reach dashboard', async ({ page }) => {
    await page.goto('http://localhost:3000/login')

    // Click Barber button
    await page.click('text=Barber')

    // Verify barber selection grid
    await expect(page.locator('text=Select your profile')).toBeVisible()

    // Click first barber card
    await page.locator('[aria-label*="Select barber"]').first().click()

    // Verify redirect to barber dashboard
    await expect(page).toHaveURL('/barber/dashboard')
    await expect(page.locator('text=Services Today')).toBeVisible()
    await expect(page.locator('text=Revenue Today')).toBeVisible()
  })

  test('Unauthorized users redirected from protected routes', async ({
    page,
  }) => {
    // Try to access manager dashboard without authentication
    await page.goto('http://localhost:3000/manager/dashboard')

    // Verify redirect to login
    await expect(page).toHaveURL('/login')
  })
})
```

### CI/CD Integration

[Source: architecture.md#Testing Strategy]

**GitHub Actions Workflow (.github/workflows/ci-cd.yml):**

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test
      - run: npm run build

  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npx playwright install --with-deps
      - name: Start Firebase Emulators
        run: |
          npm install -g firebase-tools
          firebase emulators:start --only firestore,auth &
          sleep 10
      - run: npm run test:e2e
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
```

### NPM Scripts

[Source: architecture.md#Testing Strategy - Test Organization]

**Package.json Scripts:**

```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:ui": "vitest --ui",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:coverage": "vitest run --coverage",
    "test:all": "npm run test && npm run test:e2e"
  }
}
```

### Testing

[Source: architecture.md#Testing Strategy]

**Validation Tests (for Story 1.10):**

- Run `npm test` - All unit/component tests pass
- Run `npm run test:coverage` - Coverage meets thresholds (80% lines)
- Run `npm run test:e2e` - E2E tests pass with emulator
- Run `npm run lint` - Linting passes
- Run `npm run type-check` - TypeScript compilation succeeds
- Verify CI pipeline runs all tests successfully

**Test Organization Validation:**

- Verify tests/unit/ directory exists with subdirectories
- Verify tests/component/ directory exists with subdirectories
- Verify tests/e2e/ directory exists
- Verify example tests written for each type

**Coverage Requirements:**

- Lines: 80% minimum
- Branches: 70% minimum
- Functions: 75% minimum
- Statements: 80% minimum

**Key Testing Principles:**

- Unit tests: Fast, isolated, no external dependencies
- Component tests: Render components with mocked dependencies
- E2E tests: Full user flows with real Firebase Emulator
- All tests run in CI pipeline before merge
- Coverage reports generated and tracked

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
