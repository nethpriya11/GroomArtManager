# Story 2.1: Service CRUD - Create Service

## Status

Draft

## Story

**As a** manager,
**I want** to add a new service to the service catalog,
**so that** barbers can log completed services and clients can be charged appropriately.

## Acceptance Criteria

1. Manager Services page created at `/manager/services` with "Add Service" button (primary amber button, top-right)
2. Clicking "Add Service" opens a modal dialog (ShadCN Dialog component, max-width 600px, centered)
3. Dialog contains form with fields: Service Name (text input), Price (number input with $ prefix), Duration (number input with "minutes" suffix)
4. Form uses React Hook Form with Zod validation schema
5. Validation: Name required (non-empty), Price required (positive number), Duration required (positive integer)
6. Inline validation errors displayed below each field in red text
7. Submit button disabled until form is valid
8. On submit: Service created in Firestore `services` collection with fields: name, price, duration, createdAt (timestamp)
9. Toast notification shown: "Service '[name]' added successfully"
10. Dialog closes automatically, service appears in grid immediately (optimistic update or real-time)

## Tasks / Subtasks

- [ ] Create Manager Services page route (AC: 1)
  - [ ] Create `/app/(auth)/manager/services/page.tsx`
  - [ ] Add page to manager navigation layout
  - [ ] Create "Add Service" button (primary amber, top-right positioning)
- [ ] Implement Add Service modal dialog (AC: 2, 3)
  - [ ] Create `ServiceFormDialog.tsx` component in `components/features/services/`
  - [ ] Implement ShadCN Dialog component (max-width 600px, centered)
  - [ ] Add form fields: Service Name (text), Price (number, $ prefix), Duration (number, "minutes" suffix)
- [ ] Set up form validation (AC: 4, 5, 6, 7)
  - [ ] Create Zod schema in `lib/validations/schemas.ts`: `createServiceSchema`
  - [ ] Integrate React Hook Form with Zod resolver
  - [ ] Implement validation: Name required (non-empty), Price positive number, Duration positive integer
  - [ ] Display inline validation errors (red text #ef4444 below fields)
  - [ ] Disable submit button until form is valid
- [ ] Implement Firestore service creation (AC: 8)
  - [ ] Create `createService()` function in `lib/services/service-management.ts`
  - [ ] Use repository pattern in `lib/firebase/repositories/service-repository.ts`
  - [ ] Add service to Firestore `services` collection with: name, price, duration, createdAt
  - [ ] Implement React Query mutation with optimistic update
- [ ] Add user feedback (AC: 9, 10)
  - [ ] Show Sonner toast: "Service '[name]' added successfully"
  - [ ] Auto-close dialog on successful submission
  - [ ] Ensure service appears in grid immediately (real-time listener or optimistic update)

## Dev Notes

### Service Data Model

[Source: architecture.md#Data Models - Service]

```typescript
interface Service {
  id: string
  name: string
  price: number // Dollars (e.g., 25.00)
  duration: number // Minutes
  createdAt: Firestore.Timestamp
}
```

### Form Validation Schema

[Source: architecture.md#Coding Standards - Form Validation]

All forms must use React Hook Form + Zod schemas. Create validation schema in `lib/validations/schemas.ts`:

```typescript
import { z } from 'zod'

export const createServiceSchema = z.object({
  name: z.string().min(1, 'Service name is required'),
  price: z.number().positive('Price must be a positive number'),
  duration: z.number().int().positive('Duration must be a positive integer'),
})

export type CreateServiceInput = z.infer<typeof createServiceSchema>
```

### Repository Pattern

[Source: architecture.md#Components - Repository Pattern]

Abstract Firestore operations behind service layer functions. Create in `lib/firebase/repositories/service-repository.ts`:

```typescript
import { collection, addDoc, Timestamp } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'
import type { Service } from '@/types/firestore'

export async function createService(
  data: Omit<Service, 'id' | 'createdAt'>
): Promise<Service> {
  const docRef = await addDoc(collection(db, 'services'), {
    ...data,
    createdAt: Timestamp.now(),
  })
  return { id: docRef.id, ...data, createdAt: Timestamp.now() }
}
```

### React Query Mutation

[Source: architecture.md#Architectural Patterns - Optimistic UI Updates]

Implement optimistic updates with automatic rollback on failure:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'

const queryClient = useQueryClient()
const createServiceMutation = useMutation({
  mutationFn: createService,
  onMutate: async (newService) => {
    // Optimistic update
    await queryClient.cancelQueries(['services'])
    const previous = queryClient.getQueryData(['services'])
    queryClient.setQueryData(['services'], (old) => [...old, newService])
    return { previous }
  },
  onError: (err, newService, context) => {
    // Rollback on error
    queryClient.setQueryData(['services'], context.previous)
  },
  onSettled: () => {
    queryClient.invalidateQueries(['services'])
  },
})
```

### UI Component Structure

[Source: architecture.md#Unified Project Structure]

File locations:

- Page: `app/(auth)/manager/services/page.tsx`
- Dialog component: `components/features/services/ServiceFormDialog.tsx`
- Repository: `lib/firebase/repositories/service-repository.ts`
- Validation: `lib/validations/schemas.ts`
- Types: `types/firestore.ts`

### Styling Requirements

[Source: Epic 2 AC]

- Primary button: Amber color (#f59e0b from Tailwind config)
- Dialog: max-width 600px, centered
- Validation errors: Red text (#ef4444), displayed below each field
- Form fields: Use ShadCN Input components with proper labels

### Testing

#### Unit Tests

[Source: architecture.md#Testing Strategy]

**Validation Schema Test** (`tests/unit/validations/schemas.test.ts`):

- Test valid service input passes validation
- Test empty name fails with "Service name is required"
- Test negative price fails with "Price must be a positive number"
- Test non-integer duration fails with "Duration must be a positive integer"
- Test zero values fail validation

**Repository Test** (`tests/unit/repositories/service-repository.test.ts`):

- Mock Firestore `addDoc` function
- Test createService returns service with generated ID
- Test createService includes createdAt timestamp
- Test createService throws error on Firestore failure

#### Component Tests

[Source: architecture.md#Testing Strategy]

**ServiceFormDialog Test** (`tests/component/services/ServiceForm.test.tsx`):

- Test form renders with all fields (name, price, duration)
- Test submit button disabled when form is invalid
- Test submit button enabled when form is valid
- Test validation errors display on blur/submit
- Test successful submission calls mutation and shows toast
- Test dialog closes after successful submission
- Test form resets after submission

#### E2E Tests

[Source: architecture.md#Testing Strategy]

**Service Management E2E** (`tests/e2e/service-management.spec.ts`):

- Test manager can navigate to /manager/services
- Test clicking "Add Service" button opens modal
- Test entering valid data and submitting creates service
- Test toast notification appears with service name
- Test new service appears in grid immediately
- Test form validation prevents submission with invalid data

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
