# Story 4.6: Date Range Filtering

## Status

Draft

## Story

**As a** manager,
**I want** to filter all reports by custom date ranges,
**so that** I can analyze specific time periods (weekly, monthly, quarterly).

## Acceptance Criteria

1. Date range picker prominently displayed at top of reports page
2. Clicking picker opens calendar overlay (ShadCN DateRangePicker)
3. User can select start and end dates visually
4. Preset buttons: "Today" (00:00-23:59 today), "Last 7 Days", "Last 30 Days", "This Month", "Last Month", "Custom"
5. Clicking preset instantly applies filter to all report sections
6. Custom range: User clicks two dates in calendar to set range
7. Selected range displayed in picker input: "MM/DD/YYYY - MM/DD/YYYY"
8. "Clear" button resets to default (Last 30 Days)
9. Date range persists in URL query params (?from=2025-10-01&to=2025-10-31) for shareable links
10. All queries (KPIs, leaderboards, ledger) filter by: `createdAt >= startDate AND createdAt <= endDate`

## Tasks / Subtasks

- [ ] Install and configure ShadCN DateRangePicker component (AC: 1, 2)
  - [ ] Add ShadCN Calendar and Popover components
  - [ ] Create DateRangePicker component in components/ui/
  - [ ] Style with dark theme (#1a1a1a background, #f59e0b accents)
- [ ] Implement preset date range buttons (AC: 4, 5)
  - [ ] Create preset button group: Today, Last 7 Days, Last 30 Days, This Month, Last Month, Custom
  - [ ] Calculate date ranges using date-fns (startOfDay, endOfDay, subDays, startOfMonth, endOfMonth)
  - [ ] Apply filters instantly on preset click
- [ ] Implement custom date range selection (AC: 3, 6, 7)
  - [ ] Allow user to visually select start and end dates in calendar overlay
  - [ ] Display selected range in input: "MM/DD/YYYY - MM/DD/YYYY" format
  - [ ] Validate end date is not before start date
- [ ] Add Clear button functionality (AC: 8)
  - [ ] Reset to default "Last 30 Days" on clear
  - [ ] Update all report sections on clear
- [ ] Implement URL query param persistence (AC: 9)
  - [ ] Store date range in URL: ?from=YYYY-MM-DD&to=YYYY-MM-DD
  - [ ] Parse query params on page load to restore date range
  - [ ] Update URL when date range changes (using Next.js router.push with shallow routing)
- [ ] Apply date range filter to all queries (AC: 10)
  - [ ] Filter KPI calculations by createdAt >= startDate AND createdAt <= endDate
  - [ ] Filter leaderboards (Top Barbers, Top Services) by date range
  - [ ] Filter financial ledger table by date range
  - [ ] Use Firestore where() clauses for date filtering

## Dev Notes

### Date Range Component Implementation

[Source: architecture.md#Components - ShadCN UI]

**Component Structure:**

```
components/
├── ui/
│   ├── calendar.tsx          # ShadCN Calendar component
│   ├── popover.tsx           # ShadCN Popover component
│   └── date-range-picker.tsx # Custom DateRangePicker wrapper
└── features/
    └── reports/
        └── DateRangeFilter.tsx # Reports page date filter with presets
```

**Date Handling:**

- Use date-fns for all date operations [Source: architecture.md#Coding Standards]
- Convert between JS Date objects and Firestore Timestamps
- Ensure timezone consistency (use local time for display, UTC for storage)

**Preset Calculations:**

```typescript
import { startOfDay, endOfDay, subDays, startOfMonth, endOfMonth, subMonths } from 'date-fns';

// Today: 00:00:00 to 23:59:59 today
{ from: startOfDay(new Date()), to: endOfDay(new Date()) }

// Last 7 Days: 7 days ago to today
{ from: startOfDay(subDays(new Date(), 7)), to: endOfDay(new Date()) }

// Last 30 Days: 30 days ago to today (default)
{ from: startOfDay(subDays(new Date(), 30)), to: endOfDay(new Date()) }

// This Month: First day of current month to today
{ from: startOfMonth(new Date()), to: endOfDay(new Date()) }

// Last Month: First to last day of previous month
{ from: startOfMonth(subMonths(new Date(), 1)), to: endOfMonth(subMonths(new Date(), 1)) }
```

### URL Query Parameter Management

[Source: architecture.md#Next.js App Router]

**Implementation Pattern:**

```typescript
import { useRouter, useSearchParams } from 'next/navigation'

function DateRangeFilter() {
  const router = useRouter()
  const searchParams = useSearchParams()

  const updateDateRange = (from: Date, to: Date) => {
    const params = new URLSearchParams(searchParams)
    params.set('from', format(from, 'yyyy-MM-dd'))
    params.set('to', format(to, 'yyyy-MM-dd'))
    router.push(`?${params.toString()}`, { shallow: true }) // Shallow routing prevents full page reload
  }
}
```

**Query Param Format:**

- Use ISO 8601 date format: YYYY-MM-DD (e.g., ?from=2025-10-01&to=2025-10-31)
- Parse on mount to restore state from shareable URL
- Validate dates exist and from <= to before applying

### Firestore Date Range Queries

[Source: architecture.md#Data Models - ServiceLog]

**Query Pattern:**

```typescript
import { collection, query, where, Timestamp } from 'firebase/firestore'

const startTimestamp = Timestamp.fromDate(startOfDay(fromDate))
const endTimestamp = Timestamp.fromDate(endOfDay(toDate))

const logsQuery = query(
  collection(db, 'serviceLogs'),
  where('status', '==', 'approved'),
  where('createdAt', '>=', startTimestamp),
  where('createdAt', '<=', endTimestamp)
)
```

**Index Requirements:**

- Composite index: status + createdAt (ascending)
- Defined in firestore.indexes.json
- Firestore will prompt to create index on first query if missing

### State Management

[Source: architecture.md#State Management - Zustand]

**Option 1: React State (Recommended for MVP)**

```typescript
const [dateRange, setDateRange] = useState<DateRange>({
  from: subDays(new Date(), 30),
  to: new Date(),
})
```

**Option 2: Zustand Store (if shared across multiple pages)**

```typescript
// stores/reportStore.ts
interface ReportStore {
  dateRange: DateRange
  setDateRange: (range: DateRange) => void
}
```

### Testing

#### Unit Tests

[Source: architecture.md#Testing Strategy - Frontend Unit Tests]

**Test File:** `tests/unit/utils/date-helpers.test.ts`

**Test Cases:**

```typescript
describe('Date Range Presets', () => {
  it('calculates Today preset correctly (00:00 to 23:59)', () => {
    const range = getPresetRange('today')
    expect(range.from.getHours()).toBe(0)
    expect(range.to.getHours()).toBe(23)
  })

  it('calculates Last 7 Days preset correctly', () => {
    const range = getPresetRange('last7Days')
    const expectedFrom = subDays(startOfDay(new Date()), 7)
    expect(range.from).toEqual(expectedFrom)
  })

  it('calculates This Month preset correctly', () => {
    const range = getPresetRange('thisMonth')
    expect(range.from).toEqual(startOfMonth(new Date()))
  })
})

describe('Date Range URL Params', () => {
  it('serializes date range to query params', () => {
    const from = new Date('2025-10-01')
    const to = new Date('2025-10-31')
    const params = serializeDateRange({ from, to })
    expect(params).toBe('from=2025-10-01&to=2025-10-31')
  })

  it('parses date range from query params', () => {
    const params = new URLSearchParams('from=2025-10-01&to=2025-10-31')
    const range = parseDateRange(params)
    expect(range.from).toEqual(new Date('2025-10-01'))
    expect(range.to).toEqual(new Date('2025-10-31'))
  })

  it('returns default range if query params invalid', () => {
    const params = new URLSearchParams('from=invalid')
    const range = parseDateRange(params)
    expect(range).toEqual(getDefaultDateRange()) // Last 30 Days
  })
})
```

#### Component Tests

[Source: architecture.md#Testing Strategy - Component Tests]

**Test File:** `tests/component/reports/DateRangeFilter.test.tsx`

**Test Cases:**

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { DateRangeFilter } from '@/components/features/reports/DateRangeFilter';

describe('DateRangeFilter', () => {
  it('renders with default Last 30 Days preset selected', () => {
    render(<DateRangeFilter />);
    expect(screen.getByText('Last 30 Days')).toHaveClass('bg-primary');
  });

  it('displays selected date range in input', () => {
    render(<DateRangeFilter />);
    const input = screen.getByPlaceholderText(/select date range/i);
    expect(input).toHaveValue(/\d{2}\/\d{2}\/\d{4} - \d{2}\/\d{2}\/\d{4}/);
  });

  it('applies Today preset when clicked', () => {
    const onChange = vi.fn();
    render(<DateRangeFilter onChange={onChange} />);

    fireEvent.click(screen.getByText('Today'));

    expect(onChange).toHaveBeenCalledWith(expect.objectContaining({
      from: expect.any(Date),
      to: expect.any(Date)
    }));

    const { from, to } = onChange.mock.calls[0][0];
    expect(from.getDate()).toBe(new Date().getDate());
    expect(to.getDate()).toBe(new Date().getDate());
  });

  it('opens calendar overlay when input clicked', () => {
    render(<DateRangeFilter />);
    fireEvent.click(screen.getByPlaceholderText(/select date range/i));
    expect(screen.getByRole('dialog')).toBeVisible();
  });

  it('resets to default when Clear button clicked', () => {
    const onChange = vi.fn();
    render(<DateRangeFilter onChange={onChange} />);

    fireEvent.click(screen.getByText('Clear'));

    expect(onChange).toHaveBeenCalledWith(expect.objectContaining({
      from: expect.any(Date),
      to: expect.any(Date)
    }));
  });
});
```

#### E2E Tests

[Source: architecture.md#Testing Strategy - E2E Tests]

**Test File:** `tests/e2e/reports.spec.ts`

**Test Cases:**

```typescript
import { test, expect } from '@playwright/test'

test.describe('Date Range Filtering', () => {
  test.beforeEach(async ({ page }) => {
    // Login as manager and navigate to reports page
    await page.goto('/login')
    await page.click('text=Manager')
    await page.goto('/manager/reports')
  })

  test('applies Last 7 Days preset and filters all report sections', async ({
    page,
  }) => {
    await page.click('text=Last 7 Days')

    // Verify URL updated
    await expect(page).toHaveURL(/from=\d{4}-\d{2}-\d{2}&to=\d{4}-\d{2}-\d{2}/)

    // Verify KPI cards update (check Total Revenue is visible, not testing exact value)
    await expect(page.locator('text=Total Revenue').locator('..')).toBeVisible()

    // Verify leaderboards filter (check tables have data or empty state)
    await expect(page.locator('text=Top Barbers').locator('..')).toBeVisible()
  })

  test('allows custom date range selection via calendar', async ({ page }) => {
    // Open calendar
    await page.click('[placeholder*="Select date range"]')

    // Select start date (first day of current month)
    await page.click('button[name="day"]:has-text("1")')

    // Select end date (today)
    const today = new Date().getDate().toString()
    await page.click(`button[name="day"]:has-text("${today}")`)

    // Verify date range applied
    await expect(page.locator('text=Total Revenue')).toBeVisible()
  })

  test('persists date range in URL for shareable links', async ({ page }) => {
    await page.click('text=Last 7 Days')

    // Get current URL
    const url = page.url()
    expect(url).toContain('from=')
    expect(url).toContain('to=')

    // Reload page
    await page.reload()

    // Verify date range persists
    await expect(page.locator('text=Last 7 Days')).toHaveClass(/bg-primary/)
  })

  test('clears date range and resets to default', async ({ page }) => {
    // Change to Today
    await page.click('text=Today')
    await expect(page).toHaveURL(/from=/)

    // Clear
    await page.click('text=Clear')

    // Verify reset to Last 30 Days
    await expect(page.locator('text=Last 30 Days')).toHaveClass(/bg-primary/)
  })
})
```

#### Integration Tests

**Test that date range filter affects:**

- KPI calculations (Total Revenue, Total Commissions, Net Profit)
- Top Barbers leaderboard aggregation
- Top Services leaderboard aggregation
- Financial Ledger table rows
- Real-time updates (new logs within range appear, outside range hidden)

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
