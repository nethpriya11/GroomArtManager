# Story 3.3: Barber Service Log History Table

## Status

Draft

## Story

**As a** barber,
**I want** to see all my logged services with their approval status,
**so that** I can track which services have been approved and what my earnings are.

## Acceptance Criteria

1. "My Logged Services" table on barber dashboard displays all service logs where `barberId` equals current user
2. Table columns: Service (name), Price ($XX.XX), Date (MM/DD/YYYY HH:MM), Status (badge with icon+text)
3. Status badges: Pending (⏱️ amber), Approved (✓ green), Rejected (✗ red)
4. Table sorted by createdAt descending (newest first)
5. Real-time updates: Status changes from pending → approved/rejected reflect instantly
6. Pagination appears if >100 rows (page size: 50)
7. Sortable columns: Click column header to sort by that column (date, price)
8. Empty state: "No services logged yet. Start by logging a service above."
9. Mobile responsive: Table scrolls horizontally, or columns stack vertically
10. Table uses ShadCN Table component with striped rows (#1a1a1a / #141414 alternating)

## Tasks / Subtasks

- [ ] Create ServiceLogTable component (AC: 1, 2, 10)
  - [ ] Build ServiceLogTable in `components/features/service-logs/ServiceLogTable.tsx`
  - [ ] Use ShadCN Table component with striped rows (#1a1a1a / #141414 alternating)
  - [ ] Define table columns: Service, Price, Date, Status
  - [ ] Use dark theme styling (#1a1a1a background)
- [ ] Implement real-time service logs query (AC: 1, 5)
  - [ ] Create useServiceLogs hook in `hooks/useServiceLogs.ts`
  - [ ] Query serviceLogs collection where barberId equals current user
  - [ ] Use onSnapshot listener wrapped in React Query
  - [ ] Sort by createdAt descending (newest first)
  - [ ] Apply Firestore composite index: barberId (ASC), createdAt (DESC)
- [ ] Create status badge component (AC: 3)
  - [ ] Build StatusBadge component or use ShadCN Badge
  - [ ] Pending: amber badge with clock icon (⏱️)
  - [ ] Approved: green badge with checkmark icon (✓)
  - [ ] Rejected: red badge with X icon (✗)
  - [ ] Use Tailwind color classes and lucide-react icons
- [ ] Implement service name fetching (AC: 2)
  - [ ] Fetch service document via serviceId reference
  - [ ] Display service name in table (not just serviceId)
  - [ ] Handle loading state while fetching service details
  - [ ] Cache service data in React Query to avoid duplicate fetches
- [ ] Add date formatting (AC: 2)
  - [ ] Use date-fns to format createdAt timestamp
  - [ ] Format: MM/DD/YYYY HH:MM
  - [ ] Handle Firestore Timestamp to JS Date conversion
- [ ] Add price formatting (AC: 2)
  - [ ] Format price as currency: $XX.XX
  - [ ] Create formatCurrency utility function
- [ ] Implement table sorting (AC: 7)
  - [ ] Add click handlers to column headers (date, price)
  - [ ] Toggle sort order: ascending/descending
  - [ ] Maintain sort state with useState
  - [ ] Apply sort to Firestore query or client-side
- [ ] Add pagination (AC: 6)
  - [ ] Show pagination controls if >100 rows
  - [ ] Page size: 50 rows per page
  - [ ] Use Firestore query limit and startAfter for pagination
  - [ ] Display page numbers and previous/next buttons
- [ ] Add empty state (AC: 8)
  - [ ] Show empty state component when no logs exist
  - [ ] Message: "No services logged yet. Start by logging a service above."
  - [ ] Use ShadCN Card or custom EmptyState component
- [ ] Implement mobile responsive design (AC: 9)
  - [ ] Enable horizontal scrolling for table on mobile
  - [ ] Or stack columns vertically on small screens
  - [ ] Ensure touch targets meet 44x44px minimum
- [ ] Integrate into Barber Dashboard (AC: 1)
  - [ ] Add "My Logged Services" section to barber dashboard
  - [ ] Import and render ServiceLogTable component
  - [ ] Pass current user's barberId to table

## Dev Notes

### ServiceLog Data Query

[Source: architecture.md#Database Schema]

Real-time query for barber's service logs:

```typescript
// hooks/useServiceLogs.ts
import { useRealtimeQuery } from '@/hooks/useRealtimeQuery'
import { collection, query, where, orderBy } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export function useServiceLogs(barberId: string) {
  return useRealtimeQuery<ServiceLog>(
    ['serviceLogs', barberId],
    query(
      collection(db, 'serviceLogs'),
      where('barberId', '==', barberId),
      orderBy('createdAt', 'desc')
    )
  )
}
```

**Firestore Index Required:**

- Collection: `serviceLogs`
- Fields: `barberId` (ASC), `createdAt` (DESC)
- Add to `firestore.indexes.json`

### Table Component Structure

[Source: architecture.md#Component Template]

Use ShadCN Table component with custom styling:

```typescript
// components/features/service-logs/ServiceLogTable.tsx
import { Table, TableHeader, TableBody, TableRow, TableHead, TableCell } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { useServiceLogs } from '@/hooks/useServiceLogs';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';

export function ServiceLogTable({ barberId }: { barberId: string }) {
  const { data: logs, isLoading } = useServiceLogs(barberId);

  if (isLoading) return <SkeletonTable />;
  if (!logs || logs.length === 0) return <EmptyState />;

  return (
    <Table className="w-full">
      <TableHeader>
        <TableRow>
          <TableHead>Service</TableHead>
          <TableHead onClick={() => handleSort('price')}>Price</TableHead>
          <TableHead onClick={() => handleSort('date')}>Date</TableHead>
          <TableHead>Status</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {logs.map((log, index) => (
          <TableRow
            key={log.id}
            className={index % 2 === 0 ? 'bg-[#1a1a1a]' : 'bg-[#141414]'}
          >
            <TableCell>{getServiceName(log.serviceId)}</TableCell>
            <TableCell>{formatCurrency(log.price)}</TableCell>
            <TableCell>{formatDate(log.createdAt)}</TableCell>
            <TableCell><StatusBadge status={log.status} /></TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}
```

### Status Badge Component

[Source: architecture.md#Technology Stack]

```typescript
// components/features/service-logs/StatusBadge.tsx
import { Badge } from '@/components/ui/badge';
import { Clock, Check, X } from 'lucide-react';

export function StatusBadge({ status }: { status: 'pending' | 'approved' | 'rejected' }) {
  const variants = {
    pending: { icon: Clock, className: 'bg-amber-500/20 text-amber-500', label: 'Pending' },
    approved: { icon: Check, className: 'bg-green-500/20 text-green-500', label: 'Approved' },
    rejected: { icon: X, className: 'bg-red-500/20 text-red-500', label: 'Rejected' },
  };

  const { icon: Icon, className, label } = variants[status];

  return (
    <Badge className={className}>
      <Icon className="h-3 w-3 mr-1" />
      {label}
    </Badge>
  );
}
```

### Date and Currency Formatting

[Source: architecture.md#Coding Standards]

```typescript
// lib/utils/formatters.ts
import { format } from 'date-fns'
import { Timestamp } from 'firebase/firestore'

export function formatDate(timestamp: Timestamp): string {
  const date = timestamp.toDate()
  return format(date, 'MM/dd/yyyy HH:mm')
}

export function formatCurrency(amount: number): string {
  return `$${amount.toFixed(2)}`
}
```

### Service Name Fetching

[Source: architecture.md#Real-time Sync Engine]

Fetch service names via serviceId reference. Use React Query to cache service data:

```typescript
// hooks/useService.ts
import { useQuery } from '@tanstack/react-query';
import { doc, getDoc } from 'firebase/firestore';
import { db } from '@/lib/firebase/config';

export function useService(serviceId: string) {
  return useQuery({
    queryKey: ['service', serviceId],
    queryFn: async () => {
      const serviceDoc = await getDoc(doc(db, 'services', serviceId));
      return { id: serviceDoc.id, ...serviceDoc.data() } as Service;
    },
    staleTime: Infinity, // Services rarely change
  });
}

// In table component:
function ServiceNameCell({ serviceId }: { serviceId: string }) {
  const { data: service, isLoading } = useService(serviceId);
  if (isLoading) return <span>Loading...</span>;
  return <span>{service?.name}</span>;
}
```

### Real-time Updates

[Source: architecture.md#Real-time Sync Engine]

Table automatically updates when:

- Barber logs new services (new rows appear)
- Manager approves/rejects logs (status badge changes)
- No manual refresh required (onSnapshot listener)

Target latency: <2 seconds for status changes to reflect.

### Pagination Implementation

[Source: architecture.md#Database Schema]

Use Firestore pagination with limit and startAfter:

```typescript
const [lastDoc, setLastDoc] = useState<DocumentSnapshot | null>(null)

// First page
const firstPageQuery = query(
  collection(db, 'serviceLogs'),
  where('barberId', '==', barberId),
  orderBy('createdAt', 'desc'),
  limit(50)
)

// Next page
const nextPageQuery = query(
  collection(db, 'serviceLogs'),
  where('barberId', '==', barberId),
  orderBy('createdAt', 'desc'),
  startAfter(lastDoc),
  limit(50)
)
```

### Mobile Responsive Design

[Source: architecture.md#Technology Stack]

**Option 1: Horizontal Scroll**

```jsx
<div className="overflow-x-auto">
  <Table className="min-w-full" />
</div>
```

**Option 2: Vertical Stacking**

```jsx
<div className="md:hidden">
  {logs.map(log => (
    <Card key={log.id}>
      <div>Service: {service.name}</div>
      <div>Price: {formatCurrency(log.price)}</div>
      <div>Date: {formatDate(log.createdAt)}</div>
      <div>Status: <StatusBadge status={log.status} /></div>
    </Card>
  ))}
</div>
<div className="hidden md:block">
  <Table /> {/* Desktop table */}
</div>
```

### Testing

[Source: architecture.md#Testing Strategy]

**Component Tests (React Testing Library):**

- Test table renders service logs correctly
- Test status badges display correct colors and icons
- Test date and price formatting
- Test empty state when no logs exist
- Test service name fetching and display
- Test sorting functionality (date, price columns)

**E2E Tests (Playwright):**

- Test barber sees logged services in table
- Test real-time status update (pending → approved)
- Test table sorted by newest first
- Test pagination appears when >100 rows
- Test mobile responsive layout (horizontal scroll or vertical stack)
- Test empty state message when no logs exist

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
