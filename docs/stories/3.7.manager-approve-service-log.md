# Story 3.7: Manager Approve Service Log

## Status

Draft

## Story

**As a** manager,
**I want** to approve a pending service log with one click,
**so that** it counts toward revenue and the barber's commission is confirmed.

## Acceptance Criteria

1. Clicking ✓ (approve) icon button immediately updates service log status to 'approved'
2. Service log document updated in Firestore: status: 'approved', approvedAt: timestamp
3. Optimistic UI update: Row disappears from "Pending Approvals" table instantly
4. Toast notification: "Service log approved"
5. Real-time: Barber's dashboard updates instantly (status badge changes to "Approved", daily stats increase)
6. Approved log contributes to: Total Revenue (manager KPIs), Barber's daily stats, Leaderboards
7. Commission amount already calculated and stored in service log (no recalculation needed)
8. If update fails: Optimistic update rolled back, error toast shown
9. Approved logs cannot be un-approved (status change is permanent)
10. Security rule enforced: Only users with role 'manager' can set status to 'approved'

## Tasks / Subtasks

- [ ] Create approveServiceLog service function (AC: 1, 2)
  - [ ] Implement in lib/services/approval-service.ts
  - [ ] Use Firestore updateDoc() to update status and approvedAt
  - [ ] Set status: 'approved', approvedAt: serverTimestamp()
  - [ ] Export function: approveServiceLog(logId: string): Promise<void>
- [ ] Create approve mutation with optimistic updates (AC: 3, 8)
  - [ ] Use React Query useMutation hook
  - [ ] Configure onMutate: Cancel queries, snapshot previous state
  - [ ] Optimistically remove log from pending queue
  - [ ] Configure onError: Rollback optimistic update, show error toast
  - [ ] Configure onSuccess: Show success toast
- [ ] Add approve button to PendingApprovalsTable (AC: 1)
  - [ ] Use green checkmark icon (Check from Lucide React)
  - [ ] Wire up onClick to call approve mutation
  - [ ] Pass logId to mutation function
  - [ ] Apply green styling for approve action
- [ ] Implement success toast notification (AC: 4)
  - [ ] Use Sonner toast library
  - [ ] Display message: "Service log approved"
  - [ ] Show toast immediately after optimistic update
  - [ ] Use success variant (green indicator)
- [ ] Verify real-time barber dashboard updates (AC: 5)
  - [ ] Barber's ServiceLogTable uses onSnapshot listener
  - [ ] Status badge updates from "Pending" to "Approved"
  - [ ] Daily stats recalculate automatically (approved logs counted)
  - [ ] Updates appear within 2 seconds
- [ ] Ensure commission calculation not recalculated (AC: 7)
  - [ ] Verify commissionAmount already stored in ServiceLog
  - [ ] Approval only updates status and timestamp fields
  - [ ] No recalculation logic in approve function
  - [ ] Historical values preserved (price, commissionRate, commissionAmount)
- [ ] Verify manager KPI and leaderboard integration (AC: 6)
  - [ ] KPI queries filter by status='approved'
  - [ ] Leaderboard queries filter by status='approved'
  - [ ] Real-time updates trigger KPI recalculation
  - [ ] Test that approved log contributes to totals
- [ ] Implement permanent status change (AC: 9)
  - [ ] No UI for un-approving logs
  - [ ] Security rules prevent status change from 'approved' to other states
  - [ ] Document in comments that status change is permanent
- [ ] Verify security rules enforcement (AC: 10)
  - [ ] Firestore rule: Only managers can update status to 'approved'
  - [ ] Rule: isManager() && affectedKeys hasOnly ['status', 'approvedAt', 'rejectedAt']
  - [ ] Test that barbers cannot approve logs
  - [ ] Test that only status/timestamp fields can be updated

## Dev Notes

### Service Layer Implementation

[Source: architecture.md#Approval Workflow Service]

**approveServiceLog Function:**

```typescript
// lib/services/approval-service.ts
import { doc, updateDoc, serverTimestamp } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export async function approveServiceLog(logId: string): Promise<void> {
  const logRef = doc(db, 'serviceLogs', logId)
  await updateDoc(logRef, {
    status: 'approved',
    approvedAt: serverTimestamp(),
  })
}
```

**Key Design Decisions:**

- Only updates `status` and `approvedAt` fields (AC 2)
- Does not modify `price`, `commissionRate`, or `commissionAmount` (AC 7)
- Uses Firestore `serverTimestamp()` for consistency across clients
- Throws error if Firestore update fails (caught by React Query)

### Optimistic UI Pattern

[Source: architecture.md#Optimistic UI Updates Pattern]

**React Query Mutation Configuration:**

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { toast } from 'sonner'

export function useApproveLog() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: approveServiceLog,
    onMutate: async (logId) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['serviceLogs', 'pending'] })

      // Snapshot previous value
      const previousLogs = queryClient.getQueryData(['serviceLogs', 'pending'])

      // Optimistically remove from pending queue
      queryClient.setQueryData(
        ['serviceLogs', 'pending'],
        (old: ServiceLog[]) => old?.filter((log) => log.id !== logId) ?? []
      )

      return { previousLogs }
    },
    onError: (err, logId, context) => {
      // Rollback on error
      queryClient.setQueryData(
        ['serviceLogs', 'pending'],
        context?.previousLogs
      )
      toast.error('Failed to approve service log. Please try again.')
    },
    onSuccess: () => {
      toast.success('Service log approved')
    },
  })
}
```

**Optimistic Update Flow (AC 3):**

1. Manager clicks approve button
2. Row disappears from pending table instantly (optimistic)
3. Firestore update sent in background
4. If success: No action needed (already updated)
5. If failure: Row reappears (rollback), error toast shown

### Real-time Synchronization

[Source: architecture.md#Core Workflows - Workflow 1]

**Barber Dashboard Updates (AC 5):**
When manager approves a log:

1. Manager's browser updates Firestore: `status='approved', approvedAt=timestamp`
2. Firestore triggers onSnapshot listener in barber's browser
3. React Query cache updates with new status
4. Barber's ServiceLogTable re-renders:
   - Status badge changes from "Pending" (amber) to "Approved" (green)
   - Row may pulse/highlight to indicate status change (animation)
5. Barber's daily stats query recalculates:
   - Query filters `status='approved' && createdAt=today`
   - Count and revenue totals increase
   - KPI cards update with new values

**Latency:** <2 seconds from approval action to barber visibility (per NFR)

### Data Integrity & Immutability

[Source: architecture.md#ServiceLog Data Model]

**Snapshotted Fields (AC 7):**
The ServiceLog stores snapshots of price and commission at logging time:

```typescript
{
  price: 25.00,              // Snapshot from service
  commissionRate: 0.45,       // Snapshot from barber profile
  commissionAmount: 11.25,    // Calculated: price × rate
}
```

**Why No Recalculation:**

- If service price changes after logging, existing logs retain original price
- If barber commission rate changes, existing logs retain original rate
- This ensures historical accuracy for payroll and financial reporting
- Approval process does not modify these fields (only status/timestamp)

### Security Rules Enforcement

[Source: architecture.md#Firestore Security Rules]

**Manager Approval Permission (AC 10):**

```javascript
// serviceLogs collection
allow update: if isManager()
  && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'approvedAt', 'rejectedAt']);
```

**Rule Breakdown:**

1. `isManager()` - User must have `role='manager'` custom claim
2. `affectedKeys().hasOnly([...])` - Only status/timestamp fields can be changed
3. This prevents managers from modifying price, commission, or other immutable fields
4. Barbers cannot update logs (no update rule for barbers)

### Manager KPI Integration

[Source: architecture.md#Reporting & Analytics Service]

**Manager KPIs (AC 6):**
Approved logs contribute to:

1. **Total Revenue:** Sum of `price` for all approved logs
2. **Total Services:** Count of approved logs
3. **Active Barbers:** Count of unique barberIds with approved logs

**KPI Query Example:**

```typescript
// Filters by status='approved'
const approvedLogsQuery = query(
  collection(db, 'serviceLogs'),
  where('status', '==', 'approved')
)
```

**Leaderboards (AC 6):**

1. **Top Barbers:** Group approved logs by barberId, sum commissionAmount
2. **Top Services:** Group approved logs by serviceId, count occurrences

All leaderboard queries filter by `status='approved'` to exclude pending/rejected logs.

### Permanent Status Change

[Source: Epic 3 AC 9]

**Design Decision:**

- Once approved, logs cannot be un-approved (AC 9)
- No "Undo" or "Revert" functionality in UI
- Permanent status ensures data integrity for financial reporting
- If approval was a mistake, manager can create compensating entry or manual adjustment (future feature)

### Testing

[Source: architecture.md#Testing Strategy]

**Unit Tests (Vitest):**

- `tests/unit/services/approval-service.test.ts`
  - Test `approveServiceLog()` calls updateDoc with correct log ID
  - Verify updates status='approved' and approvedAt=timestamp
  - Mock Firestore SDK
  - Test error handling when update fails

**Component Tests (React Testing Library):**

- `tests/component/service-logs/PendingApprovalsTable.test.tsx`
  - Render table with pending logs
  - Click approve button on a log
  - Verify mutation called with correct log ID
  - Verify row disappears immediately (optimistic update)
  - Verify success toast shown: "Service log approved"
  - Mock Firestore error - verify row reappears, error toast shown
  - Verify approve button styled green (checkmark icon)

**Integration Tests:**

- `tests/component/dashboard/ManagerDashboard.test.tsx`
  - Approve pending log from dashboard
  - Verify log removed from pending queue
  - Verify manager KPIs update (total revenue increases)
- `tests/component/dashboard/BarberDashboard.test.tsx`
  - Mock approved log update
  - Verify barber's table status badge changes to "Approved"
  - Verify barber's daily stats increase

**E2E Tests (Playwright):**

- `tests/e2e/approval-workflow/approve-log.spec.ts`
  - As barber, log a service
  - As manager, open dashboard
  - Verify pending log appears in table
  - Click approve button
  - Verify row disappears from pending table
  - Verify toast notification: "Service log approved"
  - As barber, refresh dashboard
  - Verify log shows "Approved" status in barber's table
  - Verify barber's daily stats increased (count +1, revenue +$X.XX)
  - Verify Firestore document updated: status='approved', approvedAt exists
  - Attempt to approve same log again - verify no approve button (not in pending queue)

**Real-time Sync E2E Test:**

- Open manager and barber dashboards in separate browser contexts
- Barber logs service
- Manager approves service (without refresh)
- Verify barber dashboard updates in <2 seconds without refresh
- Verify status badge changes, daily stats update

**Security Tests:**

- `tests/security/firestore-rules.test.ts`
  - Test manager can approve pending log (should succeed)
  - Test barber cannot approve log (should fail with permission error)
  - Test manager cannot modify price during approval (should fail)
  - Test manager cannot modify commissionAmount during approval (should fail)
  - Test approved log cannot be un-approved (no rule allows status change from approved)

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
