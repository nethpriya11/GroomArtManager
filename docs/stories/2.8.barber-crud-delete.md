# Story 2.8: Barber CRUD - Delete Barber Profile

## Status

Draft

## Story

**As a** manager,
**I want** to remove a barber from the team,
**so that** former employees can no longer access the system.

## Acceptance Criteria

1. Clicking "Delete" in barber card dropdown shows confirmation dialog
2. Confirmation dialog: "Are you sure you want to delete '[username]'? They will no longer be able to log in. Their historical service logs will be retained."
3. Confirmation has "Cancel" and "Delete" (destructive) buttons
4. On confirm: Barber user document deleted from Firestore `users` collection
5. Firebase Auth user disabled (not deleted) to preserve authentication history
6. Custom claim removed or account disabled
7. Barber cannot log in after deletion (redirect to login with error message)
8. Historical service logs retained (barberId remains in serviceLogs for reporting)
9. Toast notification: "Barber '[username]' removed successfully"
10. Barber card disappears from grid immediately

## Tasks / Subtasks

- [ ] Create DeleteBarberConfirmation component (AC: 1, 2, 3)
  - [ ] Create components/features/barbers/DeleteBarberConfirmation.tsx
  - [ ] Use ShadCN AlertDialog component for confirmation
  - [ ] Set confirmation message with barber username
  - [ ] Include warning about login prevention and historical log retention
  - [ ] Add "Cancel" button (secondary styling)
  - [ ] Add "Delete" button (destructive red styling)
- [ ] Implement client-side delete trigger (AC: 1)
  - [ ] Connect Delete menu item in BarberCard dropdown to confirmation dialog
  - [ ] Pass barber data to confirmation dialog
  - [ ] Control dialog open/closed state
- [ ] Create API route for barber deletion (AC: 4, 5, 6)
  - [ ] Create app/api/barbers/[id]/route.ts with DELETE handler
  - [ ] Verify Firebase Auth token and manager role in middleware
  - [ ] Return 401 if unauthorized
  - [ ] Use Firebase Admin SDK to access both Firestore and Auth
- [ ] Implement Firestore user document deletion (AC: 4)
  - [ ] Use Admin SDK to delete document from users collection by barber ID
  - [ ] Wrap in try/catch for error handling
- [ ] Implement Firebase Auth account disabling (AC: 5, 6)
  - [ ] Use Admin SDK updateUser() to set disabled: true
  - [ ] Do NOT delete Auth user (preserve authentication history)
  - [ ] Remove or invalidate custom claims if necessary
- [ ] Handle deleted barber login attempt (AC: 7)
  - [ ] Update login flow to check if user account is disabled
  - [ ] Show error message: "Your account has been disabled. Please contact your manager."
  - [ ] Redirect to login page
- [ ] Preserve historical service logs (AC: 8)
  - [ ] No code changes needed - serviceLogs collection retains barberId
  - [ ] Document that reports will still show deleted barbers' historical data
  - [ ] Consider adding "isActive" flag or display logic in reports
- [ ] Implement delete mutation (AC: 9, 10)
  - [ ] Create deleteBarber function that calls DELETE /api/barbers/[id]
  - [ ] Use React Query useMutation
  - [ ] Show success toast: "Barber '[username]' removed successfully"
  - [ ] Implement optimistic update to remove barber from cache immediately
  - [ ] On success, barber disappears from grid via optimistic update + real-time sync
  - [ ] On error, rollback optimistic update and show error toast
- [ ] Error handling (AC: 10)
  - [ ] Catch API errors (network, server errors)
  - [ ] Show toast: "Failed to delete barber. Please try again."
  - [ ] Log error to console for debugging
  - [ ] Keep confirmation dialog open on error

## Dev Notes

### API Route Implementation

[Source: architecture.md#API Specification - DELETE /api/barbers/[id]]

Create DELETE handler in `app/api/barbers/[id]/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { adminAuth, adminDb } from '@/lib/firebase/admin'
import { verifyAuthToken } from '@/lib/auth/verify-token'

export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify authentication and manager role
    const user = await verifyAuthToken(request)
    if (!user || user.role !== 'manager') {
      return NextResponse.json(
        { error: 'Unauthorized - Manager access required' },
        { status: 401 }
      )
    }

    const barberId = params.id

    // Delete user document from Firestore
    await adminDb.collection('users').doc(barberId).delete()

    // Disable Firebase Auth account (preserve history)
    await adminAuth.updateUser(barberId, { disabled: true })

    return NextResponse.json({
      success: true,
      message: 'Barber deleted successfully',
    })
  } catch (error) {
    console.error('Delete barber error:', error)
    return NextResponse.json(
      { error: 'Failed to delete barber' },
      { status: 500 }
    )
  }
}
```

### Firebase Admin SDK Setup

[Source: architecture.md#Tech Stack - Firebase Authentication]

Ensure Firebase Admin SDK initialized in `lib/firebase/admin.ts`:

```typescript
import * as admin from 'firebase-admin'

if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert({
      projectId: process.env.FIREBASE_PROJECT_ID,
      clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
      privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
    }),
  })
}

export const adminAuth = admin.auth()
export const adminDb = admin.firestore()
```

### Auth Token Verification

[Source: architecture.md#Components - Authentication Service]

Create token verification helper in `lib/auth/verify-token.ts`:

```typescript
import { NextRequest } from 'next/server'
import { adminAuth } from '@/lib/firebase/admin'

export async function verifyAuthToken(request: NextRequest) {
  const authHeader = request.headers.get('Authorization')
  if (!authHeader?.startsWith('Bearer ')) {
    return null
  }

  const token = authHeader.split('Bearer ')[1]
  try {
    const decodedToken = await adminAuth.verifyIdToken(token)
    return {
      uid: decodedToken.uid,
      role: decodedToken.role as 'manager' | 'barber',
    }
  } catch (error) {
    return null
  }
}
```

### Client-Side Delete Function

[Source: architecture.md#Components - Barber Management Service]

Add to `lib/services/barber-management.ts`:

```typescript
export async function deleteBarber(barberId: string) {
  const user = auth.currentUser
  if (!user) throw new Error('Not authenticated')

  const token = await user.getIdToken()

  const response = await fetch(`/api/barbers/${barberId}`, {
    method: 'DELETE',
    headers: {
      Authorization: `Bearer ${token}`,
    },
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.error || 'Failed to delete barber')
  }

  return response.json()
}
```

### React Query Mutation

[Source: architecture.md#Architectural Patterns - Optimistic UI Updates]

```typescript
const { mutate: deleteBarberMutation } = useMutation({
  mutationFn: (barberId: string) => deleteBarber(barberId),
  onMutate: async (barberId) => {
    await queryClient.cancelQueries({ queryKey: ['barbers'] })
    const previousBarbers = queryClient.getQueryData(['barbers'])

    // Optimistically remove from cache
    queryClient.setQueryData(['barbers'], (old: UserProfile[]) =>
      old.filter((b) => b.id !== barberId)
    )

    return { previousBarbers }
  },
  onError: (err, barberId, context) => {
    // Rollback on error
    queryClient.setQueryData(['barbers'], context.previousBarbers)
    toast.error('Failed to delete barber. Please try again.')
  },
  onSuccess: (data, barberId) => {
    const barber = context?.previousBarbers?.find((b) => b.id === barberId)
    toast.success(`Barber '${barber?.username}' removed successfully`)
  },
})
```

### Historical Data Preservation

[Source: architecture.md#Data Models - ServiceLog]

**Important:** When a barber is deleted, their service logs remain in the `serviceLogs` collection. The `barberId` field is retained for reporting purposes. This ensures:

1. Financial reports remain accurate (historical revenue data intact)
2. Commission calculations for past periods are unchanged
3. Audit trail preserved for payroll verification

**Display Consideration:** In reports, you may want to:

- Mark deleted barbers with "(Inactive)" label
- Filter out inactive barbers from current performance metrics
- Keep them visible in historical reports

No code changes needed in this story - just document the behavior.

### Login Flow Update

[Source: architecture.md#Components - Authentication Service]

Update barber login flow to check disabled status:

```typescript
try {
  await signInWithEmailAndPassword(auth, email, password)
} catch (error) {
  if (error.code === 'auth/user-disabled') {
    toast.error('Your account has been disabled. Please contact your manager.')
    return
  }
  // Handle other errors
}
```

Firebase Auth automatically prevents disabled users from signing in with error code `auth/user-disabled`.

### Project Structure

[Source: architecture.md#Unified Project Structure]

**Files to create/modify:**

- `app/api/barbers/[id]/route.ts` - DELETE API route
- `components/features/barbers/DeleteBarberConfirmation.tsx` - Confirmation dialog
- `lib/services/barber-management.ts` - Add deleteBarber function
- `lib/firebase/admin.ts` - Ensure Admin SDK initialized
- `lib/auth/verify-token.ts` - Token verification helper

### ShadCN Components Required

[Source: architecture.md#Tech Stack - ShadCN UI]

- AlertDialog (confirmation dialog)
- Button (cancel, delete)

### Testing

#### Component Tests

[Source: architecture.md#Testing Strategy - Component Tests]

**Tests Required:**

1. `tests/component/barbers/DeleteBarberConfirmation.test.tsx`
   - Dialog displays barber username in confirmation message
   - Shows warning about login prevention and historical data
   - Cancel button closes dialog without calling delete
   - Delete button triggers deleteBarber mutation
   - Dialog closes on successful deletion
   - Shows success toast with barber username
   - Dialog stays open and shows error toast on failure
   - Escape key closes dialog

#### Integration Tests

[Source: architecture.md#Testing Strategy - Integration Tests]

**Test with mocked API:**

1. `tests/integration/barbers/delete-barber.test.tsx`
   - Mock DELETE /api/barbers/[id] endpoint
   - Click Delete in dropdown, confirm in dialog
   - Verify DELETE request sent with correct barber ID
   - Verify Authorization header includes Firebase token
   - Verify optimistic update removes barber from cache
   - Simulate API error and verify rollback
   - Verify barber reappears in list on error

#### E2E Tests

[Source: architecture.md#Testing Strategy - E2E Tests]

**Playwright test:**

1. `tests/e2e/barber-management.spec.ts` (add to existing file)
   - Create test barber via API
   - Manager clicks Delete in barber dropdown
   - Confirmation dialog appears with correct message
   - Click Delete button
   - Dialog closes
   - Success toast appears
   - Barber card disappears from grid
   - Attempt to log in as deleted barber
   - Login fails with "account disabled" error
   - Check serviceLogs collection - historical logs still present
   - Check Firestore users collection - document deleted
   - Check Firebase Auth - account disabled (not deleted)

#### API Route Tests

[Source: architecture.md#Testing Strategy - Backend Unit Tests]

**Unit tests for API route:**

1. `tests/unit/api/barbers/delete-barber.test.ts`
   - Returns 401 if no auth token provided
   - Returns 401 if token is invalid
   - Returns 401 if user role is 'barber' (not manager)
   - Deletes user document from Firestore when authorized
   - Disables Firebase Auth account when authorized
   - Does not delete Firebase Auth account (only disables)
   - Returns 200 with success message on successful deletion
   - Returns 500 on Firestore error
   - Returns 500 on Firebase Auth error

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
