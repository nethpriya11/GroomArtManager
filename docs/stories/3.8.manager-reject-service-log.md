# Story 3.8: Manager Reject Service Log

## Status

Draft

## Story

**As a** manager,
**I want** to reject a pending service log,
**so that** incorrect or disputed services don't count toward revenue.

## Acceptance Criteria

1. Clicking ✗ (reject) icon button updates service log status to 'rejected'
2. Service log document updated in Firestore: status: 'rejected', rejectedAt: timestamp
3. Optimistic UI update: Row disappears from "Pending Approvals" table
4. Toast notification: "Service log rejected"
5. Real-time: Barber's dashboard updates instantly (status badge changes to "Rejected")
6. Rejected log does NOT contribute to any financial calculations or stats
7. Rejected log retained in Firestore for audit trail
8. Barber can see rejected logs in their history table
9. Rejected logs cannot be re-approved (status change is permanent)
10. Security rule enforced: Only managers can set status to 'rejected'

## Tasks / Subtasks

- [ ] Create rejectServiceLog service function (AC: 1, 2)
  - [ ] Implement in lib/services/approval-service.ts
  - [ ] Use Firestore updateDoc() to update status and rejectedAt
  - [ ] Set status: 'rejected', rejectedAt: serverTimestamp()
  - [ ] Export function: rejectServiceLog(logId: string): Promise<void>
- [ ] Create reject mutation with optimistic updates (AC: 3)
  - [ ] Use React Query useMutation hook
  - [ ] Configure onMutate: Cancel queries, snapshot previous state
  - [ ] Optimistically remove log from pending queue
  - [ ] Configure onError: Rollback optimistic update, show error toast
  - [ ] Configure onSuccess: Show success toast
- [ ] Add reject button to PendingApprovalsTable (AC: 1)
  - [ ] Use red X icon (X from Lucide React)
  - [ ] Wire up onClick to call reject mutation
  - [ ] Pass logId to mutation function
  - [ ] Apply red styling for reject action (destructive variant)
- [ ] Implement success toast notification (AC: 4)
  - [ ] Use Sonner toast library
  - [ ] Display message: "Service log rejected"
  - [ ] Show toast immediately after optimistic update
  - [ ] Use neutral or warning variant (not error - rejection is expected action)
- [ ] Verify real-time barber dashboard updates (AC: 5)
  - [ ] Barber's ServiceLogTable uses onSnapshot listener
  - [ ] Status badge updates from "Pending" to "Rejected"
  - [ ] Badge uses red color scheme
  - [ ] Updates appear within 2 seconds
- [ ] Ensure rejected logs excluded from calculations (AC: 6)
  - [ ] Daily stats query filters by status='approved' only
  - [ ] Manager KPI queries filter by status='approved' only
  - [ ] Leaderboard queries filter by status='approved' only
  - [ ] Verify rejected logs do not contribute to any totals
- [ ] Verify rejected log retained for audit (AC: 7, 8)
  - [ ] Document is not deleted from Firestore (only status updated)
  - [ ] Barber can still see rejected log in history table
  - [ ] Rejected logs sortable and searchable in table
  - [ ] Include rejectedAt timestamp in log for audit trail
- [ ] Implement permanent status change (AC: 9)
  - [ ] No UI for re-approving rejected logs
  - [ ] Security rules prevent status change from 'rejected' to other states
  - [ ] Document in comments that status change is permanent
  - [ ] If re-approval needed, manager must create new log (future feature)
- [ ] Verify security rules enforcement (AC: 10)
  - [ ] Firestore rule: Only managers can set status to 'rejected'
  - [ ] Rule: isManager() && affectedKeys hasOnly ['status', 'approvedAt', 'rejectedAt']
  - [ ] Test that barbers cannot reject logs
  - [ ] Test that only status/timestamp fields can be updated

## Dev Notes

### Service Layer Implementation

[Source: architecture.md#Approval Workflow Service]

**rejectServiceLog Function:**

```typescript
// lib/services/approval-service.ts
import { doc, updateDoc, serverTimestamp } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'

export async function rejectServiceLog(logId: string): Promise<void> {
  const logRef = doc(db, 'serviceLogs', logId)
  await updateDoc(logRef, {
    status: 'rejected',
    rejectedAt: serverTimestamp(),
  })
}
```

**Key Design Decisions:**

- Only updates `status` and `rejectedAt` fields (AC 2)
- Does not delete the document (AC 7 - retained for audit trail)
- Does not modify `price`, `commissionRate`, or `commissionAmount` (immutable)
- Uses Firestore `serverTimestamp()` for consistency across clients
- Throws error if Firestore update fails (caught by React Query)

### Optimistic UI Pattern

[Source: architecture.md#Optimistic UI Updates Pattern]

**React Query Mutation Configuration:**

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { toast } from 'sonner'

export function useRejectLog() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: rejectServiceLog,
    onMutate: async (logId) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['serviceLogs', 'pending'] })

      // Snapshot previous value
      const previousLogs = queryClient.getQueryData(['serviceLogs', 'pending'])

      // Optimistically remove from pending queue
      queryClient.setQueryData(
        ['serviceLogs', 'pending'],
        (old: ServiceLog[]) => old?.filter((log) => log.id !== logId) ?? []
      )

      return { previousLogs }
    },
    onError: (err, logId, context) => {
      // Rollback on error
      queryClient.setQueryData(
        ['serviceLogs', 'pending'],
        context?.previousLogs
      )
      toast.error('Failed to reject service log. Please try again.')
    },
    onSuccess: () => {
      toast.success('Service log rejected')
    },
  })
}
```

**Optimistic Update Flow (AC 3):**

1. Manager clicks reject button
2. Row disappears from pending table instantly (optimistic)
3. Firestore update sent in background
4. If success: No action needed (already updated)
5. If failure: Row reappears (rollback), error toast shown

### Real-time Synchronization

[Source: architecture.md#Core Workflows - Workflow 1]

**Barber Dashboard Updates (AC 5):**
When manager rejects a log:

1. Manager's browser updates Firestore: `status='rejected', rejectedAt=timestamp`
2. Firestore triggers onSnapshot listener in barber's browser
3. React Query cache updates with new status
4. Barber's ServiceLogTable re-renders:
   - Status badge changes from "Pending" (amber) to "Rejected" (red)
   - Badge displays red X icon with "Rejected" text
5. Barber's daily stats remain unchanged (only approved logs counted)

**Latency:** <2 seconds from rejection action to barber visibility (per NFR)

### Financial Calculations Exclusion

[Source: architecture.md#ServiceLog Data Model, Reporting & Analytics Service]

**Query Filtering (AC 6):**
All financial calculations and reporting queries filter by `status='approved'`:

```typescript
// Barber Daily Stats
const approvedLogsToday = query(
  collection(db, 'serviceLogs'),
  where('barberId', '==', barberId),
  where('status', '==', 'approved'),
  where('createdAt', '>=', startOfToday())
)

// Manager KPIs
const totalRevenueQuery = query(
  collection(db, 'serviceLogs'),
  where('status', '==', 'approved')
)

// Leaderboards
const topBarbersQuery = query(
  collection(db, 'serviceLogs'),
  where('status', '==', 'approved')
  // Group by barberId, sum commissionAmount
)
```

**Rejected Logs Behavior:**

- Do NOT contribute to revenue totals
- Do NOT contribute to service counts
- Do NOT appear in leaderboards
- Do NOT affect barber daily stats
- ARE visible in barber's service log history table (AC 8)
- ARE retained in Firestore for audit trail (AC 7)

### Audit Trail & Data Retention

[Source: Epic 3 AC 7, 8]

**Why Retain Rejected Logs:**

1. **Audit Trail:** Provides complete history of all service logging attempts
2. **Dispute Resolution:** Manager and barber can review rejected logs
3. **Pattern Analysis:** Identify recurring issues (e.g., barber frequently logs wrong service)
4. **Transparency:** Barber sees why earnings differ from expectations

**Barber's History Table Display:**

```typescript
// ServiceLogTable.tsx (Barber Dashboard)
// Shows ALL logs (pending, approved, rejected)
const { data: logs } = useServiceLogs(barberId) // No status filter

// Display with status badge:
// - Pending: ⏱️ Amber "Pending"
// - Approved: ✓ Green "Approved"
// - Rejected: ✗ Red "Rejected"
```

### Security Rules Enforcement

[Source: architecture.md#Firestore Security Rules]

**Manager Rejection Permission (AC 10):**

```javascript
// serviceLogs collection
allow update: if isManager()
  && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'approvedAt', 'rejectedAt']);
```

**Rule Breakdown:**

1. `isManager()` - User must have `role='manager'` custom claim
2. `affectedKeys().hasOnly([...])` - Only status/timestamp fields can be changed
3. This prevents managers from modifying price, commission, or other immutable fields
4. Barbers cannot update logs (no update rule for barbers)
5. Same rule applies for both approve and reject actions

### Permanent Status Change

[Source: Epic 3 AC 9]

**Design Decision:**

- Once rejected, logs cannot be re-approved (AC 9)
- No "Undo" or "Re-approve" functionality in UI
- Permanent status ensures data integrity for audit trail
- If rejection was a mistake, manager can:
  - Create new log on behalf of barber (Story 3.9)
  - Keep rejected log for audit trail
  - Rejected log still visible to barber with rejected status

**Rationale:**

- Prevents confusion about which logs count toward revenue
- Clear audit trail: approved logs were approved, rejected logs were rejected
- If status could change multiple times, audit trail becomes ambiguous

### Status Badge Styling

[Source: architecture.md#Component Architecture, Epic 3 AC 3]

**Badge Component Configuration:**

```typescript
// Status badge colors
const statusConfig = {
  pending: {
    icon: Clock, // ⏱️
    color: 'amber', // #f59e0b
    label: 'Pending',
  },
  approved: {
    icon: Check, // ✓
    color: 'green', // #22c55e
    label: 'Approved',
  },
  rejected: {
    icon: X, // ✗
    color: 'red', // #ef4444
    label: 'Rejected',
  },
}
```

### Testing

[Source: architecture.md#Testing Strategy]

**Unit Tests (Vitest):**

- `tests/unit/services/approval-service.test.ts`
  - Test `rejectServiceLog()` calls updateDoc with correct log ID
  - Verify updates status='rejected' and rejectedAt=timestamp
  - Mock Firestore SDK
  - Test error handling when update fails
  - Verify function does not delete document

**Component Tests (React Testing Library):**

- `tests/component/service-logs/PendingApprovalsTable.test.tsx`
  - Render table with pending logs
  - Click reject button on a log
  - Verify mutation called with correct log ID
  - Verify row disappears immediately (optimistic update)
  - Verify success toast shown: "Service log rejected"
  - Mock Firestore error - verify row reappears, error toast shown
  - Verify reject button styled red (X icon)
- `tests/component/service-logs/ServiceLogTable.test.tsx` (Barber view)
  - Render with rejected logs
  - Verify rejected logs display "Rejected" badge (red)
  - Verify rejected logs still visible in table
  - Verify rejected logs do not have delete button (only pending can be deleted)

**Integration Tests:**

- `tests/component/dashboard/ManagerDashboard.test.tsx`
  - Reject pending log from dashboard
  - Verify log removed from pending queue
  - Verify manager KPIs unchanged (rejected logs excluded)
- `tests/component/dashboard/BarberDashboard.test.tsx`
  - Mock rejected log update
  - Verify barber's table status badge changes to "Rejected"
  - Verify barber's daily stats unchanged (only approved logs counted)
  - Verify rejected log still appears in history table

**E2E Tests (Playwright):**

- `tests/e2e/approval-workflow/reject-log.spec.ts`
  - As barber, log a service
  - As manager, open dashboard
  - Verify pending log appears in table
  - Click reject button
  - Verify row disappears from pending table
  - Verify toast notification: "Service log rejected"
  - As barber, refresh dashboard
  - Verify log shows "Rejected" status in barber's table (red badge)
  - Verify barber's daily stats unchanged (count and revenue same as before)
  - Verify Firestore document updated: status='rejected', rejectedAt exists
  - Verify document not deleted (still exists in Firestore)
  - Attempt to reject same log again - verify no reject button (not in pending queue)

**Real-time Sync E2E Test:**

- Open manager and barber dashboards in separate browser contexts
- Barber logs service
- Manager rejects service (without refresh)
- Verify barber dashboard updates in <2 seconds without refresh
- Verify status badge changes to "Rejected"
- Verify daily stats unchanged

**Financial Calculation E2E Test:**

- As barber, log 3 services (creates 3 pending logs)
- As manager, approve 2 logs, reject 1 log
- Verify barber daily stats count only 2 approved logs
- Verify manager KPIs count only 2 approved logs
- Verify rejected log visible in barber history but not in stats

**Security Tests:**

- `tests/security/firestore-rules.test.ts`
  - Test manager can reject pending log (should succeed)
  - Test barber cannot reject log (should fail with permission error)
  - Test manager cannot modify price during rejection (should fail)
  - Test manager cannot modify commissionAmount during rejection (should fail)
  - Test rejected log cannot be re-approved (no rule allows status change from rejected)
  - Test rejected log cannot be deleted by barber (only pending logs can be deleted)

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
