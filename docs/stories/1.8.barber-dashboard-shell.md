# Story 1.8: Barber Dashboard Shell

## Status

Draft

## Story

**As a** barber,
**I want** to see my personal dashboard after logging in,
**so that** I can access features relevant to my work.

## Acceptance Criteria

1. Barber dashboard created at `/barber/dashboard` route (auth-protected)
2. Header displays daily stats cards (2 KPI cards: Services Today, Revenue Today) with placeholder $0 values
3. "Log a Service" section visible with empty service grid and "Services coming soon" message
4. "My Logged Services" table section with empty state: "No services logged yet. Start by logging a service above."
5. No navigation menu (barbers only have one page)
6. Logout button in header triggers logout and redirects to `/login`
7. Dark theme applied (#0a0a0a background, #1a1a1a cards)
8. Mobile responsive: Cards stack vertically, table scrolls horizontally if needed
9. Page accessible only to authenticated users with `role: 'barber'` (middleware redirect if unauthorized)
10. Real-time connection established (onSnapshot listener ready for future data)

## Tasks / Subtasks

- [ ] Create barber dashboard route and page (AC: 1, 9)
  - [ ] Create app/barber/dashboard/page.tsx
  - [ ] Implement middleware.ts for auth protection
  - [ ] Add role check: redirect if user.role !== 'barber'
  - [ ] Verify authenticated users only can access route
- [ ] Create daily stats KPI cards (AC: 2)
  - [ ] Create components/features/dashboard/DailyStats.tsx
  - [ ] Create 2 KPI cards: Services Today, Revenue Today
  - [ ] Display placeholder values: 0, $0
  - [ ] Use ShadCN Card component with dark theme (#1a1a1a)
  - [ ] Arrange in responsive grid (2 columns desktop, 1 mobile)
- [ ] Create log service section stub (AC: 3)
  - [ ] Create service grid container component
  - [ ] Display empty state: "Services coming soon"
  - [ ] Add placeholder for future service card grid
  - [ ] Use ShadCN Card or EmptyState component
- [ ] Create logged services table (AC: 4)
  - [ ] Create components/features/service-logs/ServiceLogTable.tsx
  - [ ] Use ShadCN Table component structure
  - [ ] Add table headers: Service, Price, Commission, Status, Date, Actions
  - [ ] Display empty state: "No services logged yet. Start by logging a service above."
- [ ] Implement simple header layout (AC: 5, 6)
  - [ ] No navigation menu (barbers have single page)
  - [ ] Add header with app branding and user info
  - [ ] Add logout button in header
  - [ ] Display current barber username
- [ ] Add logout functionality (AC: 6)
  - [ ] Add logout button to header
  - [ ] Implement signOut() in auth service
  - [ ] Call Firebase signOut and clear Zustand auth store
  - [ ] Redirect to /login after successful logout
- [ ] Apply dark theme styling (AC: 7)
  - [ ] Set page background to #0a0a0a
  - [ ] Set card backgrounds to #1a1a1a
  - [ ] Verify all text meets WCAG AA contrast requirements
- [ ] Implement mobile responsive layout (AC: 8)
  - [ ] Stack KPI cards vertically on mobile (<768px)
  - [ ] Make table horizontally scrollable on mobile
  - [ ] Test layout at 768px and 375px breakpoints
- [ ] Establish real-time connection (AC: 10)
  - [ ] Create useServiceLogs hook with onSnapshot listener
  - [ ] Filter logs by barberId == current user ID
  - [ ] Wrap listener in React Query with staleTime: Infinity
  - [ ] Verify listener cleanup on unmount
  - [ ] Test real-time updates when manager approves log

## Dev Notes

### Route Protection Pattern

[Source: architecture.md#Authentication Service]

**Middleware Configuration (middleware.ts):**

```typescript
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const user = request.cookies.get('auth-user')?.value

  if (!user) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  const userData = JSON.parse(user)
  const path = request.nextUrl.pathname

  // Barber routes
  if (path.startsWith('/barber') && userData.role !== 'barber') {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/manager/:path*', '/barber/:path*'],
}
```

### Component Architecture

[Source: architecture.md#Component Architecture]

**File Locations:**

- Page: `app/barber/dashboard/page.tsx`
- Layout: `app/barber/layout.tsx` (shared header)
- Daily Stats: `components/features/dashboard/DailyStats.tsx`
- Barber Dashboard: `components/features/dashboard/BarberDashboard.tsx`
- Service Log Table: `components/features/service-logs/ServiceLogTable.tsx`

**Component Hierarchy:**

```
app/barber/dashboard/page.tsx
└── BarberDashboard.tsx
    ├── Header (with logout button, username)
    ├── DailyStats.tsx (Services Today, Revenue Today)
    ├── ServiceGrid (empty state: "Services coming soon")
    └── ServiceLogTable.tsx (empty state: "No services logged yet")
```

### Real-time Service Logs Hook

[Source: architecture.md#Real-time Sync Engine]

**Pattern Implementation:**

```typescript
// hooks/useServiceLogs.ts
import { useQuery } from '@tanstack/react-query'
import {
  collection,
  query,
  where,
  onSnapshot,
  orderBy,
} from 'firebase/firestore'
import { db } from '@/lib/firebase/config'
import type { ServiceLog } from '@/types/firestore'
import { useAuthStore } from '@/stores/authStore'

export function useServiceLogs() {
  const user = useAuthStore((state) => state.user)

  return useQuery({
    queryKey: ['serviceLogs', user?.id],
    queryFn: () =>
      new Promise<ServiceLog[]>((resolve) => {
        if (!user?.id) {
          resolve([])
          return
        }

        const q = query(
          collection(db, 'serviceLogs'),
          where('barberId', '==', user.id),
          orderBy('createdAt', 'desc')
        )

        const unsubscribe = onSnapshot(q, (snapshot) => {
          const logs = snapshot.docs.map(
            (doc) =>
              ({
                id: doc.id,
                ...doc.data(),
              }) as ServiceLog
          )
          resolve(logs)
        })

        return () => unsubscribe()
      }),
    staleTime: Infinity, // Real-time data never stale
    enabled: !!user?.id,
  })
}
```

**Key Points:**

- Filter by barberId to show only barber's own logs
- Order by createdAt descending (most recent first)
- Enable query only when user authenticated
- React Query manages listener lifecycle automatically

### Daily Stats Calculation

[Source: architecture.md#Reporting & Analytics Service]

**Today's Stats Logic:**

```typescript
// utils/calculations.ts
import { ServiceLog } from '@/types/firestore'
import { startOfDay, endOfDay } from 'date-fns'

export function calculateDailyStats(logs: ServiceLog[]) {
  const today = new Date()
  const todayStart = startOfDay(today)
  const todayEnd = endOfDay(today)

  const todayLogs = logs.filter((log) => {
    const logDate = log.createdAt.toDate()
    return (
      logDate >= todayStart && logDate <= todayEnd && log.status === 'approved'
    )
  })

  const servicesCount = todayLogs.length
  const totalRevenue = todayLogs.reduce(
    (sum, log) => sum + log.commissionAmount,
    0
  )

  return {
    servicesCount,
    totalRevenue: totalRevenue.toFixed(2),
  }
}
```

**Placeholder Values (Story 1.8):**

- Services Today: 0 (no data yet)
- Revenue Today: $0.00 (no data yet)
- Note: Calculation logic will be used in future stories when data exists

### Dark Theme Configuration

[Source: architecture.md#Tech Stack - Tailwind CSS]

**Theme Colors:**

- Background: `#0a0a0a` (bg-[#0a0a0a])
- Cards: `#1a1a1a` (bg-[#1a1a1a])
- Primary accent: `#f59e0b` (text-primary, border-primary)
- Text: Light gray for contrast (text-gray-300, text-gray-100)

### Mobile Responsive Design

[Source: architecture.md#Component Template]

**Layout Responsiveness:**

**KPI Cards Grid:**

```typescript
className = 'grid grid-cols-1 md:grid-cols-2 gap-4'

// Mobile (<768px): 1 column (stacked vertically)
// Desktop (>=768px): 2 columns (side by side)
```

**Table Horizontal Scroll:**

```typescript
<div className="overflow-x-auto">
  <Table>
    {/* Table content */}
  </Table>
</div>

// Mobile: Table scrolls horizontally if columns don't fit
// Desktop: Table displays normally
```

### Service Log Table Structure

[Source: architecture.md#Data Models - ServiceLog]

**Table Columns:**

1. Service Name (join with services collection)
2. Price (snapshot value from log)
3. Commission (commissionAmount)
4. Status (badge: pending/approved/rejected)
5. Date (createdAt formatted)
6. Actions (delete button for pending logs)

**Empty State:**

- Show when logs.length === 0
- Message: "No services logged yet. Start by logging a service above."
- Use ShadCN EmptyState component or centered text

**Table Headers (Placeholder):**

```typescript
<TableHeader>
  <TableRow>
    <TableHead>Service</TableHead>
    <TableHead>Price</TableHead>
    <TableHead>Commission</TableHead>
    <TableHead>Status</TableHead>
    <TableHead>Date</TableHead>
    <TableHead>Actions</TableHead>
  </TableRow>
</TableHeader>
<TableBody>
  {/* Empty for now - will populate in future stories */}
</TableBody>
```

### Testing

[Source: architecture.md#Testing Strategy]

**Component Tests (Vitest + React Testing Library):**

- Location: `tests/component/dashboard/BarberDashboard.test.tsx`
- Test daily stats cards render with placeholder values (0, $0)
- Test service grid empty state displays "Services coming soon"
- Test service log table empty state displays correct message
- Test logout button triggers logout and redirect
- Test header displays barber username
- Test mobile responsive layout (cards stack, table scrolls)
- Test dark theme colors applied correctly

**E2E Tests (Playwright):**

- Location: `tests/e2e/auth.spec.ts`
- Test: "Barber can log in and reach dashboard"
  - Login as barber
  - Select barber profile
  - Verify redirect to /barber/dashboard
  - Verify daily stats cards visible
  - Verify empty states display
  - Click logout button
  - Verify redirect to /login
- Test: "Unauthorized users redirected from barber routes"
  - Login as manager
  - Navigate to /barber/dashboard
  - Verify redirect to /login or /manager/dashboard

**Real-time Test (E2E):**

- Location: `tests/e2e/real-time-sync.spec.ts`
- Test: "Barber dashboard updates when manager approves log"
  - Open two browser contexts (barber + manager)
  - Barber logs service (status: pending)
  - Manager approves log
  - Verify barber's table updates in real-time (<2s)
  - Verify daily stats increment

**Example Test:**

```typescript
describe('BarberDashboard', () => {
  it('renders daily stats cards with placeholder values', () => {
    render(<BarberDashboard />);

    expect(screen.getByText('Services Today')).toBeInTheDocument();
    expect(screen.getByText('Revenue Today')).toBeInTheDocument();
    expect(screen.getByText('0')).toBeInTheDocument(); // Services count
    expect(screen.getByText('$0.00')).toBeInTheDocument(); // Revenue
  });

  it('displays empty state for service logs', () => {
    render(<BarberDashboard />);

    expect(screen.getByText('No services logged yet. Start by logging a service above.')).toBeInTheDocument();
  });

  it('shows logout button in header', () => {
    render(<BarberDashboard />);

    expect(screen.getByText('Logout')).toBeInTheDocument();
  });
});

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | v1.0 | Initial story creation | PM Agent (John) |

## Dev Agent Record
### Agent Model Used
{To be populated by dev agent}

### Debug Log References
{To be populated by dev agent}

### Completion Notes List
{To be populated by dev agent}

### File List
{To be populated by dev agent}

## QA Results
{To be populated by QA agent}
```
