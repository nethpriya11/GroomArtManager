# Story 1.6: Authentication Flow - Barber Selection

## Status

Draft

## Story

**As a** barber,
**I want** to select my profile from a list of barbers after clicking "Barber" on the login page,
**so that** I can log in as myself and access my personal dashboard.

## Acceptance Criteria

1. Barber selection grid displayed after "Barber" button click
2. Grid shows all users with `role: 'barber'` from Firestore `users` collection
3. Each barber displayed as a card with avatar (image or placeholder), username
4. Grid responsive: 4 columns on desktop (>1024px), 2 columns on tablet/mobile (<1024px)
5. Cards have hover state (elevation shadow increase) and press effect (scale 0.98)
6. Clicking a barber card authenticates as that barber and redirects to `/barber/dashboard`
7. Real-time updates: New barbers added by manager appear instantly in the grid
8. Empty state shown if no barbers exist: "No barbers found. Contact your manager."
9. Keyboard navigation: Tab through cards, Enter to select
10. ARIA labels applied: "Select barber: [username]"

## Tasks / Subtasks

- [ ] Create barber selection component (AC: 1, 2, 3)
  - [ ] Create BarberProfileSelection.tsx component in components/features/auth/
  - [ ] Implement real-time query to fetch users with role: 'barber' from Firestore
  - [ ] Use useRealtimeQuery hook to wrap onSnapshot listener with React Query
  - [ ] Display each barber as a card with avatar (image or placeholder) and username
- [ ] Implement responsive grid layout (AC: 4)
  - [ ] Configure Tailwind grid: 4 columns on desktop (lg:grid-cols-4)
  - [ ] Configure 2 columns on tablet/mobile (grid-cols-2)
  - [ ] Test responsive breakpoints at 1024px
- [ ] Add interactive card states (AC: 5)
  - [ ] Add hover state with elevated shadow (hover:shadow-lg)
  - [ ] Add press effect with scale transformation (active:scale-98)
  - [ ] Add transition-all for smooth animations
- [ ] Implement barber authentication (AC: 6)
  - [ ] Create signInAsBarber(barberId) function in auth service
  - [ ] Call signInAsBarber on card click
  - [ ] Redirect to /barber/dashboard after successful authentication
  - [ ] Update Zustand auth store with selected barber profile
- [ ] Verify real-time updates (AC: 7)
  - [ ] Test onSnapshot listener updates grid when new barber added
  - [ ] Verify React Query cache invalidation triggers re-render
  - [ ] Ensure <2s latency for new barber appearance
- [ ] Create empty state component (AC: 8)
  - [ ] Show EmptyState component when barbers array is empty
  - [ ] Display message: "No barbers found. Contact your manager."
  - [ ] Use ShadCN Card component for consistent styling
- [ ] Add keyboard navigation support (AC: 9)
  - [ ] Make cards focusable with tabIndex={0}
  - [ ] Handle Enter key press to select barber
  - [ ] Test tab navigation through all cards
- [ ] Implement accessibility features (AC: 10)
  - [ ] Add aria-label="Select barber: [username]" to each card
  - [ ] Add role="button" to cards
  - [ ] Ensure WCAG 2.1 AA contrast ratios (4.5:1 minimum)

## Dev Notes

### Component Architecture

[Source: architecture.md#Component Architecture]

**File Location:** `components/features/auth/BarberProfileSelection.tsx`

**Component Dependencies:**

- ShadCN UI: Card, CardHeader, CardTitle
- Custom hooks: useRealtimeQuery (from hooks/useRealtimeQuery.ts)
- Zustand: useAuthStore (from stores/authStore.ts)
- Auth service: signInAsBarber (from lib/services/auth-service.ts)
- Types: UserProfile (from types/firestore.ts)

### Real-time Data Synchronization

[Source: architecture.md#Real-time Sync Engine]

**Pattern Implementation:**

```typescript
export function useBarbers() {
  return useRealtimeQuery<UserProfile>({
    queryKey: ['users', 'barbers'],
    queryFn: () =>
      new Promise((resolve) => {
        const unsubscribe = onSnapshot(
          query(collection(db, 'users'), where('role', '==', 'barber')),
          (snapshot) =>
            resolve(snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })))
        )
        return () => unsubscribe()
      }),
    staleTime: Infinity, // Real-time data never stale
  })
}
```

**Key Points:**

- Wrap Firestore onSnapshot in React Query for automatic cleanup
- Use staleTime: Infinity for real-time queries
- Return unsubscribe function for proper cleanup on unmount
- React Query handles listener lifecycle and prevents memory leaks

### Authentication Flow

[Source: architecture.md#Authentication Service]

**Authentication Method:**

```typescript
// lib/services/auth-service.ts
export async function signInAsBarber(barberId: string) {
  const userDoc = await getDoc(doc(db, 'users', barberId))
  if (!userDoc.exists()) throw new Error('Barber not found')

  const userData = userDoc.data() as UserProfile
  await signInWithCustomToken(auth, userData.id)
  useAuthStore.getState().setUser(userData)
  return userData
}
```

**Security:**

- Firebase custom claims set role: 'barber'
- Firestore security rules enforce read access to own profile only
- Middleware redirects unauthorized users from protected routes

### Responsive Design

[Source: architecture.md#Tech Stack - Tailwind CSS]

**Tailwind Grid Configuration:**

- Mobile/Tablet (<1024px): `grid-cols-2`
- Desktop (>=1024px): `lg:grid-cols-4`
- Gap between cards: `gap-4` or `gap-6`
- Dark theme colors: background #0a0a0a, cards #1a1a1a

**Interactive States:**

```typescript
className = 'cursor-pointer transition-all hover:shadow-lg active:scale-98'
```

### Accessibility Requirements

[Source: architecture.md#Component Template]

**WCAG 2.1 Level AA Compliance:**

- Color contrast ratio: 4.5:1 minimum for text
- Keyboard navigation: Tab to focus, Enter to select
- ARIA labels: "Select barber: [username]"
- Role attributes: role="button"
- Focus indicators: Visible outline on focus

### Testing

[Source: architecture.md#Testing Strategy]

**Component Tests (Vitest + React Testing Library):**

- Location: `tests/component/auth/BarberProfileSelection.test.tsx`
- Test rendering of barber cards with avatar and username
- Test onClick handler calls signInAsBarber with correct barberId
- Test keyboard navigation (Enter key triggers selection)
- Test responsive grid layout (4 columns desktop, 2 columns mobile)
- Test hover and press states (shadow elevation, scale transform)
- Test real-time updates (mock Firestore onSnapshot push)
- Test empty state display when no barbers exist
- Test ARIA attributes (aria-label, role="button")

**E2E Tests (Playwright):**

- Location: `tests/e2e/auth.spec.ts`
- Test: "Barber can select profile and reach dashboard"
  - Click "Barber" button on login page
  - Verify barber selection grid displays
  - Click a barber card
  - Verify redirect to /barber/dashboard
  - Verify authenticated user in header

**Example Test:**

```typescript
it('displays all barbers in responsive grid', async () => {
  const mockBarbers = [
    { id: '1', username: 'John', role: 'barber', avatarUrl: null, commissionRate: 0.45 },
    { id: '2', username: 'Jane', role: 'barber', avatarUrl: null, commissionRate: 0.50 },
  ];

  render(<BarberProfileSelection barbers={mockBarbers} />);

  expect(screen.getByText('John')).toBeInTheDocument();
  expect(screen.getByText('Jane')).toBeInTheDocument();
  expect(screen.getByLabelText('Select barber: John')).toBeInTheDocument();
});

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-10 | v1.0 | Initial story creation | PM Agent (John) |

## Dev Agent Record
### Agent Model Used
{To be populated by dev agent}

### Debug Log References
{To be populated by dev agent}

### Completion Notes List
{To be populated by dev agent}

### File List
{To be populated by dev agent}

## QA Results
{To be populated by QA agent}
```
