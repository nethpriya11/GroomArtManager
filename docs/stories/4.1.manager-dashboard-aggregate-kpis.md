# Story 4.1: Manager Dashboard Aggregate KPIs

## Status

Draft

## Story

**As a** manager,
**I want** to see high-level business metrics on my dashboard,
**so that** I can quickly assess salon performance.

## Acceptance Criteria

1. Manager dashboard displays 3 KPI cards: Total Revenue, Total Services Logged, Active Barbers
2. **Total Revenue:** Sum of all service log prices where status = 'approved'
3. **Total Services Logged:** Count of all service logs where status = 'approved'
4. **Active Barbers:** Count of users where role = 'barber'
5. Values displayed in large, bold font (24px+) with descriptive labels
6. Cards styled with dark theme (#1a1a1a background, #f59e0b accents)
7. Real-time updates: Metrics increment immediately when services approved
8. Skeleton loading state shown on initial page load
9. If no data: Shows "0", "$0.00", "0" (not empty or error)
10. Query optimization: Use Firestore aggregation queries where supported, otherwise client-side calculation

## Tasks / Subtasks

- [ ] Create KPI aggregation service functions (AC: 2, 3, 4, 10)
  - [ ] Implement `getManagerKPIs()` in `lib/services/reporting-service.ts`
  - [ ] Query serviceLogs where status='approved' for revenue and count
  - [ ] Query users collection where role='barber' for active barber count
  - [ ] Use Firestore aggregation queries if supported, fallback to client-side calculation
  - [ ] Return data structure: `{ totalRevenue: number, totalServices: number, activeBarbers: number }`
- [ ] Create custom hook for real-time KPI updates (AC: 7)
  - [ ] Implement `useManagerKPIs()` in `hooks/useManagerKPIs.ts`
  - [ ] Wrap `getManagerKPIs()` in React Query with real-time onSnapshot listener
  - [ ] Configure staleTime: Infinity for real-time data
  - [ ] Handle loading, error, and data states
- [ ] Create KPI card component (AC: 1, 5, 6)
  - [ ] Build `KPICard.tsx` in `components/dashboard/`
  - [ ] Accept props: label (string), value (string | number), icon (optional)
  - [ ] Style with dark theme: #1a1a1a background, #f59e0b accents
  - [ ] Display value in large, bold font (text-2xl or 24px+)
  - [ ] Add descriptive label below value
- [ ] Integrate KPI cards into Manager Dashboard (AC: 1)
  - [ ] Update `app/manager/dashboard/page.tsx` or equivalent
  - [ ] Display 3 KPI cards in a grid layout (responsive: 1 column mobile, 3 columns desktop)
  - [ ] Use `useManagerKPIs()` hook to fetch data
  - [ ] Pass data to individual KPICard components
- [ ] Implement loading states (AC: 8)
  - [ ] Create `KPICardSkeleton.tsx` component
  - [ ] Show skeleton placeholders while data loading
  - [ ] Use ShadCN Skeleton component for animation
- [ ] Handle empty/zero data states (AC: 9)
  - [ ] Display "0" for total services when no approved logs
  - [ ] Display "$0.00" for total revenue when no approved logs
  - [ ] Display "0" for active barbers when no barbers exist
  - [ ] Never show empty state or error for zero values
- [ ] Test real-time updates (AC: 7)
  - [ ] Verify metrics increment when service logs approved in Firestore
  - [ ] Ensure updates appear within <2s latency
  - [ ] Test across multiple browser windows (manager dashboard + approval action)

## Dev Notes

### Reporting & Analytics Service

[Source: architecture.md#Reporting & Analytics Service]

The Reporting & Analytics Service aggregates data for KPIs, leaderboards, and financial reports. Key interfaces:

- `getManagerKPIs()` - Returns total revenue, total services, active barbers count
- Caches aggregation results for 5 minutes using React Query
- Uses Firestore composite indexes for efficient filtering

**Implementation Pattern:**

```typescript
export async function getManagerKPIs(): Promise<ManagerKPIs> {
  const db = getFirestore()

  // Query approved service logs for revenue and count
  const logsQuery = query(
    collection(db, 'serviceLogs'),
    where('status', '==', 'approved')
  )

  const logsSnapshot = await getDocs(logsQuery)
  const totalRevenue = logsSnapshot.docs.reduce(
    (sum, doc) => sum + doc.data().price,
    0
  )
  const totalServices = logsSnapshot.size

  // Query active barbers
  const barbersQuery = query(
    collection(db, 'users'),
    where('role', '==', 'barber')
  )
  const barbersSnapshot = await getDocs(barbersQuery)
  const activeBarbers = barbersSnapshot.size

  return { totalRevenue, totalServices, activeBarbers }
}
```

### Real-time Sync Engine

[Source: architecture.md#Real-time Sync Engine]

Use `useRealtimeQuery` pattern to wrap Firestore onSnapshot listeners in React Query:

```typescript
export function useManagerKPIs() {
  return useQuery({
    queryKey: ['manager-kpis'],
    queryFn: () =>
      new Promise((resolve) => {
        // Set up real-time listeners for serviceLogs and users
        // Aggregate on each snapshot update
        // Return aggregated KPIs
      }),
    staleTime: Infinity, // Real-time data never stale
  })
}
```

### Data Models

[Source: architecture.md#Data Models]

**ServiceLog:**

- `price`: number - Snapshot of service price at logging time
- `status`: 'pending' | 'approved' | 'rejected'
- Filter by `status = 'approved'` for revenue calculations

**UserProfile:**

- `role`: 'manager' | 'barber'
- Filter by `role = 'barber'` for active barber count

### Component Structure

[Source: architecture.md#Components]

Follow atomic design pattern:

- **Atoms:** KPICard (displays single metric)
- **Organisms:** KPIGrid (contains 3 KPICard components)
- **Templates:** Manager Dashboard page layout

### Styling Requirements

- Dark theme: #1a1a1a background, #f59e0b accents
- Large, bold font: Use Tailwind `text-2xl font-bold` or equivalent
- Responsive grid: 1 column mobile, 3 columns desktop (use Tailwind `grid grid-cols-1 lg:grid-cols-3`)

### Testing

[Source: architecture.md#Testing Strategy]

#### Component Tests

**Location:** `tests/component/dashboard/KPICard.test.tsx`

Test cases:

1. Renders KPI card with label and value
2. Formats currency values correctly ($1,234.56)
3. Displays zero values without error ("0", "$0.00")
4. Shows skeleton loading state
5. Applies correct dark theme styling

**Example:**

```typescript
describe('KPICard', () => {
  it('displays formatted revenue value', () => {
    render(<KPICard label="Total Revenue" value={1234.56} format="currency" />);
    expect(screen.getByText('$1,234.56')).toBeInTheDocument();
  });

  it('shows zero value when no data', () => {
    render(<KPICard label="Total Revenue" value={0} format="currency" />);
    expect(screen.getByText('$0.00')).toBeInTheDocument();
  });
});
```

#### Integration Tests

**Location:** `tests/component/dashboard/ManagerDashboard.test.tsx`

Test cases:

1. Fetches and displays all 3 KPI metrics
2. Shows loading skeletons while data fetching
3. Updates metrics when service log approved (mock Firestore update)
4. Handles error state gracefully

**Setup:**

- Mock Firestore queries for serviceLogs and users collections
- Mock React Query with test data

#### E2E Tests

**Location:** `tests/e2e/reports.spec.ts`

Test cases:

1. Manager logs in and sees dashboard with KPI cards
2. Create approved service log, verify revenue increments in <2s
3. Create barber profile, verify active barbers count increments
4. Verify real-time updates across multiple browser windows

**Test Flow:**

```typescript
test('Manager dashboard shows real-time KPI updates', async ({
  page,
  context,
}) => {
  // Login as manager
  await page.goto('/manager/dashboard')

  // Verify initial KPIs loaded
  await expect(page.getByText('Total Revenue')).toBeVisible()
  const initialRevenue = await page
    .locator('[data-testid="total-revenue-value"]')
    .textContent()

  // Open second browser to approve service log
  const page2 = await context.newPage()
  await page2.goto('/manager/approvals')
  await page2.click('[data-testid="approve-log-btn"]')

  // Verify revenue updated on first page within 2 seconds
  await expect(
    page.locator('[data-testid="total-revenue-value"]')
  ).not.toHaveText(initialRevenue, { timeout: 2000 })
})
```

#### Unit Tests

**Location:** `tests/unit/services/reporting-service.test.ts`

Test cases:

1. `getManagerKPIs()` returns correct aggregated values
2. Filters only approved service logs (excludes pending/rejected)
3. Calculates total revenue as sum of all approved log prices
4. Counts total services as number of approved logs
5. Counts active barbers where role='barber'
6. Handles empty collections (returns zeros)

**Mocking:**

- Mock Firestore `getDocs()` with test fixtures
- Verify correct queries executed (status='approved', role='barber')

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
