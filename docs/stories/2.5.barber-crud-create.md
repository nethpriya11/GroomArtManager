# Story 2.5: Barber CRUD - Create Barber Profile

## Status

Draft

## Story

**As a** manager,
**I want** to add a new barber to the team with their commission rate,
**so that** they can log in and log services with appropriate commission calculations.

## Acceptance Criteria

1. Manager Barbers page created at `/manager/barbers` with "Add Barber" button (primary amber button, top-right)
2. Clicking "Add Barber" opens modal dialog
3. Dialog form contains fields: Username (text input), Avatar URL (text input, optional), Commission Rate (number input with % suffix)
4. Form uses React Hook Form with Zod validation
5. Validation: Username required (non-empty), Avatar URL optional (valid URL if provided), Commission Rate required (0-100, positive number)
6. On submit: User document created in Firestore `users` collection with: username, avatarUrl (or null), commissionRate (stored as decimal, e.g., 45% → 0.45), role: 'barber', createdAt timestamp
7. Firebase Auth user created with email `[username]@salonflow.local` and temporary password "changeme123" (or similar)
8. Custom claim `role: 'barber'` set on Firebase Auth user
9. Toast notification: "Barber '[username]' added successfully"
10. Dialog closes, new barber appears in barber grid immediately

## Tasks / Subtasks

- [ ] Create Manager Barbers page route (AC: 1)
  - [ ] Create `/app/(auth)/manager/barbers/page.tsx`
  - [ ] Add page to manager navigation layout
  - [ ] Create "Add Barber" button (primary amber, top-right positioning)
- [ ] Implement Add Barber modal dialog (AC: 2, 3)
  - [ ] Create `BarberFormDialog.tsx` component in `components/features/barbers/`
  - [ ] Implement ShadCN Dialog component (max-width 600px, centered)
  - [ ] Add form fields: Username (text), Avatar URL (text, optional), Commission Rate (number, % suffix)
- [ ] Set up form validation (AC: 4, 5)
  - [ ] Create Zod schema in `lib/validations/schemas.ts`: `createBarberSchema`
  - [ ] Integrate React Hook Form with Zod resolver
  - [ ] Validation: Username required (non-empty), Avatar URL optional (valid URL), Commission Rate required (0-100)
  - [ ] Display inline validation errors (red text #ef4444 below fields)
- [ ] Implement Firestore user document creation (AC: 6)
  - [ ] Create `createBarber()` function in `lib/services/barber-management.ts`
  - [ ] Use repository pattern in `lib/firebase/repositories/barber-repository.ts`
  - [ ] Create user document in `users` collection with: username, avatarUrl, commissionRate (as decimal), role: 'barber', createdAt
  - [ ] Convert commission rate from percentage to decimal (45% → 0.45)
- [ ] Implement Firebase Auth user creation (AC: 7, 8)
  - [ ] Create API route: `/app/api/barbers/route.ts` (POST method)
  - [ ] Use Firebase Admin SDK to create auth user
  - [ ] Set email: `[username]@salonflow.local`
  - [ ] Set temporary password: "changeme123"
  - [ ] Set custom claim: `role: 'barber'`
  - [ ] Handle auth user creation errors
- [ ] Add user feedback (AC: 9, 10)
  - [ ] Show Sonner toast: "Barber '[username]' added successfully"
  - [ ] Auto-close dialog on successful submission
  - [ ] Ensure barber appears in grid immediately (real-time listener or optimistic update)

## Dev Notes

### Barber Data Model

[Source: architecture.md#Data Models - User Profile]

```typescript
interface UserProfile {
  id: string // Firebase Auth UID
  username: string
  role: 'manager' | 'barber'
  avatarUrl: string | null
  commissionRate: number // 0.0 - 1.0 (e.g., 0.45 for 45%)
  createdAt: Firestore.Timestamp
}
```

### Form Validation Schema

[Source: architecture.md#Coding Standards - Form Validation]

Create validation schema in `lib/validations/schemas.ts`:

```typescript
import { z } from 'zod'

export const createBarberSchema = z.object({
  username: z.string().min(1, 'Username is required'),
  avatarUrl: z.string().url('Must be a valid URL').optional().or(z.literal('')), // Allow empty string
  commissionRate: z
    .number()
    .min(0, 'Commission rate must be at least 0')
    .max(100, 'Commission rate must be between 0 and 100')
    .positive('Commission rate must be a positive number'),
})

export type CreateBarberInput = z.infer<typeof createBarberSchema>
```

### Commission Rate Conversion

[Source: architecture.md#Data Models - User Profile]

Convert percentage to decimal for storage:

```typescript
function convertCommissionToDecimal(percentage: number): number {
  return percentage / 100
}

// Usage: 45% → 0.45
const commissionDecimal = convertCommissionToDecimal(45) // 0.45
```

### Repository Pattern

[Source: architecture.md#Components - Repository Pattern]

Create barber repository in `lib/firebase/repositories/barber-repository.ts`:

```typescript
import { doc, setDoc, Timestamp } from 'firebase/firestore'
import { db } from '@/lib/firebase/config'
import type { UserProfile } from '@/types/firestore'

export async function createBarberProfile(
  uid: string,
  data: {
    username: string
    avatarUrl: string | null
    commissionRate: number // Already as decimal
  }
): Promise<UserProfile> {
  const userRef = doc(db, 'users', uid)
  const userData: UserProfile = {
    id: uid,
    username: data.username,
    avatarUrl: data.avatarUrl,
    commissionRate: data.commissionRate,
    role: 'barber',
    createdAt: Timestamp.now(),
  }

  await setDoc(userRef, userData)
  return userData
}
```

### API Route for Auth User Creation

[Source: architecture.md#API Specification]

Create server-side API route using Firebase Admin SDK:

```typescript
// app/api/barbers/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getAuth } from 'firebase-admin/auth'
import { adminApp } from '@/lib/firebase/admin'

export async function POST(request: NextRequest) {
  try {
    // Verify manager authentication
    const authHeader = request.headers.get('Authorization')
    if (!authHeader) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Verify token and check role
    const token = authHeader.replace('Bearer ', '')
    const decodedToken = await getAuth(adminApp).verifyIdToken(token)
    if (decodedToken.role !== 'manager') {
      return NextResponse.json(
        { error: 'Unauthorized - Manager access required' },
        { status: 401 }
      )
    }

    // Get barber data from request
    const { username, avatarUrl, commissionRate } = await request.json()

    // Create Firebase Auth user
    const auth = getAuth(adminApp)
    const userRecord = await auth.createUser({
      email: `${username}@salonflow.local`,
      password: 'changeme123',
      displayName: username,
    })

    // Set custom claim
    await auth.setCustomUserClaims(userRecord.uid, { role: 'barber' })

    return NextResponse.json({
      success: true,
      uid: userRecord.uid,
    })
  } catch (error) {
    console.error('Error creating barber:', error)
    return NextResponse.json(
      { error: 'Failed to create barber' },
      { status: 500 }
    )
  }
}
```

### Complete Barber Creation Flow

[Source: architecture.md#Components]

Coordinate Auth and Firestore creation:

```typescript
// lib/services/barber-management.ts
import { createBarberProfile } from '@/lib/firebase/repositories/barber-repository'

export async function createBarber(data: {
  username: string
  avatarUrl: string | null
  commissionRate: number // As percentage (e.g., 45)
}): Promise<UserProfile> {
  // 1. Create Firebase Auth user via API route
  const response = await fetch('/api/barbers', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${await getCurrentUserToken()}`,
    },
    body: JSON.stringify({
      username: data.username,
      avatarUrl: data.avatarUrl,
      commissionRate: data.commissionRate / 100, // Convert to decimal
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to create barber auth user')
  }

  const { uid } = await response.json()

  // 2. Create Firestore user profile
  const barber = await createBarberProfile(uid, {
    username: data.username,
    avatarUrl: data.avatarUrl || null,
    commissionRate: data.commissionRate / 100, // Convert to decimal
  })

  return barber
}
```

### React Query Mutation

[Source: architecture.md#Architectural Patterns - Optimistic UI Updates]

Implement create mutation:

```typescript
import { useMutation, useQueryClient } from '@tanstack/react-query'

const queryClient = useQueryClient()
const createBarberMutation = useMutation({
  mutationFn: createBarber,
  onSuccess: (newBarber) => {
    queryClient.invalidateQueries(['barbers'])
    toast.success(`Barber '${newBarber.username}' added successfully`)
  },
  onError: (error) => {
    console.error('Error creating barber:', error)
    toast.error('Failed to create barber. Please try again.')
  },
})
```

### Component Structure

[Source: architecture.md#Unified Project Structure]

File locations:

- Page: `app/(auth)/manager/barbers/page.tsx`
- Dialog component: `components/features/barbers/BarberFormDialog.tsx`
- API route: `app/api/barbers/route.ts`
- Service layer: `lib/services/barber-management.ts`
- Repository: `lib/firebase/repositories/barber-repository.ts`
- Validation: `lib/validations/schemas.ts`
- Types: `types/firestore.ts`

### Testing

#### Unit Tests

[Source: architecture.md#Testing Strategy]

**Validation Schema Test** (`tests/unit/validations/schemas.test.ts`):

- Test valid barber input passes validation
- Test empty username fails with "Username is required"
- Test invalid avatar URL fails with "Must be a valid URL"
- Test empty avatar URL passes (optional field)
- Test commission rate < 0 fails validation
- Test commission rate > 100 fails validation
- Test commission rate = 0 and 100 pass validation

**Repository Test** (`tests/unit/repositories/barber-repository.test.ts`):

- Mock Firestore `setDoc` function
- Test createBarberProfile creates user document with correct fields
- Test commissionRate stored as decimal
- Test role set to 'barber'
- Test createdAt timestamp added
- Test throws error on Firestore failure

**API Route Test** (`tests/unit/api/barbers/create-barber.test.ts`):

- Mock Firebase Admin Auth
- Test creates auth user with correct email format
- Test sets temporary password
- Test sets custom claim role: 'barber'
- Test returns 401 for non-manager users
- Test returns 401 for missing auth header
- Test handles auth creation errors

#### Component Tests

[Source: architecture.md#Testing Strategy]

**BarberFormDialog Test** (`tests/component/barbers/BarberForm.test.tsx`):

- Test form renders with all fields (username, avatarUrl, commissionRate)
- Test submit button disabled when form is invalid
- Test submit button enabled when form is valid
- Test validation errors display on blur/submit
- Test avatar URL field is optional
- Test commission rate accepts values 0-100
- Test commission rate shows % suffix
- Test successful submission calls mutation
- Test toast notification shows with barber username
- Test dialog closes after successful submission

#### E2E Tests

[Source: architecture.md#Testing Strategy]

**Barber Creation E2E** (`tests/e2e/barber-management.spec.ts`):

- Test manager navigates to /manager/barbers
- Test clicking "Add Barber" button opens modal
- Test entering valid data and submitting creates barber
- Test Firebase Auth user created with correct email
- Test Firestore user document created with correct fields
- Test commission rate stored as decimal in database
- Test toast notification appears with barber name
- Test new barber appears in grid immediately
- Test form validation prevents submission with invalid data
- Test barber can log in with temporary password

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
