# Story 4.2: Financial Reports Page - KPI Summary

## Status

Draft

## Story

**As a** manager,
**I want** a dedicated reports page with detailed financial summaries,
**so that** I can analyze profitability and commissions.

## Acceptance Criteria

1. Reports page created at `/manager/reports` route
2. Date range picker at top of page with presets: Today, Last 7 Days, Last 30 Days, Custom Range
3. Date picker uses a date range component (ShadCN DateRangePicker or similar)
4. Three KPI cards below date picker: Total Revenue, Total Commissions Payout, Net Profit
5. **Total Revenue:** Sum of service log prices (approved, within date range)
6. **Total Commissions Payout:** Sum of commissionAmount (approved, within date range)
7. **Net Profit:** Total Revenue - Total Commissions Payout
8. Date range filter applies to all sections on page (KPIs, leaderboards, ledger)
9. Default date range: Last 30 Days
10. Real-time updates: Metrics update when new services approved (if within selected date range)

## Tasks / Subtasks

- [ ] Create reports page route and layout (AC: 1)
  - [ ] Create `app/manager/reports/page.tsx`
  - [ ] Add navigation link to reports page from manager dashboard
  - [ ] Verify route protected with manager-only middleware
- [ ] Implement date range picker component (AC: 2, 3)
  - [ ] Install/configure ShadCN DateRangePicker component
  - [ ] Add preset buttons: Today, Last 7 Days, Last 30 Days, Custom Range
  - [ ] Position at top of reports page
  - [ ] Store selected date range in component state
  - [ ] Display selected range in readable format (MM/DD/YYYY - MM/DD/YYYY)
- [ ] Create date range management hook (AC: 8, 9)
  - [ ] Implement `useDateRange()` in `hooks/useDateRange.ts`
  - [ ] Default date range: Last 30 Days (today - 30 days to today)
  - [ ] Handle preset selection (Today, Last 7 Days, Last 30 Days, Custom)
  - [ ] Parse custom date range from calendar picker
  - [ ] Return startDate and endDate as Firestore Timestamps
- [ ] Create financial KPI aggregation functions (AC: 5, 6, 7)
  - [ ] Implement `getFinancialKPIs(dateRange)` in `lib/services/reporting-service.ts`
  - [ ] Query serviceLogs where status='approved' AND createdAt within date range
  - [ ] Calculate Total Revenue: sum of all log prices
  - [ ] Calculate Total Commissions: sum of all commissionAmount values
  - [ ] Calculate Net Profit: Total Revenue - Total Commissions
  - [ ] Return: `{ totalRevenue: number, totalCommissions: number, netProfit: number }`
- [ ] Create custom hook for real-time financial KPIs (AC: 10)
  - [ ] Implement `useFinancialKPIs(dateRange)` in `hooks/useFinancialKPIs.ts`
  - [ ] Wrap `getFinancialKPIs()` with React Query and onSnapshot listener
  - [ ] Re-query when date range changes
  - [ ] Handle real-time updates when new services approved within selected range
  - [ ] Configure staleTime: Infinity for real-time data
- [ ] Build financial KPI cards section (AC: 4)
  - [ ] Reuse `KPICard` component from Story 4.1
  - [ ] Create grid layout with 3 cards: Total Revenue, Total Commissions Payout, Net Profit
  - [ ] Position below date range picker
  - [ ] Pass financial KPI data to cards
  - [ ] Format currency values with `formatCurrency()` utility
- [ ] Integrate components into reports page (AC: 1, 8)
  - [ ] Add date range picker at top
  - [ ] Add financial KPI cards below picker
  - [ ] Pass selected date range to all child components
  - [ ] Ensure date filter applies to KPIs, leaderboards, and ledger sections
- [ ] Implement loading and empty states (AC: 9, 10)
  - [ ] Show skeleton loading while KPIs calculating
  - [ ] Display "$0.00" for all KPIs when no approved logs in date range
  - [ ] Handle date range with no data gracefully
- [ ] Test date range filtering (AC: 2, 8, 9)
  - [ ] Verify preset buttons update date range and KPIs correctly
  - [ ] Test custom date range selection
  - [ ] Verify default date range is Last 30 Days on initial load
  - [ ] Ensure date range persists when switching between sections
- [ ] Test real-time updates (AC: 10)
  - [ ] Approve service log within selected date range
  - [ ] Verify KPIs update within <2s
  - [ ] Approve service log outside date range, verify KPIs unchanged

## Dev Notes

### Reports Page Structure

[Source: architecture.md#Unified Project Structure]

Create page at `app/manager/reports/page.tsx` following Next.js App Router conventions:

```
app/
├── manager/
│   ├── dashboard/
│   ├── reports/              # New reports page
│   │   └── page.tsx
│   ├── barbers/
│   └── services/
```

### Date Range Filtering

[Source: epic-4-reporting-analytics.md#Story 4.6]

Date range filter requirements:

- Preset buttons: Today (00:00-23:59 today), Last 7 Days, Last 30 Days, Custom
- Selected range displayed: "MM/DD/YYYY - MM/DD/YYYY"
- Date range persists in URL query params (?from=2025-10-01&to=2025-10-31) for shareable links
- All queries filter by: `createdAt >= startDate AND createdAt <= endDate`

**Implementation Pattern:**

```typescript
export function useDateRange() {
  const [dateRange, setDateRange] = useState<DateRange>({
    from: subDays(new Date(), 30), // Default: Last 30 Days
    to: new Date(),
  })

  const handlePreset = (preset: 'today' | 'last7' | 'last30') => {
    const to = new Date()
    const from =
      preset === 'today' ? to : subDays(to, preset === 'last7' ? 7 : 30)
    setDateRange({ from, to })
  }

  return { dateRange, setDateRange, handlePreset }
}
```

### Financial KPI Calculations

[Source: architecture.md#Reporting & Analytics Service]

**getFinancialKPIs(dateRange) Implementation:**

```typescript
export async function getFinancialKPIs(
  dateRange: DateRange
): Promise<FinancialKPIs> {
  const db = getFirestore()

  // Query approved logs within date range
  const logsQuery = query(
    collection(db, 'serviceLogs'),
    where('status', '==', 'approved'),
    where('createdAt', '>=', Timestamp.fromDate(dateRange.from)),
    where('createdAt', '<=', Timestamp.fromDate(dateRange.to))
  )

  const snapshot = await getDocs(logsQuery)

  const totalRevenue = snapshot.docs.reduce(
    (sum, doc) => sum + doc.data().price,
    0
  )
  const totalCommissions = snapshot.docs.reduce(
    (sum, doc) => sum + doc.data().commissionAmount,
    0
  )
  const netProfit = totalRevenue - totalCommissions

  return { totalRevenue, totalCommissions, netProfit }
}
```

### Firestore Composite Index Required

[Source: architecture.md#Database Schema]

Date-filtered approved logs require composite index:

```json
{
  "collectionGroup": "serviceLogs",
  "fields": [
    { "fieldPath": "status", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "DESCENDING" }
  ]
}
```

### Data Models

[Source: architecture.md#Data Models]

**ServiceLog:**

- `price`: number - Used for total revenue calculation
- `commissionAmount`: number - Calculated commission (price × commissionRate)
- `status`: 'pending' | 'approved' | 'rejected' - Filter by 'approved'
- `createdAt`: Firestore Timestamp - Used for date range filtering

### Component Reusability

Reuse `KPICard` component from Story 4.1 for consistency:

- Same styling (#1a1a1a background, #f59e0b accents)
- Same formatting (currency, large bold font)
- Same loading skeleton pattern

### Real-time Updates

[Source: architecture.md#Real-time Sync Engine]

Use onSnapshot listener to detect new approved logs within date range:

```typescript
export function useFinancialKPIs(dateRange: DateRange) {
  return useQuery({
    queryKey: ['financial-kpis', dateRange.from, dateRange.to],
    queryFn: () =>
      new Promise((resolve) => {
        const logsQuery = query(
          collection(db, 'serviceLogs'),
          where('status', '==', 'approved'),
          where('createdAt', '>=', Timestamp.fromDate(dateRange.from)),
          where('createdAt', '<=', Timestamp.fromDate(dateRange.to))
        )

        const unsubscribe = onSnapshot(logsQuery, (snapshot) => {
          // Recalculate KPIs on each update
          const kpis = calculateKPIsFromSnapshot(snapshot)
          resolve(kpis)
        })

        return () => unsubscribe()
      }),
    staleTime: Infinity,
  })
}
```

### Testing

[Source: architecture.md#Testing Strategy]

#### Component Tests

**Location:** `tests/component/reports/FinancialReportsPage.test.tsx`

Test cases:

1. Renders date range picker at top of page
2. Renders 3 financial KPI cards below picker
3. Displays default date range (Last 30 Days) on initial load
4. Updates KPIs when date range preset selected
5. Shows loading skeletons while calculating KPIs
6. Displays zero values when no data in date range

**Example:**

```typescript
describe('FinancialReportsPage', () => {
  it('updates KPIs when preset selected', async () => {
    render(<FinancialReportsPage />);

    // Initial state: Last 30 Days
    expect(screen.getByText('Last 30 Days')).toBeInTheDocument();

    // Click "Today" preset
    await userEvent.click(screen.getByText('Today'));

    // Verify KPIs recalculated for today only
    await waitFor(() => {
      expect(mockGetFinancialKPIs).toHaveBeenCalledWith(
        expect.objectContaining({ preset: 'today' })
      );
    });
  });
});
```

#### Integration Tests

**Location:** `tests/component/reports/DateRangePicker.test.tsx`

Test cases:

1. Preset buttons change date range correctly
2. Custom date range picker opens calendar overlay
3. Selected range displays in readable format
4. Date range propagates to child components

#### E2E Tests

**Location:** `tests/e2e/reports.spec.ts`

Test cases:

1. Manager navigates to /manager/reports page
2. Verify default date range is Last 30 Days
3. Select "Today" preset, verify KPIs update
4. Select custom date range, verify correct data shown
5. Approve service log, verify KPIs increment in real-time (within 2s)
6. Approve service log outside date range, verify KPIs unchanged

**Test Flow:**

```typescript
test('Date range filter applies to financial KPIs', async ({ page }) => {
  await page.goto('/manager/reports')

  // Verify default: Last 30 Days
  await expect(
    page.locator('[data-testid="date-range-display"]')
  ).toContainText('Last 30 Days')

  // Click "Today" preset
  await page.click('[data-testid="preset-today"]')

  // Verify KPIs updated for today only
  await expect(page.locator('[data-testid="total-revenue"]')).toBeVisible()

  // Record today's revenue
  const todayRevenue = await page
    .locator('[data-testid="total-revenue-value"]')
    .textContent()

  // Change to "Last 7 Days"
  await page.click('[data-testid="preset-last7"]')

  // Verify revenue changed (different date range)
  await expect(
    page.locator('[data-testid="total-revenue-value"]')
  ).not.toHaveText(todayRevenue)
})
```

#### Unit Tests

**Location:** `tests/unit/services/reporting-service.test.ts`

Test cases:

1. `getFinancialKPIs()` calculates total revenue correctly
2. `getFinancialKPIs()` calculates total commissions correctly
3. `getFinancialKPIs()` calculates net profit (revenue - commissions)
4. Filters only approved logs within date range
5. Excludes pending/rejected logs
6. Excludes logs outside date range
7. Returns zero values when no logs in range

**Example:**

```typescript
describe('getFinancialKPIs', () => {
  it('calculates KPIs for date range', async () => {
    // Mock Firestore with 3 approved logs in range
    mockGetDocs.mockResolvedValue({
      docs: [
        { data: () => ({ price: 100, commissionAmount: 45 }) },
        { data: () => ({ price: 50, commissionAmount: 22.5 }) },
        { data: () => ({ price: 75, commissionAmount: 33.75 }) },
      ],
    })

    const dateRange = { from: subDays(new Date(), 7), to: new Date() }
    const kpis = await getFinancialKPIs(dateRange)

    expect(kpis.totalRevenue).toBe(225) // 100 + 50 + 75
    expect(kpis.totalCommissions).toBe(101.25) // 45 + 22.5 + 33.75
    expect(kpis.netProfit).toBe(123.75) // 225 - 101.25
  })
})
```

#### Hook Tests

**Location:** `tests/unit/hooks/useDateRange.test.ts`

Test cases:

1. Default date range is Last 30 Days
2. `handlePreset('today')` sets date range to today
3. `handlePreset('last7')` sets date range to last 7 days
4. `handlePreset('last30')` sets date range to last 30 days
5. Custom date range can be set via `setDateRange()`

## Change Log

| Date       | Version | Description            | Author          |
| ---------- | ------- | ---------------------- | --------------- |
| 2025-10-10 | v1.0    | Initial story creation | PM Agent (John) |

## Dev Agent Record

### Agent Model Used

{To be populated by dev agent}

### Debug Log References

{To be populated by dev agent}

### Completion Notes List

{To be populated by dev agent}

### File List

{To be populated by dev agent}

## QA Results

{To be populated by QA agent}
